<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Dependency-Check</title>
      <link href="/2023/11/26/Java/Dependency-Check/"/>
      <url>/2023/11/26/Java/Dependency-Check/</url>
      
        <content type="html"><![CDATA[<h3 id="Dependency-Check"><a href="#Dependency-Check" class="headerlink" title="Dependency-Check"></a>Dependency-Check</h3><h4 id="官方介绍"><a href="#官方介绍" class="headerlink" title="官方介绍"></a>官方介绍</h4><p>OWASP dependency-check是OWASP Top 10 2021条目A06:2021——“易受攻击和过时的组件”的开源解决方案。Dependency-check目前可用于扫描软件，以识别已知脆弱组件的使用。有关支持的语言/技术的完整列表，请参阅文件类型分析器页面。请注意，其中一些分析器是实验性的，可能会产生更多的假阳性和假阴性。要使用实验性分析器，必须通过适当的实验性配置明确启用它们。</p><p>使用已知脆弱组件的问题在Jeff Williams和Arshan Dabirsiaghi的一篇题为“不安全库的不幸现实”的论文中有所涉及（需要注册）。该论文的要点是，作为开发社区的一部分，我们在应用程序中包含了包含已知发布漏洞的第三方库（例如国家漏洞数据库中的漏洞）。</p><h4 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h4><ul><li>Dependency-Check的集成方式有多种，例如：命令行，maven，ant，gradle等。</li><li>这里为了不修改代码的前提下，进行检测，所以采用命令行的方式进行集成</li></ul><h4 id="命令行集成"><a href="#命令行集成" class="headerlink" title="命令行集成"></a>命令行集成</h4><h5 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h5><p>这里采用二进制的方式从github上下载最新的<a href="https://github.com/jeremylong/DependencyCheck/releases/">Release</a>版本。其它详见：<a href="https://jeremylong.github.io/DependencyCheck/dependency-check-cli/index.html">官方文档</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载文件</span></span><br><span class="line">wget https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.0/dependency-check-9.0.0-release.zip -O dependency-check.zip</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压文件</span></span><br><span class="line">unzip dependency-check.zip</span><br></pre></td></tr></table></figure><h5 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h5><h6 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h6><ol><li><p>Dependency-Check 的检查依赖于<a href="https://nvd.nist.gov/">美国国家漏洞数据库</a>。所以在使用前可以去申请一个API密钥，以便可以更快的下载数据。</p></li><li><p>将Dependency-Check 的数据存储到数据库中，这里采用postgresql进行存储，在使用前还需要下载一个postgresql jdbc的依赖。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://jdbc.postgresql.org/download/postgresql-42.7.0.jar -O ./lib/postgresql-42.7.0.jar</span><br></pre></td></tr></table></figure></li><li><p>在数据库中创建一个库以便后续连接使用。</p></li><li><p>在连接时，不建议使用密码在命令行中使用，所以先写入一个文件后续使用。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;data.password=xxx&#x27; &gt; pwd.properties</span><br></pre></td></tr></table></figure></li><li><p>下载dotnet，dependency-check必备的依赖<a href="https://dotnet.microsoft.com/zh-cn/download/dotnet/6.0">下载 .NET 6.0 (Linux、macOS 和 Windows) (microsoft.com)</a>这里必须下载6.0</p></li><li><p>下载JDK</p></li></ol><h6 id="扫描"><a href="#扫描" class="headerlink" title="扫描"></a>扫描</h6><p>在工作准备完成后，对代码进行扫描，他可以扫描jar文件，也可以扫描项目根目录（需要先mvn install）</p><p>示例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bin/dependency-check.sh \</span><br><span class="line">--format HTML \</span><br><span class="line">--dbDriverName org.postgresql.Driver \</span><br><span class="line">--connectionString jdbc:postgresql://ip:port/database \</span><br><span class="line">--dbUser username \</span><br><span class="line">--nvdApiKey apiKey \</span><br><span class="line">--scan path \</span><br><span class="line">--propertyfile pwd.properties \</span><br><span class="line">--out report </span><br></pre></td></tr></table></figure><p>参数说明详见：<a href="https://jeremylong.github.io/DependencyCheck/dependency-check-cli/arguments.html">dependency-check-cli – Command Line Arguments</a></p><p>在执行时，首先需要拉取数据，视网络情况而定。</p><p>等检测完成后会在report目录下有一个html文件，打开即可看到检测数据</p><h4 id="Jenkins集成"><a href="#Jenkins集成" class="headerlink" title="Jenkins集成"></a>Jenkins集成</h4><ul><li>由于项目打包时，使用的是jenkins的流水线，无法直接采用jenkins的插件，对项目进行扫描。</li><li>所以还是一样采用命令行的方式，对项目进行扫描-&gt; 生成html文件-&gt; 集成sonar</li></ul><h5 id="构建docker镜像"><a href="#构建docker镜像" class="headerlink" title="构建docker镜像"></a>构建docker镜像</h5><h6 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h6><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:<span class="number">11.6</span>-slim as jre</span><br><span class="line"><span class="keyword">ENV</span> ARM_DOWNLOAD_URL=https://download.java.net/java/GA/jdk17/<span class="number">0</span>d483333a00540d886896bac774ff48b/<span class="number">35</span>/GPL/openjdk-<span class="number">17</span>_linux-aarch64_bin.tar.gz</span><br><span class="line"><span class="keyword">ENV</span> AMD_DOWNLOAD_URL=https://download.java.net/java/GA/jdk17/<span class="number">0</span>d483333a00540d886896bac774ff48b/<span class="number">35</span>/GPL/openjdk-<span class="number">17</span>_linux-x64_bin.tar.gz</span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=/usr/local/jdk</span><br><span class="line"><span class="keyword">ENV</span> PATH=$&#123;JAVA_HOME&#125;/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> \</span></span><br><span class="line"><span class="language-bash">    <span class="comment"># 软件源配置</span></span></span><br><span class="line">    sed -i <span class="string">&#x27;s#deb.debian.org#mirrors.tuna.tsinghua.edu.cn#g&#x27;</span> /etc/apt/sources.list; \</span><br><span class="line">    apt update &amp;&amp; apt install  -y --no-install-recommends  binutils curl wget vim fontconfig libfreetype6 ca-certificates p11-kit; apt-get clean; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*;\</span><br><span class="line">    <span class="comment"># 下载jdk</span></span><br><span class="line">    /bin/sh -c set -eux; arch=<span class="string">&quot;$(dpkg --print-architecture)&quot;</span>; case <span class="string">&quot;$arch&quot;</span> in <span class="string">&#x27;amd64&#x27;</span>) downloadUrl=<span class="string">&quot;$&#123;AMD_DOWNLOAD_URL&#125;&quot;</span>; ;; <span class="string">&#x27;arm64&#x27;</span>) downloadUrl=<span class="string">&quot;$&#123;ARM_DOWNLOAD_URL&#125;&quot;</span>; ;; *) echo &gt;&amp;<span class="number">2</span> <span class="string">&quot;error: unsupported architecture: &#x27;$arch&#x27;&quot;</span>; exit <span class="number">1</span> ;; esac; wget --progress=dot:giga -O openjdk.tgz <span class="string">&quot;$downloadUrl&quot;</span>; mkdir -p <span class="string">&quot;$JAVA_HOME&quot;</span>; tar --extract --file openjdk.tgz --directory <span class="string">&quot;$JAVA_HOME&quot;</span> --strip-components <span class="number">1</span> --no-same-owner ; rm openjdk.tgz*; \</span><br><span class="line">    <span class="comment"># 构建jre</span></span><br><span class="line">    jlink --output /usr/local/jre --<span class="keyword">add</span><span class="language-bash">-modules ALL-MODULE-PATH --compress 2 --strip-debug --no-header-files --no-man-pages;</span></span><br><span class="line"><span class="keyword">FROM</span> debian:<span class="number">11.6</span>-slim</span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="keyword">ENV</span> ARM_DOWNLOAD_URL=https://download.visualstudio.microsoft.com/download/pr/<span class="number">03972</span>b46-ddcd-<span class="number">4529</span>-b8e0-df5c1264cd98/<span class="number">285</span>a1f545020e3ddc47d15cf95ca7a33/dotnet-sdk-<span class="number">6.0</span>.<span class="number">417</span>-linux-arm64.tar.gz</span><br><span class="line"><span class="keyword">ENV</span> AMD_DOWNLOAD_URL=https://download.visualstudio.microsoft.com/download/pr/<span class="number">1</span>cac4d08-<span class="number">3025</span>-<span class="number">4</span>c00-<span class="number">972</span>d-<span class="number">5</span>c7ea446d1d7/a83bc5cbedf8b90495802ccfedaeb2e6/dotnet-sdk-<span class="number">6.0</span>.<span class="number">417</span>-linux-x64.tar.gz</span><br><span class="line"><span class="keyword">ENV</span> DOTNET_HOME=/usr/local/dotnet</span><br><span class="line"><span class="keyword">ENV</span> DENPENDENCY_HOME=/home/data/dependency-check</span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=/usr/local/jre</span><br><span class="line"><span class="keyword">ENV</span> MAVNEN_DOWNLOAD_URL=https://dlcdn.apache.org/maven/maven-<span class="number">3</span>/<span class="number">3.9</span>.<span class="number">4</span>/binaries/apache-maven-<span class="number">3.9</span>.<span class="number">4</span>-bin.tar.gz</span><br><span class="line"><span class="keyword">ENV</span> MAVEN_HOME=/usr/local/maven</span><br><span class="line"><span class="keyword">ENV</span> PATH=$&#123;MAVEN_HOME&#125;/bin:$&#123;JAVA_HOME&#125;/bin:$&#123;DENPENDENCY_HOME&#125;/bin:$&#123;DOTNET_HOME&#125;:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=jre /usr/local/jre /usr/local/jre</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /home/data</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> dependency-check dependency-check</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> \</span></span><br><span class="line"><span class="language-bash">    <span class="comment"># 软件源配置</span></span></span><br><span class="line">    sed -i <span class="string">&#x27;s#deb.debian.org#mirrors.tuna.tsinghua.edu.cn#g&#x27;</span> /etc/apt/sources.list; \</span><br><span class="line">    apt update &amp;&amp; apt install  -y --no-install-recommends  binutils curl wget vim fontconfig libfreetype6 ca-certificates p11-kit; apt-get clean; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*;\</span><br><span class="line">    <span class="comment"># 下载dotnet</span></span><br><span class="line">    /bin/sh -c set -eux; arch=<span class="string">&quot;$(dpkg --print-architecture)&quot;</span>; case <span class="string">&quot;$arch&quot;</span> in <span class="string">&#x27;amd64&#x27;</span>) downloadUrl=<span class="string">&quot;$&#123;AMD_DOWNLOAD_URL&#125;&quot;</span>; ;; <span class="string">&#x27;arm64&#x27;</span>) downloadUrl=<span class="string">&quot;$&#123;ARM_DOWNLOAD_URL&#125;&quot;</span>; ;; *) echo &gt;&amp;<span class="number">2</span> <span class="string">&quot;error: unsupported architecture: &#x27;$arch&#x27;&quot;</span>; exit <span class="number">1</span> ;; esac; wget --progress=dot:giga -O dotnet.tar.gz <span class="string">&quot;$downloadUrl&quot;</span>; mkdir -p <span class="string">&quot;$DOTNET_HOME&quot;</span>; tar -zxvf  dotnet.tar.gz --directory <span class="string">&quot;$DOTNET_HOME&quot;</span>; rm -rf dotnet.tar.gz; \</span><br><span class="line">   wget -O maven.tar.gz <span class="string">&quot;$MAVNEN_DOWNLOAD_URL&quot;</span> ;mkdir -p <span class="string">&quot;$MAVEN_HOME&quot;</span>; tar --extract --file maven.tar.gz --directory <span class="string">&quot;$MAVEN_HOME&quot;</span> --strip-components <span class="number">1</span> --no-same-owner ; rm maven.tar.gz*; \</span><br><span class="line">   mkdir -p /home/workspace/scan;mkdir -p /home/workspace/report;</span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;dependency-check.sh  --dbDriverName org.postgresql.Driver --scan /home/workspace/scan/ --out /home/workspace/report/ --format HTML <span class="variable">$0</span> <span class="variable">$@</span>&quot;</span>]</span></span><br></pre></td></tr></table></figure><h6 id="build镜像"><a href="#build镜像" class="headerlink" title="build镜像"></a>build镜像</h6><ul><li>复制dependency-check和Docker到同一目录下</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t tag .</span><br></pre></td></tr></table></figure><h6 id="运行镜像"><a href="#运行镜像" class="headerlink" title="运行镜像"></a>运行镜像</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -it \</span><br><span class="line">--name dependency-check \</span><br><span class="line">--rm \</span><br><span class="line">-v /tmp/report:/home/workspace/report \</span><br><span class="line">-v /tmp/scan:/home/workspace/scan  \</span><br><span class="line">tag \</span><br><span class="line">--connectionString jdbc:postgresql://ip:port/database \</span><br><span class="line">--dbUser username  \</span><br><span class="line">--dbPassword password \</span><br><span class="line">--nvdApiKey apiKey</span><br></pre></td></tr></table></figure><p>参数说明：</p><p>-v 这里挂载两个路径，一个扫描路径，一个报告路径。</p><p>在tag后，则是相应的denpency-check所需要的参数</p><ul><li>验证镜像是否正常，查看挂载的目录是否正常输入html</li></ul><h5 id="集成进jenkins"><a href="#集成进jenkins" class="headerlink" title="集成进jenkins"></a>集成进jenkins</h5><h6 id="前置准备-1"><a href="#前置准备-1" class="headerlink" title="前置准备"></a>前置准备</h6><ul><li>下载sonar中的插件<a href="https://github.com/dependency-check/dependency-check-sonar-plugin/releases/download/4.0.0/sonar-dependency-check-plugin-4.0.0.jar">dependency-check-sonar-plugin</a></li></ul><h6 id="集成"><a href="#集成" class="headerlink" title="集成"></a>集成</h6><ul><li>在代码检测部分，配置depency-ckeck检测，在检测后在sonar中进行展示</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">stage(&#x27;代码检测&#x27;) &#123;</span><br><span class="line">      if(&quot;$&#123;codeScan&#125;&quot; == &#x27;true&#x27;)&#123;</span><br><span class="line">    container(&#x27;dependency-check&#x27;) &#123;</span><br><span class="line">        echo &quot;扫描漏洞&quot;</span><br><span class="line">        configFileProvider([</span><br><span class="line">                            configFile(fileId: &#x27;default-maven-settings&#x27;, variable: &#x27;mavenSettingsPath&#x27;)</span><br><span class="line">                        ]) &#123;</span><br><span class="line">        # 配置扫描</span><br><span class="line">        sh &quot;&quot;&quot;</span><br><span class="line">            mvn clean install -Dmaven.test.skip=true -U --settings $mavenSettingsPath</span><br><span class="line">            dependency-check.sh \</span><br><span class="line">            --format HTML \</span><br><span class="line">            --dbDriverName org.postgresql.Driver \</span><br><span class="line">            --connectionString jdbc:postgresql://ip:port/database \</span><br><span class="line">            --dbUser dcuser  \</span><br><span class="line">            --scan . \</span><br><span class="line">            --propertyfile  /tmp/data/pwd.properties \</span><br><span class="line">            --out ./$&#123;JOB_NAME&#125;.html</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">      container(&#x27;maven-11&#x27;) &#123;</span><br><span class="line">                withSonarQubeEnv() &#123;</span><br><span class="line">                    configFileProvider([</span><br><span class="line">                            configFile(fileId: &#x27;default-maven-settings&#x27;, variable: &#x27;mavenSettingsPath&#x27;)</span><br><span class="line">                        ]) &#123;</span><br><span class="line">                        sh &quot;&quot;&quot;</span><br><span class="line">                            mvn clean install \</span><br><span class="line">                            -Dmaven.test.skip=true \</span><br><span class="line">                            -U   \</span><br><span class="line">                            sonar:sonar \</span><br><span class="line">                            -Dsonar.projectKey=$sonarProjectKey \</span><br><span class="line">                            -Dsonar.dependencyCheck.htmlReportPath=./$&#123;JOB_NAME&#125;.html \</span><br><span class="line">                            -Dsonar.dependencyCheck.summarize=true \</span><br><span class="line">                            -Dsonar.dependencyCheck.securityHotspot=true \</span><br><span class="line">                            -Dsonar.branch.name=$branch \</span><br><span class="line">                            --settings $mavenSettingsPath \</span><br><span class="line">                        &quot;&quot;&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h6 id="Sonar展示"><a href="#Sonar展示" class="headerlink" title="Sonar展示"></a>Sonar展示</h6><p><img src="https://img.fuhouyu.com/WX20231126-221954%402x.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Saml 协议</title>
      <link href="/2023/09/17/Java/Saml%E5%8D%8F%E8%AE%AE/"/>
      <url>/2023/09/17/Java/Saml%E5%8D%8F%E8%AE%AE/</url>
      
        <content type="html"><![CDATA[<h3 id="Saml-协议"><a href="#Saml-协议" class="headerlink" title="Saml 协议"></a>Saml 协议</h3><h5 id="Saml-简介"><a href="#Saml-简介" class="headerlink" title="Saml 简介"></a>Saml 简介</h5><p>SAML安全断言标记语言（Security Assertion Markup Language），是一种用于在不同的身份验证和授权系统之间交换身份验证和授权信息的开放标准协议。它通常用于实现单点登录（Single Sign-On，简称SSO）和身份提供者（Identity Provider，简称IdP）与服务提供者（Service Provider，简称SP）之间的身份验证和授权流程。</p><h5 id="Saml-中的概念"><a href="#Saml-中的概念" class="headerlink" title="Saml 中的概念"></a>Saml 中的概念</h5><h6 id="身份提供者（Identity-Provider，IdP）"><a href="#身份提供者（Identity-Provider，IdP）" class="headerlink" title="身份提供者（Identity Provider，IdP）"></a><strong>身份提供者（Identity Provider，IdP）</strong></h6><p>负责验证用户身份并生成SAML断言的系统，idp通常是认证中心，对应oauth2协议中的认证服务器。</p><h6 id="服务提供者（Service-Provider，SP）"><a href="#服务提供者（Service-Provider，SP）" class="headerlink" title="服务提供者（Service Provider，SP）"></a><strong>服务提供者（Service Provider，SP）</strong></h6><p>用户要进行访问的应用程序或服务，需要验证用户身份和授权用户访问。SP接受来自Idp的SAML断言以验证用户身份。相当于oauth2协议中的资源服务器。</p><h6 id="SAML断言"><a href="#SAML断言" class="headerlink" title="SAML断言"></a><strong>SAML断言</strong></h6><p>SMAL断言是包含有关用户身份和授权信息的XML文档。它由idp生成，并用在用户登录时发送给sp。如用户名/邮件/用户的权限等信息。</p><h6 id="SAMLRequest-请求"><a href="#SAMLRequest-请求" class="headerlink" title="SAMLRequest 请求"></a><strong>SAMLRequest 请求</strong></h6><p>SAMLRequest由sp服务生成，向idp服务发起验证</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">samlp:AuthnRequest</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:samlp</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:saml</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">ID</span>=<span class="string">&quot;ONELOGIN_6e2eaf06-80e0-4e29-bca7-37e3771a6361&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">Version</span>=<span class="string">&quot;2.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">IssueInstant</span>=<span class="string">&quot;2023-09-17T08:31:19Z&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Destination</span>=<span class="string">&quot;http://localhost:29090/api/v1/saml/sso&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">ProtocolBinding</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST&quot;</span>      <span class="attr">AssertionConsumerServiceURL</span>=<span class="string">&quot;http://127.0.0.1:39000/oauth2/callback/saml&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">saml:Issuer</span>&gt;</span>sonarqube<span class="tag">&lt;/<span class="name">saml:Issuer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">samlp:NameIDPolicy</span> <span class="attr">Format</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified&quot;</span> <span class="attr">AllowCreate</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">samlp:AuthnRequest</span>&gt;</span></span><br></pre></td></tr></table></figure><ol><li><code>&lt;samlp:AuthnRequest&gt;</code> 元素：这是SAML身份验证请求的根元素，包含了整个请求的内容。<ul><li><code>xmlns:samlp=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;</code> 和 <code>xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;</code>：这些是XML命名空间声明，分别指定了SAML 2.0协议和SAML 2.0断言的命名空间。</li><li><code>ID</code> 属性：标识此SAML身份验证请求的唯一ID，用于将请求与响应相关联。</li><li><code>Version</code> 属性：指定了使用的SAML版本（在这种情况下，是2.0版本）。</li><li><code>IssueInstant</code> 属性：指定了身份验证请求的生成时间。</li><li><code>Destination</code> 属性：指定了将该请求发送到哪个URL，这是IdP的身份验证终端。</li><li><code>ProtocolBinding</code> 属性：指定了SAML请求和响应的协议绑定方式，这里是HTTP-POST，表示请求将通过HTTP POST方法发送。</li><li><code>AssertionConsumerServiceURL</code> 属性：指定了服务提供者（SP）接受SAML响应的地址，一旦用户成功身份验证，IdP将响应发送到这个URL。</li></ul></li><li><code>&lt;saml:Issuer&gt;</code> 元素：指定了发出身份验证请求的实体（通常是SP或应用程序的标识）。在这个示例中，Issuer是 “sonarqube”。</li><li><code>&lt;samlp:NameIDPolicy&gt;</code> 元素：指定了有关NameID（用户标识）的政策。<ul><li><code>Format</code> 属性：指定了NameID的格式。在这里，使用的是 “urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified”，表示NameID的格式未指定。</li><li><code>AllowCreate</code> 属性：指示是否允许IdP创建新的NameID。如果设置为 “true”，则允许创建，如果设置为 “false”，则不允许。</li></ul></li></ol><h6 id="SAMLResponse-响应"><a href="#SAMLResponse-响应" class="headerlink" title="SAMLResponse 响应"></a><strong>SAMLResponse 响应</strong></h6><p>SAMLResponse由idp服务生成，当idp解析完SAMLRequest后，会生成SAMLResponse返回，交给SP服务</p><p>示例：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">saml2p:Response</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:saml2p</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;</span> <span class="attr">Destination</span>=<span class="string">&quot;http://127.0.0.1:39000/oauth2/callback/saml&quot;</span> <span class="attr">ID</span>=<span class="string">&quot;_79841842-5f57-43bc-948d-729f9779a9cc&quot;</span> <span class="attr">InResponseTo</span>=<span class="string">&quot;ONELOGIN_106d8ee8-780a-437e-9d4e-27700481ab68&quot;</span> <span class="attr">IssueInstant</span>=<span class="string">&quot;2023-09-17T08:44:11.580Z&quot;</span> <span class="attr">Version</span>=<span class="string">&quot;2.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">saml2:Issuer</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:saml2</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;</span> <span class="attr">Format</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:nameid-format:entity&quot;</span>&gt;</span>base-platform</span><br><span class="line">    <span class="tag">&lt;/<span class="name">saml2:Issuer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ds:Signature</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:ds</span>=<span class="string">&quot;http://www.w3.org/2000/09/xmldsig#&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ds:SignedInfo</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ds:CanonicalizationMethod</span> <span class="attr">Algorithm</span>=<span class="string">&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ds:SignatureMethod</span> <span class="attr">Algorithm</span>=<span class="string">&quot;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ds:Reference</span> <span class="attr">URI</span>=<span class="string">&quot;#_79841842-5f57-43bc-948d-729f9779a9cc&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ds:Transforms</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">ds:Transform</span> <span class="attr">Algorithm</span>=<span class="string">&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">ds:Transform</span> <span class="attr">Algorithm</span>=<span class="string">&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ds:Transforms</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ds:DigestMethod</span> <span class="attr">Algorithm</span>=<span class="string">&quot;http://www.w3.org/2001/04/xmlenc#sha256&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ds:DigestValue</span>&gt;</span>O4PZi18UG4aFjRoetP/25Q4uykZ5wrGRVuQ5ev/9NWE=<span class="tag">&lt;/<span class="name">ds:DigestValue</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ds:Reference</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ds:SignedInfo</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ds:SignatureValue</span>&gt;</span></span><br><span class="line">签名数据</span><br><span class="line"><span class="tag">&lt;/<span class="name">ds:SignatureValue</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ds:KeyInfo</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ds:X509Data</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ds:X509Certificate</span>&gt;</span>base64加密的x509的证书<span class="tag">&lt;/<span class="name">ds:X509Certificate</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ds:X509Data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ds:KeyInfo</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ds:Signature</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">saml2p:Status</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">saml2p:StatusCode</span> <span class="attr">Value</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">saml2p:Status</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">saml2:Assertion</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:saml2</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;</span> <span class="attr">ID</span>=<span class="string">&quot;_44242b56-8e97-492f-a17c-30b44719cc21&quot;</span> <span class="attr">IssueInstant</span>=<span class="string">&quot;2023-09-17T08:44:11.580Z&quot;</span> <span class="attr">Version</span>=<span class="string">&quot;2.0&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">saml2:Issuer</span> <span class="attr">Format</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:nameid-format:entity&quot;</span>&gt;</span>base-platform<span class="tag">&lt;/<span class="name">saml2:Issuer</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">saml2:Subject</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">saml2:NameID</span>&gt;</span>uc_1d9ae45f305449adb27ba1de9a87fa6e<span class="tag">&lt;/<span class="name">saml2:NameID</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">saml2:SubjectConfirmation</span> <span class="attr">Method</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:cm:bearer&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">saml2:SubjectConfirmationData</span> <span class="attr">InResponseTo</span>=<span class="string">&quot;ONELOGIN_106d8ee8-780a-437e-9d4e-27700481ab68&quot;</span> <span class="attr">NotOnOrAfter</span>=<span class="string">&quot;2023-09-17T08:47:11.580Z&quot;</span> <span class="attr">Recipient</span>=<span class="string">&quot;http://127.0.0.1:39000/oauth2/callback/saml&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">saml2:SubjectConfirmation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">saml2:Subject</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">saml2:Conditions</span> <span class="attr">NotBefore</span>=<span class="string">&quot;2023-09-17T08:44:11.580Z&quot;</span> <span class="attr">NotOnOrAfter</span>=<span class="string">&quot;2023-09-17T08:47:11.580Z&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">saml2:AudienceRestriction</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">saml2:Audience</span>&gt;</span>sonarqube<span class="tag">&lt;/<span class="name">saml2:Audience</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">saml2:AudienceRestriction</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">saml2:Conditions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">saml2:AuthnStatement</span> <span class="attr">AuthnInstant</span>=<span class="string">&quot;2023-09-17T08:44:11.580Z&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">saml2:AuthnContext</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">saml2:AuthnContextClassRef</span>&gt;</span>urn:oasis:names:tc:SAML:2.0:ac:classes:Password<span class="tag">&lt;/<span class="name">saml2:AuthnContextClassRef</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">saml2:AuthenticatingAuthority</span>&gt;</span>base-platform<span class="tag">&lt;/<span class="name">saml2:AuthenticatingAuthority</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">saml2:AuthnContext</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">saml2:AuthnStatement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">saml2:AttributeStatement</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">saml2:Attribute</span> <span class="attr">Name</span>=<span class="string">&quot;realName&quot;</span> <span class="attr">NameFormat</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:uri&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">saml2:AttributeValue</span>&gt;</span>realName<span class="tag">&lt;/<span class="name">saml2:AttributeValue</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">saml2:Attribute</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">saml2:Attribute</span> <span class="attr">Name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">NameFormat</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:uri&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">saml2:AttributeValue</span>&gt;</span>123<span class="tag">&lt;/<span class="name">saml2:AttributeValue</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">saml2:Attribute</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">saml2:Attribute</span> <span class="attr">Name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">NameFormat</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:uri&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">saml2:AttributeValue</span>&gt;</span>username<span class="tag">&lt;/<span class="name">saml2:AttributeValue</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">saml2:Attribute</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">saml2:Attribute</span> <span class="attr">Name</span>=<span class="string">&quot;group&quot;</span> <span class="attr">NameFormat</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:uri&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">saml2:AttributeValue</span>&gt;</span>group<span class="tag">&lt;/<span class="name">saml2:AttributeValue</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">saml2:Attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">saml2:AttributeStatement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">saml2:Assertion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">saml2p:Response</span>&gt;</span></span><br></pre></td></tr></table></figure><ol><li><code>&lt;saml2p:Response&gt;</code> 元素：这是SAML响应的根元素，包含了整个SAML响应的内容。</li><li><code>xmlns:saml2p=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;</code>：这是XML命名空间声明，指定了SAML 2.0协议的命名空间。</li><li><code>Destination</code> 属性：指定了SAML响应的目标地址，表示响应应该发送到哪个URL，从SAMLRequest中的AssertionConsumerServiceURL获取。</li><li><code>ID</code> 属性：标识此SAML响应的唯一ID。</li><li><code>InResponseTo</code> 属性：指示此SAML响应是对哪个SAML请求（SAML请求的ID）的响应。</li><li><code>IssueInstant</code> 属性：指定了SAML响应的生成时间。</li><li><code>Version</code> 属性：指定了使用的SAML版本（在这种情况下，是2.0版本）。</li><li><code>&lt;saml2:Issuer&gt;</code> 元素：指定了发出SAML响应的实体（通常是IdP）。</li><li><code>&lt;ds:Signature&gt;</code> 元素：包含了SAML响应的数字签名信息，用于验证响应的完整性和真实性。<ul><li><code>&lt;ds:SignedInfo&gt;</code> 元素：包含了有关数字签名的信息，如签名方法和用于签名的数据。</li><li><code>&lt;ds:SignatureValue&gt;</code> 元素：包含了数字签名的实际值。</li><li><code>&lt;ds:KeyInfo&gt;</code> 元素：包含了与签名相关的密钥信息，通常是X.509证书。</li></ul></li><li><code>&lt;saml2p:Status&gt;</code> 元素：包含SAML响应的状态信息，通常指示成功或失败。<ul><li><code>&lt;saml2p:StatusCode&gt;</code> 元素：包含了SAML响应状态的值，这里表示成功。</li></ul></li><li><code>&lt;saml2:Assertion&gt;</code> 元素：包含了SAML断言，其中包含有关用户身份和授权的信息。<ul><li><code>&lt;saml2:Issuer&gt;</code> 元素：指定了生成此断言的实体（通常是IdP）。</li><li><code>&lt;saml2:Subject&gt;</code> 元素：包含有关用户的信息，如NameID（用户标识）和SubjectConfirmation（主题确认）信息。</li><li><code>&lt;saml2:Conditions&gt;</code> 元素：包含了断言的条件，如生效时间和过期时间。</li><li><code>&lt;saml2:AuthnStatement&gt;</code> 元素：包含有关身份验证的信息，如身份验证时间和身份验证上下文。</li><li><code>&lt;saml2:AttributeStatement&gt;</code> 元素：包含有关用户属性的信息，如用户姓名、ID、用户名和组织</li></ul></li></ol><h6 id="SMALMetadata-元数据"><a href="#SMALMetadata-元数据" class="headerlink" title="SMALMetadata 元数据"></a><strong>SMALMetadata 元数据</strong></h6><p>SAMLMetadata元数据，包含了sp和idp相关的信息</p><p>spring boot 的okta中示例:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">md:EntityDescriptor</span> <span class="attr">xmlns:md</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:metadata&quot;</span> <span class="attr">entityID</span>=<span class="string">&quot;http://www.okta.com/exk46xofd8NZvFCpS5d7&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">md:IDPSSODescriptor</span> <span class="attr">WantAuthnRequestsSigned</span>=<span class="string">&quot;false&quot;</span> <span class="attr">protocolSupportEnumeration</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">md:KeyDescriptor</span> <span class="attr">use</span>=<span class="string">&quot;signing&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ds:KeyInfo</span> <span class="attr">xmlns:ds</span>=<span class="string">&quot;http://www.w3.org/2000/09/xmldsig#&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ds:X509Data</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ds:X509Certificate</span>&gt;</span>base64证书<span class="tag">&lt;/<span class="name">ds:X509Certificate</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ds:X509Data</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ds:KeyInfo</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">md:KeyDescriptor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">md:SingleLogoutService</span> <span class="attr">Binding</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST&quot;</span> <span class="attr">Location</span>=<span class="string">&quot;https://dev-05937739.okta.com/app/dev-05937739_springgsecuritysaml2idp_1/exk46xofd8NZvFCpS5d7/slo/saml&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">md:SingleLogoutService</span> <span class="attr">Binding</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&quot;</span> <span class="attr">Location</span>=<span class="string">&quot;https://dev-05937739.okta.com/app/dev-05937739_springgsecuritysaml2idp_1/exk46xofd8NZvFCpS5d7/slo/saml&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">md:NameIDFormat</span>&gt;</span>urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress<span class="tag">&lt;/<span class="name">md:NameIDFormat</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">md:NameIDFormat</span>&gt;</span>urn:oasis:names:tc:SAML:2.0:nameid-format:transient<span class="tag">&lt;/<span class="name">md:NameIDFormat</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">md:SingleSignOnService</span> <span class="attr">Binding</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST&quot;</span> <span class="attr">Location</span>=<span class="string">&quot;https://dev-05937739.okta.com/app/dev-05937739_springgsecuritysaml2idp_1/exk46xofd8NZvFCpS5d7/sso/saml&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">md:SingleSignOnService</span> <span class="attr">Binding</span>=<span class="string">&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&quot;</span> <span class="attr">Location</span>=<span class="string">&quot;https://dev-05937739.okta.com/app/dev-05937739_springgsecuritysaml2idp_1/exk46xofd8NZvFCpS5d7/sso/saml&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">md:IDPSSODescriptor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">md:EntityDescriptor</span>&gt;</span></span><br></pre></td></tr></table></figure><ol><li><code>&lt;md:EntityDescriptor&gt;</code> 元素：这是SAML元数据文档的根元素，它包含了有关SAML实体（IdP）的信息。<ul><li><code>xmlns:md=&quot;urn:oasis:names:tc:SAML:2.0:metadata&quot;</code>：这是XML命名空间声明，指定了SAML 2.0元数据的命名空间。</li><li><code>entityID</code> 属性：指定了此实体的唯一标识，通常是URL或URN。</li></ul></li><li><code>&lt;md:IDPSSODescriptor&gt;</code> 元素：这个部分包含了有关身份提供者（IdP）的信息，特别是关于单点登录的信息。<ul><li><code>WantAuthnRequestsSigned</code> 属性：指示IdP是否要求接收到的身份验证请求（AuthnRequest）进行数字签名。在这里设置为 “false”，表示不要求签名。</li><li><code>protocolSupportEnumeration</code> 属性：指定了IdP支持的SAML协议版本。在这里，它表示支持SAML 2.0协议。</li></ul></li><li><code>&lt;md:KeyDescriptor&gt;</code> 元素：这个部分包含了与数字签名相关的密钥信息。<ul><li><code>use</code> 属性：指定了密钥的用途，这里是 “signing”，表示该密钥用于数字签名。</li><li><code>&lt;ds:KeyInfo&gt;</code> 元素：包含了与密钥信息的XML Digital Signature (XMLDSig) 相关的数据。<ul><li><code>&lt;ds:X509Data&gt;</code> 元素：包含了X.509证书，这是一种常用的数字证书格式，用于验证数字签名。证书内容被包含在 <code>&lt;ds:X509Certificate&gt;</code> 元素中。</li></ul></li></ul></li><li><code>&lt;md:SingleLogoutService&gt;</code> 元素：这个部分包含了有关单点注销服务的信息，包括绑定方式和服务的位置。这些服务用于在用户注销时通知其他系统。<ul><li><code>Binding</code> 属性：指定了单点注销服务的绑定方式，可以是HTTP-POST或HTTP-Redirect。</li><li><code>Location</code> 属性：指定了单点注销服务的URL。</li></ul></li><li><code>&lt;md:NameIDFormat&gt;</code> 元素：指定了用户标识（NameID）的格式。这个元素可以包含多个不同格式的 NameID，以便服务提供者可以选择合适的格式。</li><li><code>&lt;md:SingleSignOnService&gt;</code> 元素：这个部分包含了有关单点登录服务的信息，包括绑定方式和服务的位置。这些服务用于处理用户的单点登录请求。<ul><li><code>Binding</code> 属性：指定了单点登录服务的绑定方式，可以是HTTP-POST或HTTP-Redirect。</li><li><code>Location</code> 属性：指定了单点登录服务的URL。</li></ul></li></ol><h5 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h5><p><img src="https://images.idgesg.net/images/article/2017/10/security-assertion-markup-language-saml-explainer-100738529-orig.jpg" alt=""></p><ol><li>用户访问sp的应用</li><li>sp生成samlRequest，重定向到sso 服务</li><li>浏览器发起sso单点请求，携带SAMLRequest xml信息</li><li>idp解析XML，生成SAMLResponse</li><li>返回生成的SAMLResponse到sp服务</li><li>sp服务处理SAMLResponse，验证完成后，重定向到浏览器</li><li>访问受限的sp应用</li><li>sp返回相应的资源</li></ol><h5 id="Sp和Idp的通信方式"><a href="#Sp和Idp的通信方式" class="headerlink" title="Sp和Idp的通信方式"></a>Sp和Idp的通信方式</h5><p>该值在SAMLRequest中的ProtocolBinding定义，具体取值有：<code>HTTP Redirect Binding</code>, <code>HTTP POST Binding</code>, <code>HTTP Artifact Binding</code>。</p><h6 id="HTTP-Redirect-Binding"><a href="#HTTP-Redirect-Binding" class="headerlink" title="HTTP Redirect Binding"></a><strong>HTTP Redirect Binding</strong></h6><p>SP通过重定向到idp的 sso url，并通过GET请求发送到idp，携带SAMLRequest，由于长度限制，只能传输较小的参数，且不适用于传输敏感信息。</p><h6 id="HTTP-POST-Binding"><a href="#HTTP-POST-Binding" class="headerlink" title="HTTP POST Binding"></a><strong>HTTP POST Binding</strong></h6><p>用于将SAML消息通过HTTP POST 请求发送给接收方。这种绑定通常用于传输大型SAML消息或包含敏感信息的消息。</p><h6 id="HTTP-Artifact-Binding"><a href="#HTTP-Artifact-Binding" class="headerlink" title="HTTP Artifact Binding"></a><strong>HTTP Artifact Binding</strong></h6><p>将SAML 断言的简短标识（Artifact）传输给接收方，接收方可以使用该标识从SAML断言存储库中检索断言。</p><h4 id="Saml和Oauth2-0的区别"><a href="#Saml和Oauth2-0的区别" class="headerlink" title="Saml和Oauth2.0的区别"></a>Saml和Oauth2.0的区别</h4><h5 id="相同点"><a href="#相同点" class="headerlink" title="相同点"></a>相同点</h5><ol><li>均用于身份验证和授权：OAuth2和SAML都用于身份验证和授权，以确保用户可以安全地访问受保护的资源。</li><li>都支持使用安全令牌：OAuth2和SAML都使用安全令牌来实现身份验证和授权。在OAuth2中，使用访问令牌（access token），而在SAML中，使用断言（assertions）来代表用户的身份。</li><li>适用于跨组织、跨域和跨平台身份验证：OAuth2和SAML都被设计用于在不同组织、域和平台之间进行身份验证和授权。</li></ol><h5 id="不同点"><a href="#不同点" class="headerlink" title="不同点"></a>不同点</h5><ol><li>协议类型：OAuth2是一种授权框架，而SAML是一种基于XML的身份认证和断言协议。</li><li>使用场景：OAuth2通常用于与第三方应用程序进行授权和访问控制，例如允许用户使用Google账号登录到其他应用程序。而SAML通常用于企业内部身份管理和单点登录。</li><li>认证流程：OAuth2使用授权码授权流程或隐式授权流程来通过授权服务器获取访问令牌。而SAML使用基于浏览器的重定向来将用户身份验证请求从服务提供者重定向到身份提供者，并使用SAML断言将用户身份信息传递回服务提供者。</li><li>数据格式：OAuth2使用JSON格式来表示令牌和授权请求。而SAML使用基于XML的格式来定义身份断言和授权请求。</li></ol><h5 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h5><h6 id="Oauth2-0"><a href="#Oauth2-0" class="headerlink" title="Oauth2.0"></a>Oauth2.0</h6><ol><li>第三方应用授权：OAuth2适用于允许用户使用第三方应用程序（如社交媒体应用、电子邮件应用等）访问其个人数据，但又不需要直接共享用户名和密码。</li><li>API访问控制：OAuth2可用于保护和控制对API的访问，并允许用户授予第三方应用程序有限的权限来访问其数据。</li><li>跨平台身份验证：OAuth2是一种跨平台的身份验证机制，允许用户在一个平台上进行身份验证，并在另一个平台上使用该身份进行访问控制。</li></ol><h6 id="Saml"><a href="#Saml" class="headerlink" title="Saml"></a>Saml</h6><ol><li>单点登录（Single Sign-On, SSO）：在 SAML 中，身份提供者（Identity Provider, IdP）负责核实用户的身份并颁发身份令牌，用户可以使用该身份令牌在多个服务提供者（Service Providers, SPs）之间进行单点登录，而无需多次输入用户名和密码。</li><li>跨组织身份验证：SAML 提供了一种在不同组织之间进行跨域身份验证的机制。用户可以使用自己的身份凭证登录到一个组织的服务，并且可以使用该身份令牌在其他信任的组织的服务中进行访问。</li><li>跨平台和跨设备身份验证：SAML 可以用于在不同平台（如 Web、移动设备、桌面应用）和设备（如电脑、手机、平板等）之间进行身份验证和授权。</li><li>云服务集成：许多云服务提供商支持 SAML，通过 SAML 可以实现与这些云服务的集成，从而实现用户的统一身份管理。</li><li>企业联盟和联合身份验证：多个企业可以建立联盟，在联盟成员之间分享身份数据，从而实现联合身份验证和访问控制。</li></ol>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes 部署EFK</title>
      <link href="/2023/04/29/Linux/Kubernetes-%E9%83%A8%E7%BD%B2EFK/"/>
      <url>/2023/04/29/Linux/Kubernetes-%E9%83%A8%E7%BD%B2EFK/</url>
      
        <content type="html"><![CDATA[<h4 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h4><h5 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h5><p><a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-deploy-eck.html">部署操作员</a></p><ol><li><h5 id="storageclass"><a href="#storageclass" class="headerlink" title="storageclass"></a>storageclass</h5></li></ol><p>部署EFK时，需要有存储卷来对es中的数据进行存储，可以在nodeSets中指定storageClassName，也可以直接使用默认的storageclass</p><ul><li><a href="https://fuhouyu.com/2023/04/08/Linux/Kubernetes 部署存储卷/">部署存储卷</a></li><li>修改默认值</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取storageclass</span></span><br><span class="line">kubectl get sc </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使storageclass为默认存储</span></span><br><span class="line">kubectl patch &lt;替换为storageclass名称&gt; -p &#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure><ul><li><a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-volume-claim-templates.html">官方文档</a></li></ul><h4 id="部署Elasticsearch"><a href="#部署Elasticsearch" class="headerlink" title="部署Elasticsearch"></a>部署Elasticsearch</h4><h5 id="设置用户名、密码"><a href="#设置用户名、密码" class="headerlink" title="设置用户名、密码"></a>设置用户名、密码</h5><p>在不创建账户时，默认账户为elastic，密码要通过k8s的文档获取随机生成的密码项，详情查看<a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-users-and-roles.html">官方文档</a></p><p>这里使用文本领域创建，使用官方给的docker示例进行创建</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir filerealm</span><br><span class="line">touch filerealm/users filerealm/users_roles</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">superuser是elasticsearch中的超管角色</span></span><br><span class="line">docker run  --name es-user \</span><br><span class="line">    -v $(pwd)/filerealm:/usr/share/elasticsearch/config \</span><br><span class="line">    docker.elastic.co/elasticsearch/elasticsearch:8.7.0 \</span><br><span class="line">    bin/elasticsearch-users useradd &lt;myuser&gt; -p &lt;mypassword&gt; -r superuser</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">create a Kubernetes secret with the file realm content</span></span><br><span class="line">kubectl create secret generic es-secret --from-file filerealm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除容器</span></span><br><span class="line">docker stop es-user &amp;&amp; docker rm es-user</span><br></pre></td></tr></table></figure><p>在yaml中启用</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">elasticsearch.k8s.elastic.co/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Elasticsearch</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">8.7</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">auth:</span></span><br><span class="line">    <span class="attr">fileRealm:</span></span><br><span class="line">    <span class="comment"># 上面创建的密钥名称</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">secretName:</span> <span class="string">es-secret</span></span><br><span class="line">  <span class="attr">nodeSets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">count:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">node.store.allow_mmap:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">podTemplate:</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ES_JAVA_OPTS</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">-Xms1g</span> <span class="string">-Xmx1g</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">2Gi</span></span><br></pre></td></tr></table></figure><h4 id="部署Kibana"><a href="#部署Kibana" class="headerlink" title="部署Kibana"></a>部署Kibana</h4><h5 id="yaml"><a href="#yaml" class="headerlink" title="yaml"></a>yaml</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kibana.k8s.elastic.co/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kibana</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">8.7</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">count:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">elasticsearchRef:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="comment"># 设置NodePort，暴露出5601端口</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">   <span class="attr">service:</span> </span><br><span class="line">    <span class="attr">spec:</span> </span><br><span class="line">     <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">     <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">5601</span></span><br><span class="line">        <span class="attr">nodePort:</span> <span class="number">35601</span></span><br><span class="line">  <span class="attr">config:</span> </span><br><span class="line">   <span class="comment"># 配置中文</span></span><br><span class="line">   <span class="attr">i18n.locale:</span> <span class="string">&quot;zh-CN&quot;</span></span><br></pre></td></tr></table></figure><h4 id="部署APM-server"><a href="#部署APM-server" class="headerlink" title="部署APM server"></a>部署APM server</h4><h5 id="yaml-1"><a href="#yaml-1" class="headerlink" title="yaml"></a>yaml</h5><ul><li>如果只考虑k8s中的服务，也可以不暴露NodePort，通过无头服务进行访问处理</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apm.k8s.elastic.co/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ApmServer</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">apm-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">8.7</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">count:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">   <span class="attr">service:</span> </span><br><span class="line">    <span class="attr">spec:</span> </span><br><span class="line">     <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">     <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8200</span></span><br><span class="line">        <span class="attr">nodePort:</span> <span class="number">30082</span></span><br><span class="line"><span class="comment"># 这里的es的名称，需要es的相同</span></span><br><span class="line">  <span class="attr">elasticsearchRef:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br></pre></td></tr></table></figure><h5 id="在Kibana中添加APM集成"><a href="#在Kibana中添加APM集成" class="headerlink" title="在Kibana中添加APM集成"></a>在Kibana中添加APM集成</h5><p><img src="https://img.fuhouyu.com/2023-04-29-154055.png" alt=""></p><p>添加APM集成，设置APM集成的名称和url以提供后续其他工程使用</p><p><img src="https://img.fuhouyu.com/2023-04-29-154248.png" alt=""></p><p>主机的url设置可以正常内网或外网访问的地址项。</p><h5 id="添加Java-Agent"><a href="#添加Java-Agent" class="headerlink" title="添加Java Agent"></a>添加Java Agent</h5><p><img src="https://img.fuhouyu.com/2023-04-29-154645.jpg" alt=""></p><p>最终可以在APM中看到可访问的服务</p><p><img src="https://img.fuhouyu.com/2023-04-29-154818.png" alt=""></p><h4 id="部署filebeat"><a href="#部署filebeat" class="headerlink" title="部署filebeat"></a>部署filebeat</h4><ul><li>服务部署到容器，通过logback记录到本地的日志文件中。通过filebeat收集，添加到es中，方便日志的统一收集，管理。</li></ul><h5 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h5><ol><li>es部署时，需要通过TLS才能进行访问，需要获取es中的证书文件。</li><li>filebeat记录的日志文件，需要在kibana中设置索引模板，使用默认的模板会选成多余无用索引的情况</li></ol><h5 id="获取上文中部署的es证书文件"><a href="#获取上文中部署的es证书文件" class="headerlink" title="获取上文中部署的es证书文件"></a>获取上文中部署的es证书文件</h5><p>从容器中获取ca.crt,tls.key,tls.crt三个文件。</p><p>在<code>/usr/share/elasticsearch/config/http-certs/</code>目录下，可以看到建立了软链接</p><p><img src="https://img.fuhouyu.com/2023-04-29-161112.png" alt=""></p><p>通过kubectl cp 将该文件复制出来。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">cp</span> elasticsearch-es-default-0:/usr/share/elasticsearch/config/http-certs/..2023_04_29_02_59_34.819982638 /ddhome/nfs/es-cert</span><br></pre></td></tr></table></figure><h5 id="Kibana中添加索引模板"><a href="#Kibana中添加索引模板" class="headerlink" title="Kibana中添加索引模板"></a>Kibana中添加索引模板</h5><p>左侧栏中选择Management，在<em>数据项</em>中选项<em>索引管理</em></p><p><img src="https://img.fuhouyu.com/2023-04-29-162425.png" alt=""></p><p>创建一个新的模板，起名为<code>service-log</code>，注意在索引模式中，需要设置接收的索引。只有设置了这类的索引，才会进行数据流入。</p><p><img src="https://img.fuhouyu.com/2023-04-29-162628.png" alt=""></p><p>组件模板默认，在索引设置中，添加如下json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;lifecycle&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mapping&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;total_fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10000&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_docvalue_fields_search&quot;</span><span class="punctuation">:</span> <span class="string">&quot;200&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;default_field&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;message&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;fields.log.level&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;fields.service&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>最后设置映射如下，其它默认</p><p><img src="https://img.fuhouyu.com/2023-04-29-162715.png" alt=""></p><h5 id="filebeat-cm-yaml"><a href="#filebeat-cm-yaml" class="headerlink" title="filebeat-cm.yaml"></a>filebeat-cm.yaml</h5><ul><li>使用configMap设置日志相关配置</li><li>在logback的配置中，日志文件已区分INFO和ERROR，记录为两个独立的日志文件，所以这里的输入写成两个，作为日志的索引项</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-config</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">filebeat.yml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    filebeat.inputs:</span></span><br><span class="line"><span class="string">      - type: log</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">        paths:</span></span><br><span class="line"><span class="string">          - /var/log/service-gateway/*info*.log</span></span><br><span class="line"><span class="string">        # 编码格式</span></span><br><span class="line"><span class="string">        encoding: utf-8</span></span><br><span class="line"><span class="string">        # 日志匹配</span></span><br><span class="line"><span class="string">        multiline.pattern: ^\s*\d\d\d\d-\d\d-\d\d</span></span><br><span class="line"><span class="string">        # 多行日志事件形状不匹配的行，作为新的日志事项</span></span><br><span class="line"><span class="string">        multiline.negate: true</span></span><br><span class="line"><span class="string">        # 与第一个匹配的行之后的所有行相关联到同一个多行事件中</span></span><br><span class="line"><span class="string">        multiline.match: after</span></span><br><span class="line"><span class="string">        fields:</span></span><br><span class="line"><span class="string">          # log.level设置为INFO</span></span><br><span class="line"><span class="string">          log.level: INFO</span></span><br><span class="line"><span class="string">          # 服务设置为Java启动的服务名称，方便筛选</span></span><br><span class="line"><span class="string">          service: service-gateway</span></span><br><span class="line"><span class="string">      - type: log</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">        paths:</span></span><br><span class="line"><span class="string">          - /var/log/service-gateway/*error*.log</span></span><br><span class="line"><span class="string">        encoding: utf-8</span></span><br><span class="line"><span class="string">        multiline.pattern: ^\s*\d\d\d\d-\d\d-\d\d</span></span><br><span class="line"><span class="string">        multiline.negate: true</span></span><br><span class="line"><span class="string">        multiline.match: after</span></span><br><span class="line"><span class="string">        fields:</span></span><br><span class="line"><span class="string">          log.level: ERROR</span></span><br><span class="line"><span class="string">          service: service-gateway</span></span><br><span class="line"><span class="string">    # 输出到es配置</span></span><br><span class="line"><span class="string">    output.elasticsearch:</span></span><br><span class="line"><span class="string">      enabled: true</span></span><br><span class="line"><span class="string">      hosts: [&#x27;https://$&#123;ELASTICSEARCH_HOST:elasticsearch&#125;:$&#123;ELASTICSEARCH_PORT:9200&#125;&#x27;]</span></span><br><span class="line"><span class="string">      username: $&#123;ELASTICSEARCH_USERNAME&#125;</span></span><br><span class="line"><span class="string">      password: $&#123;ELASTICSEARCH_PASSWORD&#125;</span></span><br><span class="line"><span class="string">      # 上面获取到的ssl证书相关配置</span></span><br><span class="line"><span class="string">      ssl.key: /data/cert/elasticsearch-es-default-0.tls.key</span></span><br><span class="line"><span class="string">      ssl.certificate: /data/cert/elasticsearch-es-default-0.tls.crt</span></span><br><span class="line"><span class="string">      ssl.certificate_authorities: /data/cert/ca.crt</span></span><br><span class="line"><span class="string">      # 索引，需要在索引模板的索引模式中匹配才行</span></span><br><span class="line"><span class="string">      index: &quot;service-log&quot;</span></span><br><span class="line"><span class="string">    setup.ilm.enabled: false</span></span><br><span class="line"><span class="string">    # 模板名称</span></span><br><span class="line"><span class="string">    setup.template.name: service-log</span></span><br><span class="line"><span class="string">    setup.template.pattern: service-log</span></span><br></pre></td></tr></table></figure><h5 id="filebeat-yaml"><a href="#filebeat-yaml" class="headerlink" title="filebeat.yaml"></a>filebeat.yaml</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>] <span class="comment"># &quot;&quot; indicates the core API group</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">replicasets</span></span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;batch&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">jobs</span></span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="comment"># should be the namespace where filebeat is running</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">coordination.k8s.io</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">leases</span></span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-kubeadm-config</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="attr">resourceNames:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">kubeadm-config</span></span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-kubeadm-config</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-kubeadm-config</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">filebeat</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">docker.elastic.co/beats/filebeat:8.7.0</span></span><br><span class="line">          <span class="attr">args:</span> [</span><br><span class="line">            <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;/etc/filebeat.yml&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-e&quot;</span>,</span><br><span class="line">          ]</span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTICSEARCH_HOST</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">elasticsearch-es-http</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTICSEARCH_PORT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;9200&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTICSEARCH_USERNAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&lt;username&gt;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTICSEARCH_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&lt;password&gt;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">            <span class="comment"># If using Red Hat OpenShift uncomment this:</span></span><br><span class="line">            <span class="comment">#privileged: true</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/filebeat.yml</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">filebeat.yml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/usr/share/filebeat/data</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cert</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data/cert</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">0640</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">filebeat-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">        <span class="comment"># 挂载服务日志，可以使用nfs，或者storageclass</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/ddhome/log/service/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/lib/filebeat-data</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">        <span class="comment"># 挂载证书文件。可以使用nfs，或者storageclass</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cert</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/ddhome/nfs/es-cert</span></span><br></pre></td></tr></table></figure><h5 id="执行yaml"><a href="#执行yaml" class="headerlink" title="执行yaml"></a>执行yaml</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f filebeat-cm.yaml</span><br><span class="line">kubectl apply -f filebeat.yaml</span><br></pre></td></tr></table></figure><p>等待容器启动完成如下</p><p><img src="https://img.fuhouyu.com/2023-04-29-163233.png" alt=""></p><h4 id="创建数据视图"><a href="#创建数据视图" class="headerlink" title="创建数据视图"></a>创建数据视图</h4><ul><li>先在文件中写入任一日志，如http请求等</li><li>在kibana中，创建数据视频，选择索引模式的匹配项</li></ul><p><img src="https://img.fuhouyu.com/2023-04-29-163523.png" alt=""></p><p>响应后的日志如下图所示</p><p><img src="https://img.fuhouyu.com/2023-04-29-163600.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义Docker镜像引起的Java请求https证书问题</title>
      <link href="/2023/04/25/Java/%E8%87%AA%E5%AE%9A%E4%B9%89Docker%E9%95%9C%E5%83%8F%E5%BC%95%E8%B5%B7%E7%9A%84Java%E8%AF%B7%E6%B1%82https%E8%AF%81%E4%B9%A6%E9%97%AE%E9%A2%98/"/>
      <url>/2023/04/25/Java/%E8%87%AA%E5%AE%9A%E4%B9%89Docker%E9%95%9C%E5%83%8F%E5%BC%95%E8%B5%B7%E7%9A%84Java%E8%AF%B7%E6%B1%82https%E8%AF%81%E4%B9%A6%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>Java 在通过RestTemplate请求https的请求时，出现证书的错误，报错如下：</p><p><img src="https://img.fuhouyu.com/2023-04-25-134454.png" alt=""></p><p>正常的请求是会返回一个Json对象，然而现在的请求的结果是：PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target。</p><p>翻译可知， java在请求https的请求时，需要构建证书，但是现在无法找到有效的证书路径，导致了该错误。</p><p>在Google了一下后，需要通过keytool进行证书的导入，或直接忽略掉ssl的安全项。</p><p><em>但该问题在Docker镜像更换前，并未出现。所以先排查下Docker的基础镜像。</em></p><h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><ul><li>原先的基础镜像使用的是openjdk11，在该基础镜像上，并没有出现过ssl证书的问题。</li><li>在后续的版本中，docker基础镜像修改为debian11，也就出现了该问题。</li></ul><p>在查看openjdk的官方镜像时，看到这样的步骤。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/bin/sh -c <span class="built_in">set</span> -eux; <span class="built_in">arch</span>=<span class="string">&quot;<span class="subst">$(dpkg --print-architecture)</span>&quot;</span>; <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$arch</span>&quot;</span> <span class="keyword">in</span> <span class="string">&#x27;amd64&#x27;</span>) downloadUrl=<span class="string">&#x27;https://download.java.net/java/early_access/jdk21/19/GPL/openjdk-21-ea+19_linux-x64_bin.tar.gz&#x27;</span>; downloadSha256=<span class="string">&#x27;5af95497753fbc33981f5ab1267fbd3be57e4095ceca9806490a25b56f819007&#x27;</span>; ;; <span class="string">&#x27;arm64&#x27;</span>) downloadUrl=<span class="string">&#x27;https://download.java.net/java/early_access/jdk21/19/GPL/openjdk-21-ea+19_linux-aarch64_bin.tar.gz&#x27;</span>; downloadSha256=<span class="string">&#x27;d08fe17feea7fa18c4e9ee9918496974d0194d1fac9a485d47cc2d30601c3682&#x27;</span>; ;; *) <span class="built_in">echo</span> &gt;&amp;2 <span class="string">&quot;error: unsupported architecture: &#x27;<span class="variable">$arch</span>&#x27;&quot;</span>; <span class="built_in">exit</span> 1 ;; <span class="keyword">esac</span>; savedAptMark=<span class="string">&quot;<span class="subst">$(apt-mark showmanual)</span>&quot;</span>; apt-get update; apt-get install -y --no-install-recommends wget ; </span><br><span class="line"><span class="built_in">rm</span> -rf /var/lib/apt/lists/*; </span><br><span class="line">wget --progress=dot:giga -O openjdk.tgz <span class="string">&quot;<span class="variable">$downloadUrl</span>&quot;</span>;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$downloadSha256</span> *openjdk.tgz&quot;</span> | <span class="built_in">sha256sum</span> --strict --check -;</span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$JAVA_HOME</span>&quot;</span>; tar --extract --file openjdk.tgz --directory <span class="string">&quot;<span class="variable">$JAVA_HOME</span>&quot;</span> --strip-components 1 --no-same-owner ; </span><br><span class="line"><span class="built_in">rm</span> openjdk.tgz*; apt-mark auto <span class="string">&#x27;.*&#x27;</span> &gt; /dev/null; [ -z <span class="string">&quot;<span class="variable">$savedAptMark</span>&quot;</span> ] || apt-mark manual <span class="variable">$savedAptMark</span> &gt; /dev/null; apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=<span class="literal">false</span>; &#123; <span class="built_in">echo</span> <span class="string">&#x27;#!/usr/bin/env bash&#x27;</span>; <span class="built_in">echo</span> <span class="string">&#x27;set -Eeuo pipefail&#x27;</span>; <span class="built_in">echo</span> <span class="string">&#x27;trust extract --overwrite --format=java-cacerts --filter=ca-anchors --purpose=server-auth &quot;$JAVA_HOME/lib/security/cacerts&quot;&#x27;</span>; &#125; &gt; /etc/ca-certificates/update.d/docker-openjdk; <span class="built_in">chmod</span> +x /etc/ca-certificates/update.d/docker-openjdk; /etc/ca-certificates/update.d/docker-openjdk; find <span class="string">&quot;<span class="variable">$JAVA_HOME</span>/lib&quot;</span> -name <span class="string">&#x27;*.so&#x27;</span> -<span class="built_in">exec</span> <span class="built_in">dirname</span> <span class="string">&#x27;&#123;&#125;&#x27;</span> <span class="string">&#x27;;&#x27;</span> | <span class="built_in">sort</span> -u &gt; /etc/ld.so.conf.d/docker-openjdk.conf; ldconfig; java -Xshare:dump; fileEncoding=<span class="string">&quot;<span class="subst">$(echo &#x27;System.out.println(System.getProperty(<span class="string">&quot;file.encoding&quot;</span>)</span>)&#x27; | jshell -s -)&quot;</span>; [ <span class="string">&quot;<span class="variable">$fileEncoding</span>&quot;</span> = <span class="string">&#x27;UTF-8&#x27;</span> ]; <span class="built_in">rm</span> -rf ~/.java; javac --version; java --version</span><br></pre></td></tr></table></figure><blockquote><p> <img src="https://img.fuhouyu.com/2023-04-25-142142.png" alt=""></p><p>在这个命令中，从系统的存储库提取证书后，生成了一个新的keystore文件，并放入到Java的<code>$JAVA_HOME/lib/security/cacerts</code>的路径中，以此来保证ssl/tls的正常使用。</p></blockquote><h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>根据上面查询到的命令，最终的dockerfile如下</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:<span class="number">11.6</span>-slim as jre</span><br><span class="line"><span class="keyword">ENV</span> AMD_DOWNLOAD_URL=https://github.com/AdoptOpenJDK/openjdk11-upstream-binaries/releases/download/jdk-<span class="number">11.0</span>.<span class="number">16</span>%<span class="number">2</span>B8/OpenJDK11U-jdk-shenandoah_x64_linux_11.<span class="number">0.16</span>_8.tar.gz</span><br><span class="line"><span class="keyword">ENV</span> ARM_DOWNLOAD_URL=https://github.com/AdoptOpenJDK/openjdk11-upstream-binaries/releases/download/jdk-<span class="number">11.0</span>.<span class="number">16</span>%<span class="number">2</span>B8/OpenJDK11U-jdk-shenandoah_aarch64_linux_11.<span class="number">0.16</span>_8.tar.gz</span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=/usr/local/jdk</span><br><span class="line"><span class="keyword">ENV</span> PATH=$&#123;JAVA_HOME&#125;/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> \</span></span><br><span class="line"><span class="language-bash">    <span class="comment"># 软件源配置</span></span></span><br><span class="line">    sed -i <span class="string">&#x27;s#deb.debian.org#mirrors.tuna.tsinghua.edu.cn#g&#x27;</span> /etc/apt/sources.list; \</span><br><span class="line">    apt update &amp;&amp; apt install  -y --no-install-recommends  binutils curl wget vim fontconfig libfreetype6 ca-certificates p11-kit; apt-get clean; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*;\</span><br><span class="line">    <span class="comment"># 下载jdk</span></span><br><span class="line">    /bin/sh -c set -eux; arch=<span class="string">&quot;$(dpkg --print-architecture)&quot;</span>; case <span class="string">&quot;$arch&quot;</span> in <span class="string">&#x27;amd64&#x27;</span>) downloadUrl=<span class="string">&quot;$&#123;AMD_DOWNLOAD_URL&#125;&quot;</span>; ;; <span class="string">&#x27;arm64&#x27;</span>) downloadUrl=<span class="string">&quot;$&#123;ARM_DOWNLOAD_URL&#125;&quot;</span>; ;; *) echo &gt;&amp;<span class="number">2</span> <span class="string">&quot;error: unsupported architecture: &#x27;$arch&#x27;&quot;</span>; exit <span class="number">1</span> ;; esac; wget --progress=dot:giga -O openjdk.tgz <span class="string">&quot;$downloadUrl&quot;</span>; mkdir -p <span class="string">&quot;$JAVA_HOME&quot;</span>; tar --extract --file openjdk.tgz --directory <span class="string">&quot;$JAVA_HOME&quot;</span> --strip-components <span class="number">1</span> --no-same-owner ; rm openjdk.tgz*; \</span><br><span class="line">    <span class="comment"># 构建jre</span></span><br><span class="line">    jlink --output /usr/local/jre --<span class="keyword">add</span><span class="language-bash">-modules ALL-MODULE-PATH --compress 2 --strip-debug --no-header-files --no-man-pages;</span></span><br><span class="line"><span class="keyword">FROM</span> debian:<span class="number">11.6</span>-slim</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /home/data</span></span><br><span class="line"><span class="comment"># 设置jre环境</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=jre /usr/local/jre /usr/local/jre</span></span><br><span class="line"><span class="comment"># 配置arthas</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=hengyunabc/arthas:latest /opt/arthas ./arthas</span></span><br><span class="line"><span class="comment"># 更新时区和java环境</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="keyword">ENV</span> LANG=C.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=/usr/local/jre</span><br><span class="line"><span class="keyword">ENV</span> PATH=$&#123;JAVA_HOME&#125;/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> \</span></span><br><span class="line"><span class="language-bash">    <span class="comment"># 时间设置</span></span></span><br><span class="line">    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone; \</span><br><span class="line">    <span class="comment"># 软件源配置</span></span><br><span class="line">    sed -i <span class="string">&#x27;s#deb.debian.org#mirrors.tuna.tsinghua.edu.cn#g&#x27;</span> /etc/apt/sources.list; \</span><br><span class="line">    apt update &amp;&amp; apt install  -y --no-install-recommends curl wget vim fontconfig libfreetype6 ca-certificates p11-kit; apt-get clean; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*;\</span><br><span class="line">    <span class="comment"># 设置ll</span></span><br><span class="line">    echo <span class="string">&quot;alias ll=&#x27;ls $LS_OPTIONS -l&#x27;&quot;</span> &gt;&gt; /root/.bashrc &amp;&amp;  . /root/.bashrc; \</span><br><span class="line">    <span class="comment"># 设置apm-agent</span></span><br><span class="line">    mkdir -p apm;curl -o <span class="string">&#x27;apm/apm-agent.jar&#x27;</span> -L <span class="string">&#x27;https://oss.sonatype.org/service/local/artifact/maven/redirect?r=releases&amp;g=co.elastic.apm&amp;a=elastic-apm-agent&amp;v=LATEST&#x27;</span>;\</span><br><span class="line">    <span class="comment"># 写入证书文件执行</span></span><br><span class="line">    &#123; echo <span class="string">&#x27;#!/usr/bin/env bash&#x27;</span>; echo <span class="string">&#x27;set -Eeuo pipefail&#x27;</span>; echo <span class="string">&#x27;trust extract --overwrite --format=java-cacerts --filter=ca-anchors --purpose=server-auth &quot;$JAVA_HOME/lib/security/cacerts&quot;&#x27;</span>; &#125; &gt; /etc/ca-certificates/update.d/docker-openjdk;chmod +x /etc/ca-certificates/update.d/docker-openjdk;/etc/ca-certificates/update.d/docker-openjdk;\</span><br><span class="line">    <span class="comment"># 生成共享类库</span></span><br><span class="line">    find <span class="string">&quot;$JAVA_HOME/lib&quot;</span> -name <span class="string">&#x27;*.so&#x27;</span> -exec dirname <span class="string">&#x27;&#123;&#125;&#x27;</span> <span class="string">&#x27;;&#x27;</span> | sort -u &gt; /etc/ld.so.conf.d/docker-openjdk.conf; ldconfig; java -Xshare:dump; fileEncoding=<span class="string">&quot;$(echo &#x27;System.out.println(System.getProperty(&quot;</span>file.encoding<span class="string">&quot;))&#x27; | jshell -s -)&quot;</span>; [ <span class="string">&quot;$fileEncoding&quot;</span> = <span class="string">&#x27;UTF-8&#x27;</span> ]; rm -rf ~/.java; javac --version; java --version;</span><br></pre></td></tr></table></figure><p>重新构建后，作为基础镜像，该问题解决。</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jenkins 自动化流水线部署</title>
      <link href="/2023/04/08/Linux/Jenkins%20%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%81%E6%B0%B4%E7%BA%BF%E9%83%A8%E7%BD%B2/"/>
      <url>/2023/04/08/Linux/Jenkins%20%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%81%E6%B0%B4%E7%BA%BF%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h4 id="必备软件"><a href="#必备软件" class="headerlink" title="必备软件"></a>必备软件</h4><h5 id="安装docker-containerd"><a href="#安装docker-containerd" class="headerlink" title="安装docker/containerd"></a>安装docker/containerd</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install docker</span><br></pre></td></tr></table></figure><h5 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装git</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install git</span><br></pre></td></tr></table></figure><p>安装maven/mvnd</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载mvnd</span></span><br><span class="line">wget https://github.com/apache/maven-mvnd/releases/download/1.0-m6/maven-mvnd-1.0-m6-m39-linux-amd64.zip</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压mvnd</span></span><br><span class="line">unzip maven-mvnd-1.0-m6-m39-linux-amd64.zip -d ./mvnd</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="安装jenkins"><a href="#安装jenkins" class="headerlink" title="安装jenkins"></a>安装jenkins</h5><p><a href="https://www.jenkins.io/zh/download/">Jenkins 的安装和设置</a></p><h6 id="安装必备插件"><a href="#安装必备插件" class="headerlink" title="安装必备插件"></a>安装必备插件</h6><ol><li><p>打开jenkins页面后，根据提示更新</p></li><li><p>更新<a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json">jenkins镜像源</a></p></li><li><p>下载必备Docker Pipeline</p><p><img src="https://img.fuhouyu.com/2023-04-08-130735.png" alt=""></p></li><li><p>在全局工具中，定义maven</p></li><li><p>定义jenkins的git凭据，复制git凭据id</p></li></ol><h6 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h6><p>新版本的jenkins配置文件在：<code>/usr/lib/systemd/system/jenkins.service</code>目录下</p><p>jenkins新版本至少需要jdk11才可以，如果在之前已经安装过jdk，且小于11，可能会出现无法启动的情况，需要更新环境变量</p><h5 id="打包部署java项目"><a href="#打包部署java项目" class="headerlink" title="打包部署java项目"></a>打包部署java项目</h5><ol><li>新建项目，选择流水线</li></ol><p><img src="https://img.fuhouyu.com/2023-04-08-130916.png" alt=""></p><ol><li><p>勾选选项参数</p><ol><li>添加git选项url</li><li>添加文本参数branch</li><li>添加选项参数 harborUrl，harbor镜像地址</li><li>添加选项参数 k8s_master, master主节点地址</li><li>添加文本参数 service，java模块地址</li><li>添加文件参数 depth，jar目录深度</li></ol><p>如下图所示</p><p><img src="https://img.fuhouyu.com/2023-04-08-142129.png" alt=""></p></li><li><p>使用流水线，定义脚本</p><p><img src="https://img.fuhouyu.com/2023-04-08-131136.png" alt=""></p><p>脚本如下：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">node &#123;</span><br><span class="line">  <span class="keyword">def</span> mvn = tool <span class="string">&#x27;maven&#x27;</span>;</span><br><span class="line">  <span class="keyword">def</span> version = <span class="string">&quot;v&quot;</span> + sh(<span class="attr">script:</span> <span class="string">&quot;date &#x27;+%s&#x27;&quot;</span>, <span class="attr">returnStdout:</span> <span class="literal">true</span>).trim()</span><br><span class="line">  <span class="keyword">def</span> imageTags = []</span><br><span class="line">  <span class="keyword">def</span> k8sTemplates = []</span><br><span class="line">  <span class="keyword">def</span> baseHarborUrl = <span class="string">&quot;$&#123;harborUrl&#125;&quot;</span>.tokenize(<span class="string">&#x27;/&#x27;</span>).last()</span><br><span class="line">  <span class="keyword">def</span> startup = <span class="string">&#x27;&#x27;&#x27;#!/bin/bash</span></span><br><span class="line"><span class="string">JAVA_OPT=&quot;java&quot;</span></span><br><span class="line"><span class="string">BASE_DIR=&quot;/home/data&quot;</span></span><br><span class="line"><span class="string">SERVICE_NAME=$1</span></span><br><span class="line"><span class="string">ACTIVE=$2</span></span><br><span class="line"><span class="string">PARAM=$3</span></span><br><span class="line"><span class="string">#===========================================================================================</span></span><br><span class="line"><span class="string"># JVM Configuration</span></span><br><span class="line"><span class="string">#===========================================================================================</span></span><br><span class="line"><span class="string">if  [ -n &quot;$JVM_XMS&quot; ] ;then</span></span><br><span class="line"><span class="string">  JVM_OPT=&quot;$JVM_OPT -Xms$&#123;JVM_XMS&#125;&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [ -n &quot;$JVM_XMX&quot; ]; then</span></span><br><span class="line"><span class="string">  JVM_OPT=&quot;$JVM_OPT -Xmx$&#123;JVM_XMX&#125;&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [ &quot;$&#123;DEBUG_ENABLED&#125;&quot; == &quot;y&quot; ]; then</span></span><br><span class="line"><span class="string">  JVM_OPT=&quot;$JVM_OPT -Xrunjdwp:transport=dt_socket,address=*:10000,server=y,suspend=n&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [ -n &quot;$JVM_OTHER_PARAMS&quot;]; then</span></span><br><span class="line"><span class="string">  JVM_OPT=&quot;$JVM_OPT $&#123;JVM_OTHER_PARAMS&#125;&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [ -n &quot;$DUMP_LOG&quot; ]; then</span></span><br><span class="line"><span class="string">  DUMP_LOG=&quot;/var/log/java_heapdump.hprof&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [ -n &quot;$JAVA_LOG&quot; ]; then</span></span><br><span class="line"><span class="string">  JAVA_LOG=&quot;-Xlog:gc*=debug:file=/var/log/gc.log:utctime,level,tags:filecount=30,filesize=100M&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">JVM_OPT=&quot;$JVM_OPT -XX:-OmitStackTraceInFastThrow -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$DUMP_LOG&quot;</span></span><br><span class="line"><span class="string">JVM_OPT=&quot;$JVM_OPT $JAVA_LOG&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#===========================================================================================</span></span><br><span class="line"><span class="string"># Setting system properties</span></span><br><span class="line"><span class="string">#===========================================================================================</span></span><br><span class="line"><span class="string">JAVA_OPT=&quot;$JAVA_OPT -jar -DSpring.profiles.active=$ACTIVE $PARAM $START_PARAM $JVM_OPT $&#123;BASE_DIR&#125;/$SERVICE_NAME*.jar&quot;</span></span><br><span class="line"><span class="string">$JAVA_OPT</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  stage(<span class="string">&#x27;拉取代码&#x27;</span>)&#123;</span><br><span class="line">  echo <span class="string">&quot;git pull code&quot;</span></span><br><span class="line">  git(<span class="attr">url:</span> <span class="string">&quot;$&#123;git&#125;&quot;</span>, <span class="attr">branch:</span> <span class="string">&quot;$&#123;branch&#125;&quot;</span>, <span class="attr">credentialsId:</span> <span class="string">&quot;128ee387-1deb-4241-87ae-dfeaeaec448d&quot;</span>)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">stage(<span class="string">&#x27;编译代码&#x27;</span>)&#123;</span><br><span class="line">echo <span class="string">&quot;编译代码&quot;</span></span><br><span class="line">sh <span class="string">&quot;$&#123;mvn&#125;/bin/mvnd clean install -Dmaven.test.skip=true&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  stage(<span class="string">&#x27;构建docker镜像&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">def</span> serviceArray = <span class="string">&quot;$&#123;service&#125;&quot;</span>.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span>(serviceName <span class="keyword">in</span> serviceArray)&#123;</span><br><span class="line">        <span class="keyword">def</span> imageName = <span class="string">&quot;$&#123;baseHarborUrl&#125;/$&#123;branch&#125;/$&#123;serviceName&#125;&quot;</span></span><br><span class="line">        echo <span class="string">&quot;镜像名：$&#123;imageName&#125;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> jarPath = <span class="string">&quot;$&#123;env.WORKSPACE&#125;/$&#123;&#x27;**/&#x27; * depth.toInteger()&#125;/$&#123;serviceName&#125;/target/$&#123;serviceName&#125;*.jar&quot;</span></span><br><span class="line">        echo <span class="string">&quot;jar路径:$&#123;jarPath&#125;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> tag = <span class="string">&quot;$&#123;imageName&#125;:$&#123;version&#125;&quot;</span></span><br><span class="line">        echo <span class="string">&quot;tag is $&#123;tag&#125;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> dockerfileContent = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">FROM 101.91.198.224:30080/base-image/debian-jre-11:v1.4.0</span></span><br><span class="line"><span class="string">COPY ./$&#123;serviceName&#125;.jar /home/data/$&#123;serviceName&#125;.jar</span></span><br><span class="line"><span class="string">COPY ./startup.sh /home/data/startup.sh</span></span><br><span class="line"><span class="string">RUN chmod +x /home/data/startup.sh</span></span><br><span class="line"><span class="string">WORKDIR /home/data</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">         <span class="keyword">def</span> k8sTemplate =</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">  namespace: $&#123;branch&#125;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      imagePullSecrets:</span></span><br><span class="line"><span class="string">        - name: harbor-secret</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">        - name: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">          image: $&#123;tag&#125;</span></span><br><span class="line"><span class="string">          imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">          env:</span></span><br><span class="line"><span class="string">            - name: JAVA_LOG</span></span><br><span class="line"><span class="string">              valueFrom:</span></span><br><span class="line"><span class="string">                configMapKeyRef:</span></span><br><span class="line"><span class="string">                  name: spring-cm</span></span><br><span class="line"><span class="string">                  key: java.log</span></span><br><span class="line"><span class="string">            - name: DUMP_LOG</span></span><br><span class="line"><span class="string">              valueFrom:</span></span><br><span class="line"><span class="string">                configMapKeyRef:</span></span><br><span class="line"><span class="string">                  name: spring-cm</span></span><br><span class="line"><span class="string">                  key: dump.log</span></span><br><span class="line"><span class="string">            - name: START_PARAM</span></span><br><span class="line"><span class="string">              valueFrom:</span></span><br><span class="line"><span class="string">                configMapKeyRef:</span></span><br><span class="line"><span class="string">                  name: spring-cm</span></span><br><span class="line"><span class="string">                  key: start.param</span></span><br><span class="line"><span class="string">            - name: DEBUG_ENABLED</span></span><br><span class="line"><span class="string">              valueFrom:</span></span><br><span class="line"><span class="string">                configMapKeyRef:</span></span><br><span class="line"><span class="string">                  name: spring-cm</span></span><br><span class="line"><span class="string">                  key: debug.enabled</span></span><br><span class="line"><span class="string">          command: [&quot;/home/data/startup.sh&quot;]</span></span><br><span class="line"><span class="string">          args: [&quot;$&#123;serviceName&#125;&quot;, &quot;test&quot;]</span></span><br><span class="line"><span class="string">          resources:</span></span><br><span class="line"><span class="string">           limits:</span></span><br><span class="line"><span class="string">            cpu: 500m</span></span><br><span class="line"><span class="string">            memory: 1024Mi</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">  namespace: $&#123;branch&#125;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">  type: ClusterIP</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - name: http</span></span><br><span class="line"><span class="string">      port: 8080</span></span><br><span class="line"><span class="string">      targetPort: 8080</span></span><br><span class="line"><span class="string">    - name: debug</span></span><br><span class="line"><span class="string">      port: 10000</span></span><br><span class="line"><span class="string">      targetPort: 10000</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: networking.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: Ingress</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">  namespace: $&#123;branch&#125;</span></span><br><span class="line"><span class="string">  annotations:</span></span><br><span class="line"><span class="string">    nginx.ingress.kubernetes.io/use-regex: &quot;true&quot;</span></span><br><span class="line"><span class="string">    nginx.ingress.kubernetes.io/rewrite-target: /\$2</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  rules:</span></span><br><span class="line"><span class="string">    - host:</span></span><br><span class="line"><span class="string">      http:</span></span><br><span class="line"><span class="string">        paths:</span></span><br><span class="line"><span class="string">          - path: /$&#123;branch&#125;-$&#123;serviceName&#125;(/|\$)(.*)</span></span><br><span class="line"><span class="string">            pathType: Prefix</span></span><br><span class="line"><span class="string">            backend:</span></span><br><span class="line"><span class="string">              service:</span></span><br><span class="line"><span class="string">                name: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">                port:</span></span><br><span class="line"><span class="string">                  number: 8080</span></span><br><span class="line"><span class="string">  ingressClassName: nginx</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">        writeFile <span class="attr">file:</span> <span class="string">&quot;/tmp/$&#123;serviceName&#125;/Dockerfile&quot;</span>, <span class="attr">text:</span> dockerfileContent</span><br><span class="line">        writeFile <span class="attr">file:</span> <span class="string">&quot;/tmp/$&#123;serviceName&#125;/startup.sh&quot;</span>, <span class="attr">text:</span> startup</span><br><span class="line">        sh <span class="string">&quot;cp $&#123;jarPath&#125; /tmp/$&#123;serviceName&#125;/$&#123;serviceName&#125;.jar&quot;</span></span><br><span class="line">        <span class="keyword">def</span> app = docker.build(tag, <span class="string">&quot;-f /tmp/$&#123;serviceName&#125;/Dockerfile /tmp/$&#123;serviceName&#125;&quot;</span>)</span><br><span class="line">        imageTags += tag</span><br><span class="line">        <span class="keyword">def</span> k8sYaml = <span class="string">&quot;/tmp/$&#123;serviceName&#125;/$&#123;serviceName&#125;.yaml&quot;</span></span><br><span class="line">        writeFile <span class="attr">file:</span> k8sYaml, <span class="attr">text:</span> k8sTemplate</span><br><span class="line">        k8sTemplates += k8sYaml</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stage(<span class="string">&#x27;推送docker镜像&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(tag <span class="keyword">in</span> imageTags)&#123;</span><br><span class="line">          <span class="keyword">def</span> dockerImage = docker.image(<span class="string">&quot;$&#123;tag&#125;&quot;</span>)</span><br><span class="line">          <span class="keyword">def</span> harborCertificate = env[<span class="string">&quot;$&#123;harborUrl&#125;&quot;</span>]</span><br><span class="line">          docker.withRegistry(<span class="string">&quot;$&#123;harborUrl&#125;&quot;</span>, <span class="string">&quot;$&#123;harborCertificate&#125;&quot;</span>) &#123;</span><br><span class="line">            dockerImage.push()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   stage(<span class="string">&#x27;发布到K8s镜像&#x27;</span>)&#123;</span><br><span class="line">   <span class="keyword">def</span> k8sMasterHost = env[<span class="string">&quot;$&#123;branch&#125;_K8s_HOST&quot;</span>.toUpperCase()]</span><br><span class="line">   <span class="keyword">if</span> ((<span class="string">&quot;$&#123;branch&#125;&quot;</span>.contains(<span class="string">&quot;master&quot;</span>)))&#123;</span><br><span class="line">        <span class="keyword">for</span>(tag <span class="keyword">in</span> imageTags)&#123;</span><br><span class="line">            echo <span class="string">&quot;当前镜像版本号: $&#123;tag&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(template <span class="keyword">in</span> k8sTemplates)&#123;</span><br><span class="line">           <span class="keyword">def</span> name = template.tokenize(<span class="string">&#x27;/&#x27;</span>).last()</span><br><span class="line">           echo <span class="string">&quot;写入文件&quot;</span></span><br><span class="line">            sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                cat &quot;$&#123;template&#125;&quot; | ssh root@$&#123;k8sMasterHost&#125; &quot;cat &gt; /ddhome/k8s/$&#123;name&#125;;kubectl delete -f /ddhome/k8s/$&#123;name&#125;; kubectl apply -f /ddhome/k8s/$&#123;name&#125;&quot;</span></span><br><span class="line"><span class="string">               &quot;&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>spring-cm configMap示例</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">spring-cm</span></span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">$&#123;bransh&#125;</span></span><br><span class="line"><span class="attr">data</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">java.log</span>: <span class="string">&quot;-Xlog:gc*=debug:file=/var/log/gc.log:utctime,level,tags:filecount=30,filesize=100M&quot;</span></span><br><span class="line"> <span class="attr">dump.log</span>: <span class="string">&quot;-Xlog:gc*=debug:file=/var/log/gc.log:utctime,level,tags:filecount=30,filesize=100M&quot;</span></span><br><span class="line"> <span class="attr">debug.enabled</span>: <span class="string">&quot;y&quot;</span></span><br><span class="line"><span class="comment"> # 重写为8080的端口，单容器内部可以设置为相同，不冲突</span></span><br><span class="line"> <span class="attr">start.param</span>: <span class="string">&quot;-Dserver.port=8080&quot;</span></span><br></pre></td></tr></table></figure><p>构建结果如下</p><p><img src="https://img.fuhouyu.com/2023-04-08-143033.png" alt=""></p></li></ol><h5 id="打包部署前端js-容器化"><a href="#打包部署前端js-容器化" class="headerlink" title="打包部署前端js(容器化)"></a>打包部署前端js(容器化)</h5><ol><li><p>新建流水线项目</p></li><li><p>勾选选项参数</p><ol><li>添加选项参数git，添加代码仓地址</li><li>添加分支branch参数</li><li>添加选项参数 harborUrl，harbor镜像地址</li><li>添加选项参数 k8s_master, master主节点地址</li><li>添加文本visitPath参数，通过ingress-nginx访问的后缀url</li><li>添加选项参数buildPath</li></ol><p><img src="https://img.fuhouyu.com/2023-04-08-150731.png" alt=""></p></li></ol><p>脚本如下：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">node &#123;</span><br><span class="line">    <span class="comment">// 时间戳的版本号</span></span><br><span class="line">    <span class="keyword">def</span> version = <span class="string">&quot;v&quot;</span> + sh(<span class="attr">script:</span> <span class="string">&quot;date &#x27;+%s&#x27;&quot;</span>, <span class="attr">returnStdout:</span> <span class="literal">true</span>).trim()</span><br><span class="line">  <span class="comment">// 标签号</span></span><br><span class="line">    <span class="keyword">def</span> tag = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment">// k8s存储的yaml</span></span><br><span class="line">    <span class="keyword">def</span> k8sTemplatePath = <span class="string">&quot;/tmp/$&#123;env.JOB_NAME&#125;/$&#123;env.JOB_NAME&#125;.yaml&quot;</span></span><br><span class="line">  <span class="comment">// 可访问的url地址</span></span><br><span class="line">    <span class="keyword">def</span> path = <span class="string">&quot;$&#123;visitPath&#125;&quot;</span> ? <span class="string">&quot;$&#123;visitPath&#125;&quot;</span> : <span class="string">&quot;$&#123;env.JOB_NAME&#125;&quot;</span></span><br><span class="line">  <span class="comment">// 基本的url</span></span><br><span class="line">    <span class="keyword">def</span> baseHarborUrl = <span class="string">&quot;$&#123;harborUrl&#125;&quot;</span>.tokenize(<span class="string">&#x27;/&#x27;</span>).last()</span><br><span class="line">stage(<span class="string">&#x27;拉取代码&#x27;</span>)&#123;</span><br><span class="line">echo <span class="string">&quot;git pull code&quot;</span></span><br><span class="line">git(<span class="attr">url:</span> <span class="string">&quot;$&#123;git&#125;&quot;</span>, <span class="attr">branch:</span> <span class="string">&quot;$&#123;branch&#125;&quot;</span>, <span class="attr">credentialsId:</span> <span class="string">&quot;128ee387-1deb-4241-87ae-dfeaeaec448d&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 编译代码</span></span><br><span class="line">stage(<span class="string">&#x27;编译代码&#x27;</span>)&#123;</span><br><span class="line">echo <span class="string">&quot;编译代码&quot;</span></span><br><span class="line"><span class="keyword">if</span>(<span class="string">&quot;$&#123;branch&#125;&quot;</span> == <span class="string">&#x27;master&#x27;</span>)&#123;</span><br><span class="line">    sh <span class="string">&quot;rm -rf node_modules package-lock.json &amp;&amp; source /etc/profile &amp;&amp; npm install  --legacy-peer-deps &amp;&amp; npm run build:prod&quot;</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    sh <span class="string">&quot;rm -rf node_modules package-lock.json &amp;&amp; source /etc/profile &amp;&amp; npm install  --legacy-peer-deps &amp;&amp; npm run build:$&#123;branch&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stage(<span class="string">&#x27;构建docker镜像&#x27;</span>)&#123;</span><br><span class="line">    echo <span class="string">&quot;容器静态文件存放目录为: $path&quot;</span></span><br><span class="line">        <span class="keyword">def</span> dockerfileContent = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            FROM nginx:stable-alpine3.17</span></span><br><span class="line"><span class="string">            RUN apk add tzdata &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone \</span></span><br><span class="line"><span class="string">                    &amp;&amp; apk del tzdata</span></span><br><span class="line"><span class="string">            COPY &quot;./dist&quot; /usr/share/nginx/html/$&#123;path&#125;</span></span><br><span class="line"><span class="string">          &quot;&quot;&quot;</span></span><br><span class="line">        tag = <span class="string">&quot;$&#123;baseHarborUrl&#125;/$&#123;branch&#125;/$&#123;env.JOB_NAME&#125;:$&#123;version&#125;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> k8sTemplate = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">  namespace: $&#123;BRANCH&#125;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      imagePullSecrets:</span></span><br><span class="line"><span class="string">        - name: harbor-secret</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">        - name: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">          image: $&#123;tag&#125;</span></span><br><span class="line"><span class="string">          imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">          volumeMounts:</span></span><br><span class="line"><span class="string">            - name: resource</span></span><br><span class="line"><span class="string">              mountPath: /ddhome/resource</span></span><br><span class="line"><span class="string">            - name: log</span></span><br><span class="line"><span class="string">              mountPath: /var/log/nginx</span></span><br><span class="line"><span class="string">              subPath: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">      volumes:</span></span><br><span class="line"><span class="string">        - name: resource</span></span><br><span class="line"><span class="string">          hostPath:</span></span><br><span class="line"><span class="string">            path: /ddhome/resource</span></span><br><span class="line"><span class="string">        - name: log</span></span><br><span class="line"><span class="string">          hostPath:</span></span><br><span class="line"><span class="string">            path: /ddhome/log/nginx</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">  namespace: $&#123;BRANCH&#125;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - name: http</span></span><br><span class="line"><span class="string">      port: 80</span></span><br><span class="line"><span class="string">      targetPort: 80</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: networking.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: Ingress</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">  namespace: $&#123;branch&#125;</span></span><br><span class="line"><span class="string">  annotations:</span></span><br><span class="line"><span class="string">    nginx.ingress.kubernetes.io/use-regex: &quot;true&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  rules:</span></span><br><span class="line"><span class="string">    - host:</span></span><br><span class="line"><span class="string">      http:</span></span><br><span class="line"><span class="string">        paths:</span></span><br><span class="line"><span class="string">          - path: /$&#123;path&#125;</span></span><br><span class="line"><span class="string">            pathType: Prefix</span></span><br><span class="line"><span class="string">            backend:</span></span><br><span class="line"><span class="string">              service:</span></span><br><span class="line"><span class="string">                name: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">                port:</span></span><br><span class="line"><span class="string">                  number: 80</span></span><br><span class="line"><span class="string">  ingressClassName: nginx</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        writeFile <span class="attr">file:</span> <span class="string">&quot;/tmp/$&#123;env.JOB_NAME&#125;/Dockerfile&quot;</span>, <span class="attr">text:</span> dockerfileContent</span><br><span class="line">        sh <span class="string">&quot;cp -rf ./$&#123;buildPath&#125; /tmp/$&#123;env.JOB_NAME&#125;/dist&quot;</span></span><br><span class="line">        <span class="keyword">def</span> app = docker.build(tag, <span class="string">&quot;-f /tmp/$&#123;env.JOB_NAME&#125;/Dockerfile /tmp/$&#123;env.JOB_NAME&#125;&quot;</span>)</span><br><span class="line">        sh <span class="string">&quot;rm -rf /tmp/$&#123;env.JOB_NAME&#125;/dist&quot;</span></span><br><span class="line">        writeFile <span class="attr">file:</span> k8sTemplatePath, <span class="attr">text:</span> k8sTemplate</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stage(<span class="string">&#x27;推送镜像&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">def</span> dockerImage = docker.image(<span class="string">&quot;$&#123;tag&#125;&quot;</span>)</span><br><span class="line">        docker.withRegistry(<span class="string">&quot;$&#123;harborUrl&#125;&quot;</span>, <span class="string">&quot;1ecaf8ab-14ad-4890-befd-b58c178e1b61&quot;</span>) &#123;</span><br><span class="line">        dockerImage.push()</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stage(<span class="string">&#x27;发布k8s集群&#x27;</span>)&#123;</span><br><span class="line">           <span class="keyword">if</span> ((<span class="string">&quot;$&#123;branch&#125;&quot;</span>.contains(<span class="string">&quot;master&quot;</span>)))&#123;</span><br><span class="line">            echo <span class="string">&quot;当前镜像版本号: $&#123;tag&#125;&quot;</span></span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="keyword">def</span> name = k8sTemplatePath.tokenize(<span class="string">&#x27;/&#x27;</span>).last()</span><br><span class="line">                  sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                       cat &quot;$&#123;k8sTemplatePath&#125;&quot; | ssh root@$&#123;k8s_master&#125; &quot;cat &gt; /ddhome/k8s/$&#123;name&#125;;kubectl delete -f /ddhome/k8s/$&#123;name&#125;; kubectl apply -f /ddhome/k8s/$&#123;name&#125;&quot;</span></span><br><span class="line"><span class="string">                      &quot;&quot;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">           &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>安装如下：</p><p><img src="https://img.fuhouyu.com/2023-04-08-150551.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Jenkins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes 使用nfs作为存储卷</title>
      <link href="/2023/04/08/Linux/Kubernetes%20%E9%83%A8%E7%BD%B2%E5%AD%98%E5%82%A8%E5%8D%B7/"/>
      <url>/2023/04/08/Linux/Kubernetes%20%E9%83%A8%E7%BD%B2%E5%AD%98%E5%82%A8%E5%8D%B7/</url>
      
        <content type="html"><![CDATA[<ul><li><p>Kubernetes 不包含内部 NFS 配置器。需要使用外部配置程序来创建 NFS 存储类</p><p><a href="[GitHub - kubernetes-sigs/nfs-subdir-external-provisioner：远程 NFS 服务器上的动态 sub-dir volume provisioner。](https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">NFS外部配置程序</a>)</p></li></ul><h5 id="安装nfs-server"><a href="#安装nfs-server" class="headerlink" title="安装nfs-server"></a>安装nfs-server</h5><h6 id="安装-启动nfs-server"><a href="#安装-启动nfs-server" class="headerlink" title="安装/启动nfs-server"></a>安装/启动nfs-server</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装nfs-utils</span></span><br><span class="line">yum install nfs-utils</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动nfs服务器</span></span><br><span class="line">systemctl restart nfs-server</span><br></pre></td></tr></table></figure><h6 id="设置共享目录"><a href="#设置共享目录" class="headerlink" title="设置共享目录"></a>设置共享目录</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/exports</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如下</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/ddhome *(rw,<span class="built_in">sync</span>,no_subtree_check)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数说明</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/ddhome 文件系统路径，</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">* 表示所有ip都可以访问该nfs</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rw 读写权限</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">sync</span> 同步方式，也可以使用async</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no_subtree_check 禁止检查子目录的权限</span></span><br></pre></td></tr></table></figure><ul><li>完毕后，重启nfs-server。<code>systemctl restart nfs-server</code></li></ul><h5 id="部署rbac"><a href="#部署rbac" class="headerlink" title="部署rbac"></a>部署rbac</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><h5 id="部署nfs-client"><a href="#部署nfs-client" class="headerlink" title="部署nfs-client"></a>部署nfs-client</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.k8s.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">k8s-sigs.io/nfs-subdir-external-provisioner</span> <span class="comment"># 这里的名称需要与storageclass中的provisioner名称一致</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&lt;nfs服务器地址&gt;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&lt;nfs存储的地址&gt;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="string">&lt;nfs服务器地址&gt;</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">&lt;nfs存储的地址&gt;</span></span><br></pre></td></tr></table></figure><h5 id="部署storageClass"><a href="#部署storageClass" class="headerlink" title="部署storageClass"></a>部署storageClass</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">config-nfs</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">k8s-sigs.io/nfs-subdir-external-provisioner</span> <span class="comment"># 这里的名称需要与nfs-client中的provisioner名称一致</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span> <span class="comment"># 保留卷</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="comment"># 这里可以指定nfs中的路径</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/ddhome/nfs/resource</span></span><br><span class="line">  <span class="comment"># 是否归档，如果为true，则在pvc删除之前，会将内容存档到一个tar文件中</span></span><br><span class="line">  <span class="attr">archiveOnDelete:</span> <span class="string">&quot;false&quot;</span></span><br></pre></td></tr></table></figure><h5 id="部署pvc"><a href="#部署pvc" class="headerlink" title="部署pvc"></a>部署pvc</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">config-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">config-nfs</span> <span class="comment"># storageClass中的名称</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span> <span class="comment"># 卷可以被一个节点以读写方式挂载。 ReadWriteOnce 访问模式也允许运行在同一节点上的多个 Pod 访问卷。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadOnlyMany</span> <span class="comment"># 卷可以被多个节点以只读方式挂载。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span> <span class="comment"># 卷可以被多个节点以读写方式挂载。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOncePod</span> <span class="comment"># 卷可以被单个 Pod 以读写方式挂载。 如果你想确保整个集群中只有一个 Pod 可以读取或写入该 PVC， 请使用 ReadWriteOncePod 访问模式。这只支持 CSI 卷以及需要 Kubernetes 1.22 以上版本</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">2Gi</span> <span class="comment"># 分配2Gi大小</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>powerdns 安装</title>
      <link href="/2023/02/09/Linux/powerdns/"/>
      <url>/2023/02/09/Linux/powerdns/</url>
      
        <content type="html"><![CDATA[<h4 id="更新软件源，安装软件"><a href="#更新软件源，安装软件" class="headerlink" title="更新软件源，安装软件"></a>更新软件源，安装软件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装epel源</span></span><br><span class="line">yum install -y epel-release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装pdns</span></span><br><span class="line">yum install -y pdns pdns-backend-mysql pdns-recursor mariadb-server mysql</span><br></pre></td></tr></table></figure><h4 id="启动数据库，导入表结构"><a href="#启动数据库，导入表结构" class="headerlink" title="启动数据库，导入表结构"></a>启动数据库，导入表结构</h4><h5 id="启动数据库"><a href="#启动数据库" class="headerlink" title="启动数据库"></a>启动数据库</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动mariadb</span></span><br><span class="line">systemctl start mariadb</span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb</span><br></pre></td></tr></table></figure><h5 id="导入数据表结构"><a href="#导入数据表结构" class="headerlink" title="导入数据表结构"></a>导入数据表结构</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入数据表结构</span></span><br><span class="line">CREATE DATABASE powerdns;</span><br><span class="line"></span><br><span class="line">GRANT ALL ON powerdns.* TO &#x27;powerdns&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;powerdns&#x27;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line">use powerdns;</span><br><span class="line"></span><br><span class="line">CREATE TABLE domains (</span><br><span class="line">  id                    INT AUTO_INCREMENT,</span><br><span class="line">  name                  VARCHAR(255) NOT NULL,</span><br><span class="line">  master                VARCHAR(128) DEFAULT NULL,</span><br><span class="line">  last_check            INT DEFAULT NULL,</span><br><span class="line">  type                  VARCHAR(6) NOT NULL,</span><br><span class="line">  notified_serial       INT DEFAULT NULL,</span><br><span class="line">  account               VARCHAR(40) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE UNIQUE INDEX name_index ON domains(name);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE records (</span><br><span class="line">  id                    BIGINT AUTO_INCREMENT,</span><br><span class="line">  domain_id             INT DEFAULT NULL,</span><br><span class="line">  name                  VARCHAR(255) DEFAULT NULL,</span><br><span class="line">  type                  VARCHAR(10) DEFAULT NULL,</span><br><span class="line">  content               VARCHAR(64000) DEFAULT NULL,</span><br><span class="line">  ttl                   INT DEFAULT NULL,</span><br><span class="line">  prio                  INT DEFAULT NULL,</span><br><span class="line">  change_date           INT DEFAULT NULL,</span><br><span class="line">  disabled              TINYINT(1) DEFAULT 0,</span><br><span class="line">  ordername             VARCHAR(255) BINARY DEFAULT NULL,</span><br><span class="line">  auth                  TINYINT(1) DEFAULT 1,</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE INDEX nametype_index ON records(name,type);</span><br><span class="line">CREATE INDEX domain_id ON records(domain_id);</span><br><span class="line">CREATE INDEX recordorder ON records (domain_id, ordername);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE supermasters (</span><br><span class="line">  ip                    VARCHAR(64) NOT NULL,</span><br><span class="line">  nameserver            VARCHAR(255) NOT NULL,</span><br><span class="line">  account               VARCHAR(40) NOT NULL,</span><br><span class="line">  PRIMARY KEY (ip, nameserver)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE comments (</span><br><span class="line">  id                    INT AUTO_INCREMENT,</span><br><span class="line">  domain_id             INT NOT NULL,</span><br><span class="line">  name                  VARCHAR(255) NOT NULL,</span><br><span class="line">  type                  VARCHAR(10) NOT NULL,</span><br><span class="line">  modified_at           INT NOT NULL,</span><br><span class="line">  account               VARCHAR(40) NOT NULL,</span><br><span class="line">  comment               VARCHAR(64000) NOT NULL,</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE INDEX comments_domain_id_idx ON comments (domain_id);</span><br><span class="line">CREATE INDEX comments_name_type_idx ON comments (name, type);</span><br><span class="line">CREATE INDEX comments_order_idx ON comments (domain_id, modified_at);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE domainmetadata (</span><br><span class="line">  id                    INT AUTO_INCREMENT,</span><br><span class="line">  domain_id             INT NOT NULL,</span><br><span class="line">  kind                  VARCHAR(32),</span><br><span class="line">  content               TEXT,</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE INDEX domainmetadata_idx ON domainmetadata (domain_id, kind);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE cryptokeys (</span><br><span class="line">  id                    INT AUTO_INCREMENT,</span><br><span class="line">  domain_id             INT NOT NULL,</span><br><span class="line">  flags                 INT NOT NULL,</span><br><span class="line">  active                BOOL,</span><br><span class="line">  content               TEXT,</span><br><span class="line">  PRIMARY KEY(id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE INDEX domainidindex ON cryptokeys(domain_id);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE tsigkeys (</span><br><span class="line">  id                    INT AUTO_INCREMENT,</span><br><span class="line">  name                  VARCHAR(255),</span><br><span class="line">  algorithm             VARCHAR(50),</span><br><span class="line">  secret                VARCHAR(255),</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE UNIQUE INDEX namealgoindex ON tsigkeys(name, algorithm);</span><br></pre></td></tr></table></figure><h4 id="配置pdns"><a href="#配置pdns" class="headerlink" title="配置pdns"></a>配置pdns</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置pdns</span></span><br><span class="line">vim /etc/pdns/pdns.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新如下内容</span></span><br><span class="line">launch=gmysql</span><br><span class="line">gmysql-host=127.0.0.1</span><br><span class="line">gmysql-user=powerdns</span><br><span class="line">gmysql-password=powerdns</span><br><span class="line">gmysql-dbname=powerdns</span><br><span class="line">local-port=5300</span><br><span class="line">max-tcp-connections=200</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动pdns</span></span><br><span class="line">systemctl start pdns</span><br><span class="line">systemctl <span class="built_in">enable</span> pdns</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置pdns-recursor</span></span><br><span class="line">vim /etc/pdns-recursor/recursor.conf</span><br><span class="line">...</span><br><span class="line">allow-from=0.0.0.0/0</span><br><span class="line">daemon=<span class="built_in">yes</span></span><br><span class="line"><span class="comment">## 指定指定域名解析地址</span></span><br><span class="line">forward-zones-file=/etc/pdns-recursor/zone</span><br><span class="line"><span class="comment">## 向上递归dns地址，根域</span></span><br><span class="line">forward-zones-recurse=.=114.114.114.114  </span><br><span class="line">local-address=0.0.0.0</span><br><span class="line">local-port=53</span><br><span class="line"></span><br><span class="line">vim /etc/pdns-recursor/zone</span><br><span class="line"><span class="comment">## 拦截两个域名的解析</span></span><br><span class="line">sysadmin.com=127.0.0.1:5300</span><br><span class="line">ops.com=127.0.0.1:5300</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动pdns-recursor</span></span><br><span class="line">systemctl start pdns-recursor</span><br><span class="line">systemctl <span class="built_in">enable</span> pdns-recursor</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装poweradmin</span></span><br><span class="line">yum install -y httpd php php-mcrypt php-pdo php-mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将php文件解压到/var/www/html下</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动httpd</span></span><br><span class="line">systemctl start httpd</span><br><span class="line">systemctl <span class="built_in">enable</span> httpd</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>访问 <a href="http://ip:port/install">http://ip:port/install</a> 进行相关配置</li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Centos </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
