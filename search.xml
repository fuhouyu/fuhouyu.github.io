<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Kubernetes 部署EFK</title>
      <link href="/2023/04/29/Linux/Kubernetes-%E9%83%A8%E7%BD%B2EFK/"/>
      <url>/2023/04/29/Linux/Kubernetes-%E9%83%A8%E7%BD%B2EFK/</url>
      
        <content type="html"><![CDATA[<h4 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h4><h5 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h5><p><a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-deploy-eck.html">部署操作员</a></p><ol><li><h5 id="storageclass"><a href="#storageclass" class="headerlink" title="storageclass"></a>storageclass</h5></li></ol><p>部署EFK时，需要有存储卷来对es中的数据进行存储，可以在nodeSets中指定storageClassName，也可以直接使用默认的storageclass</p><ul><li><a href="https://fuhouyu.com/2023/04/08/Linux/Kubernetes 部署存储卷/">部署存储卷</a></li><li>修改默认值</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取storageclass</span></span><br><span class="line">kubectl get sc </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使storageclass为默认存储</span></span><br><span class="line">kubectl patch &lt;替换为storageclass名称&gt; -p &#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure><ul><li><a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-volume-claim-templates.html">官方文档</a></li></ul><h4 id="部署Elasticsearch"><a href="#部署Elasticsearch" class="headerlink" title="部署Elasticsearch"></a>部署Elasticsearch</h4><h5 id="设置用户名、密码"><a href="#设置用户名、密码" class="headerlink" title="设置用户名、密码"></a>设置用户名、密码</h5><p>在不创建账户时，默认账户为elastic，密码要通过k8s的文档获取随机生成的密码项，详情查看<a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-users-and-roles.html">官方文档</a></p><p>这里使用文本领域创建，使用官方给的docker示例进行创建</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir filerealm</span><br><span class="line">touch filerealm/users filerealm/users_roles</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">superuser是elasticsearch中的超管角色</span></span><br><span class="line">docker run  --name es-user \</span><br><span class="line">    -v $(pwd)/filerealm:/usr/share/elasticsearch/config \</span><br><span class="line">    docker.elastic.co/elasticsearch/elasticsearch:8.7.0 \</span><br><span class="line">    bin/elasticsearch-users useradd &lt;myuser&gt; -p &lt;mypassword&gt; -r superuser</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">create a Kubernetes secret with the file realm content</span></span><br><span class="line">kubectl create secret generic es-secret --from-file filerealm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除容器</span></span><br><span class="line">docker stop es-user &amp;&amp; docker rm es-user</span><br></pre></td></tr></table></figure><p>在yaml中启用</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">elasticsearch.k8s.elastic.co/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Elasticsearch</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">8.7</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">auth:</span></span><br><span class="line">    <span class="attr">fileRealm:</span></span><br><span class="line">    <span class="comment"># 上面创建的密钥名称</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">secretName:</span> <span class="string">es-secret</span></span><br><span class="line">  <span class="attr">nodeSets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">count:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">node.store.allow_mmap:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">podTemplate:</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ES_JAVA_OPTS</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">-Xms1g</span> <span class="string">-Xmx1g</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">2Gi</span></span><br></pre></td></tr></table></figure><h4 id="部署Kibana"><a href="#部署Kibana" class="headerlink" title="部署Kibana"></a>部署Kibana</h4><h5 id="yaml"><a href="#yaml" class="headerlink" title="yaml"></a>yaml</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kibana.k8s.elastic.co/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kibana</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">8.7</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">count:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">elasticsearchRef:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="comment"># 设置NodePort，暴露出5601端口</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">   <span class="attr">service:</span> </span><br><span class="line">    <span class="attr">spec:</span> </span><br><span class="line">     <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">     <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">5601</span></span><br><span class="line">        <span class="attr">nodePort:</span> <span class="number">35601</span></span><br><span class="line">  <span class="attr">config:</span> </span><br><span class="line">   <span class="comment"># 配置中文</span></span><br><span class="line">   <span class="attr">i18n.locale:</span> <span class="string">&quot;zh-CN&quot;</span></span><br></pre></td></tr></table></figure><h4 id="部署APM-server"><a href="#部署APM-server" class="headerlink" title="部署APM server"></a>部署APM server</h4><h5 id="yaml-1"><a href="#yaml-1" class="headerlink" title="yaml"></a>yaml</h5><ul><li>如果只考虑k8s中的服务，也可以不暴露NodePort，通过无头服务进行访问处理</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apm.k8s.elastic.co/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ApmServer</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">apm-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">8.7</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">count:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">   <span class="attr">service:</span> </span><br><span class="line">    <span class="attr">spec:</span> </span><br><span class="line">     <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">     <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8200</span></span><br><span class="line">        <span class="attr">nodePort:</span> <span class="number">30082</span></span><br><span class="line"><span class="comment"># 这里的es的名称，需要es的相同</span></span><br><span class="line">  <span class="attr">elasticsearchRef:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br></pre></td></tr></table></figure><h5 id="在Kibana中添加APM集成"><a href="#在Kibana中添加APM集成" class="headerlink" title="在Kibana中添加APM集成"></a>在Kibana中添加APM集成</h5><p><img src="https://img.fuhouyu.com/2023-04-29-154055.png" alt=""></p><p>添加APM集成，设置APM集成的名称和url以提供后续其他工程使用</p><p><img src="https://img.fuhouyu.com/2023-04-29-154248.png" alt=""></p><p>主机的url设置可以正常内网或外网访问的地址项。</p><h5 id="添加Java-Agent"><a href="#添加Java-Agent" class="headerlink" title="添加Java Agent"></a>添加Java Agent</h5><p><img src="https://img.fuhouyu.com/2023-04-29-154645.jpg" alt=""></p><p>最终可以在APM中看到可访问的服务</p><p><img src="https://img.fuhouyu.com/2023-04-29-154818.png" alt=""></p><h4 id="部署filebeat"><a href="#部署filebeat" class="headerlink" title="部署filebeat"></a>部署filebeat</h4><ul><li>服务部署到容器，通过logback记录到本地的日志文件中。通过filebeat收集，添加到es中，方便日志的统一收集，管理。</li></ul><h5 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h5><ol><li>es部署时，需要通过TLS才能进行访问，需要获取es中的证书文件。</li><li>filebeat记录的日志文件，需要在kibana中设置索引模板，使用默认的模板会选成多余无用索引的情况</li></ol><h5 id="获取上文中部署的es证书文件"><a href="#获取上文中部署的es证书文件" class="headerlink" title="获取上文中部署的es证书文件"></a>获取上文中部署的es证书文件</h5><p>从容器中获取ca.crt,tls.key,tls.crt三个文件。</p><p>在<code>/usr/share/elasticsearch/config/http-certs/</code>目录下，可以看到建立了软链接</p><p><img src="https://img.fuhouyu.com/2023-04-29-161112.png" alt=""></p><p>通过kubectl cp 将该文件复制出来。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">cp</span> elasticsearch-es-default-0:/usr/share/elasticsearch/config/http-certs/..2023_04_29_02_59_34.819982638 /ddhome/nfs/es-cert</span><br></pre></td></tr></table></figure><h5 id="Kibana中添加索引模板"><a href="#Kibana中添加索引模板" class="headerlink" title="Kibana中添加索引模板"></a>Kibana中添加索引模板</h5><p>左侧栏中选择Management，在<em>数据项</em>中选项<em>索引管理</em></p><p><img src="https://img.fuhouyu.com/2023-04-29-162425.png" alt=""></p><p>创建一个新的模板，起名为<code>service-log</code>，注意在索引模式中，需要设置接收的索引。只有设置了这类的索引，才会进行数据流入。</p><p><img src="https://img.fuhouyu.com/2023-04-29-162628.png" alt=""></p><p>组件模板默认，在索引设置中，添加如下json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;lifecycle&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mapping&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;total_fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10000&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_docvalue_fields_search&quot;</span><span class="punctuation">:</span> <span class="string">&quot;200&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;default_field&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;message&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;fields.log.level&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;fields.service&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>最后设置映射如下，其它默认</p><p><img src="https://img.fuhouyu.com/2023-04-29-162715.png" alt=""></p><h5 id="filebeat-cm-yaml"><a href="#filebeat-cm-yaml" class="headerlink" title="filebeat-cm.yaml"></a>filebeat-cm.yaml</h5><ul><li>使用configMap设置日志相关配置</li><li>在logback的配置中，日志文件已区分INFO和ERROR，记录为两个独立的日志文件，所以这里的输入写成两个，作为日志的索引项</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-config</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">filebeat.yml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    filebeat.inputs:</span></span><br><span class="line"><span class="string">      - type: log</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">        paths:</span></span><br><span class="line"><span class="string">          - /var/log/service-gateway/*info*.log</span></span><br><span class="line"><span class="string">        # 编码格式</span></span><br><span class="line"><span class="string">        encoding: utf-8</span></span><br><span class="line"><span class="string">        # 日志匹配</span></span><br><span class="line"><span class="string">        multiline.pattern: ^\s*\d\d\d\d-\d\d-\d\d</span></span><br><span class="line"><span class="string">        # 多行日志事件形状不匹配的行，作为新的日志事项</span></span><br><span class="line"><span class="string">        multiline.negate: true</span></span><br><span class="line"><span class="string">        # 与第一个匹配的行之后的所有行相关联到同一个多行事件中</span></span><br><span class="line"><span class="string">        multiline.match: after</span></span><br><span class="line"><span class="string">        fields:</span></span><br><span class="line"><span class="string">          # log.level设置为INFO</span></span><br><span class="line"><span class="string">          log.level: INFO</span></span><br><span class="line"><span class="string">          # 服务设置为Java启动的服务名称，方便筛选</span></span><br><span class="line"><span class="string">          service: service-gateway</span></span><br><span class="line"><span class="string">      - type: log</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">        paths:</span></span><br><span class="line"><span class="string">          - /var/log/service-gateway/*error*.log</span></span><br><span class="line"><span class="string">        encoding: utf-8</span></span><br><span class="line"><span class="string">        multiline.pattern: ^\s*\d\d\d\d-\d\d-\d\d</span></span><br><span class="line"><span class="string">        multiline.negate: true</span></span><br><span class="line"><span class="string">        multiline.match: after</span></span><br><span class="line"><span class="string">        fields:</span></span><br><span class="line"><span class="string">          log.level: ERROR</span></span><br><span class="line"><span class="string">          service: service-gateway</span></span><br><span class="line"><span class="string">    # 输出到es配置</span></span><br><span class="line"><span class="string">    output.elasticsearch:</span></span><br><span class="line"><span class="string">      enabled: true</span></span><br><span class="line"><span class="string">      hosts: [&#x27;https://$&#123;ELASTICSEARCH_HOST:elasticsearch&#125;:$&#123;ELASTICSEARCH_PORT:9200&#125;&#x27;]</span></span><br><span class="line"><span class="string">      username: $&#123;ELASTICSEARCH_USERNAME&#125;</span></span><br><span class="line"><span class="string">      password: $&#123;ELASTICSEARCH_PASSWORD&#125;</span></span><br><span class="line"><span class="string">      # 上面获取到的ssl证书相关配置</span></span><br><span class="line"><span class="string">      ssl.key: /data/cert/elasticsearch-es-default-0.tls.key</span></span><br><span class="line"><span class="string">      ssl.certificate: /data/cert/elasticsearch-es-default-0.tls.crt</span></span><br><span class="line"><span class="string">      ssl.certificate_authorities: /data/cert/ca.crt</span></span><br><span class="line"><span class="string">      # 索引，需要在索引模板的索引模式中匹配才行</span></span><br><span class="line"><span class="string">      index: &quot;service-log&quot;</span></span><br><span class="line"><span class="string">    setup.ilm.enabled: false</span></span><br><span class="line"><span class="string">    # 模板名称</span></span><br><span class="line"><span class="string">    setup.template.name: service-log</span></span><br><span class="line"><span class="string">    setup.template.pattern: service-log</span></span><br></pre></td></tr></table></figure><h5 id="filebeat-yaml"><a href="#filebeat-yaml" class="headerlink" title="filebeat.yaml"></a>filebeat.yaml</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>] <span class="comment"># &quot;&quot; indicates the core API group</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">replicasets</span></span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;batch&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">jobs</span></span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="comment"># should be the namespace where filebeat is running</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">coordination.k8s.io</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">leases</span></span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-kubeadm-config</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="attr">resourceNames:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">kubeadm-config</span></span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-kubeadm-config</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-kubeadm-config</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">filebeat</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">docker.elastic.co/beats/filebeat:8.7.0</span></span><br><span class="line">          <span class="attr">args:</span> [</span><br><span class="line">            <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;/etc/filebeat.yml&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-e&quot;</span>,</span><br><span class="line">          ]</span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTICSEARCH_HOST</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">elasticsearch-es-http</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTICSEARCH_PORT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;9200&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTICSEARCH_USERNAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&lt;username&gt;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTICSEARCH_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&lt;password&gt;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">            <span class="comment"># If using Red Hat OpenShift uncomment this:</span></span><br><span class="line">            <span class="comment">#privileged: true</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/filebeat.yml</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">filebeat.yml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/usr/share/filebeat/data</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cert</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data/cert</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">0640</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">filebeat-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">        <span class="comment"># 挂载服务日志，可以使用nfs，或者storageclass</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/ddhome/log/service/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/lib/filebeat-data</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">        <span class="comment"># 挂载证书文件。可以使用nfs，或者storageclass</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cert</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/ddhome/nfs/es-cert</span></span><br></pre></td></tr></table></figure><h5 id="执行yaml"><a href="#执行yaml" class="headerlink" title="执行yaml"></a>执行yaml</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f filebeat-cm.yaml</span><br><span class="line">kubectl apply -f filebeat.yaml</span><br></pre></td></tr></table></figure><p>等待容器启动完成如下</p><p><img src="https://img.fuhouyu.com/2023-04-29-163233.png" alt=""></p><h4 id="创建数据视图"><a href="#创建数据视图" class="headerlink" title="创建数据视图"></a>创建数据视图</h4><ul><li>先在文件中写入任一日志，如http请求等</li><li>在kibana中，创建数据视频，选择索引模式的匹配项</li></ul><p><img src="https://img.fuhouyu.com/2023-04-29-163523.png" alt=""></p><p>响应后的日志如下图所示</p><p><img src="https://img.fuhouyu.com/2023-04-29-163600.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义Docker镜像引起的Java请求https证书问题</title>
      <link href="/2023/04/25/Java/%E8%87%AA%E5%AE%9A%E4%B9%89Docker%E9%95%9C%E5%83%8F%E5%BC%95%E8%B5%B7%E7%9A%84Java%E8%AF%B7%E6%B1%82https%E8%AF%81%E4%B9%A6%E9%97%AE%E9%A2%98/"/>
      <url>/2023/04/25/Java/%E8%87%AA%E5%AE%9A%E4%B9%89Docker%E9%95%9C%E5%83%8F%E5%BC%95%E8%B5%B7%E7%9A%84Java%E8%AF%B7%E6%B1%82https%E8%AF%81%E4%B9%A6%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>Java 在通过RestTemplate请求https的请求时，出现证书的错误，报错如下：</p><p><img src="https://img.fuhouyu.com/2023-04-25-134454.png" alt=""></p><p>正常的请求是会返回一个Json对象，然而现在的请求的结果是：PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target。</p><p>翻译可知， java在请求https的请求时，需要构建证书，但是现在无法找到有效的证书路径，导致了该错误。</p><p>在Google了一下后，需要通过keytool进行证书的导入，或直接忽略掉ssl的安全项。</p><p><em>但该问题在Docker镜像更换前，并未出现。所以先排查下Docker的基础镜像。</em></p><h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><ul><li>原先的基础镜像使用的是openjdk11，在该基础镜像上，并没有出现过ssl证书的问题。</li><li>在后续的版本中，docker基础镜像修改为debian11，也就出现了该问题。</li></ul><p>在查看openjdk的官方镜像时，看到这样的步骤。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/bin/sh -c <span class="built_in">set</span> -eux; <span class="built_in">arch</span>=<span class="string">&quot;<span class="subst">$(dpkg --print-architecture)</span>&quot;</span>; <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$arch</span>&quot;</span> <span class="keyword">in</span> <span class="string">&#x27;amd64&#x27;</span>) downloadUrl=<span class="string">&#x27;https://download.java.net/java/early_access/jdk21/19/GPL/openjdk-21-ea+19_linux-x64_bin.tar.gz&#x27;</span>; downloadSha256=<span class="string">&#x27;5af95497753fbc33981f5ab1267fbd3be57e4095ceca9806490a25b56f819007&#x27;</span>; ;; <span class="string">&#x27;arm64&#x27;</span>) downloadUrl=<span class="string">&#x27;https://download.java.net/java/early_access/jdk21/19/GPL/openjdk-21-ea+19_linux-aarch64_bin.tar.gz&#x27;</span>; downloadSha256=<span class="string">&#x27;d08fe17feea7fa18c4e9ee9918496974d0194d1fac9a485d47cc2d30601c3682&#x27;</span>; ;; *) <span class="built_in">echo</span> &gt;&amp;2 <span class="string">&quot;error: unsupported architecture: &#x27;<span class="variable">$arch</span>&#x27;&quot;</span>; <span class="built_in">exit</span> 1 ;; <span class="keyword">esac</span>; savedAptMark=<span class="string">&quot;<span class="subst">$(apt-mark showmanual)</span>&quot;</span>; apt-get update; apt-get install -y --no-install-recommends wget ; </span><br><span class="line"><span class="built_in">rm</span> -rf /var/lib/apt/lists/*; </span><br><span class="line">wget --progress=dot:giga -O openjdk.tgz <span class="string">&quot;<span class="variable">$downloadUrl</span>&quot;</span>;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$downloadSha256</span> *openjdk.tgz&quot;</span> | <span class="built_in">sha256sum</span> --strict --check -;</span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$JAVA_HOME</span>&quot;</span>; tar --extract --file openjdk.tgz --directory <span class="string">&quot;<span class="variable">$JAVA_HOME</span>&quot;</span> --strip-components 1 --no-same-owner ; </span><br><span class="line"><span class="built_in">rm</span> openjdk.tgz*; apt-mark auto <span class="string">&#x27;.*&#x27;</span> &gt; /dev/null; [ -z <span class="string">&quot;<span class="variable">$savedAptMark</span>&quot;</span> ] || apt-mark manual <span class="variable">$savedAptMark</span> &gt; /dev/null; apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=<span class="literal">false</span>; &#123; <span class="built_in">echo</span> <span class="string">&#x27;#!/usr/bin/env bash&#x27;</span>; <span class="built_in">echo</span> <span class="string">&#x27;set -Eeuo pipefail&#x27;</span>; <span class="built_in">echo</span> <span class="string">&#x27;trust extract --overwrite --format=java-cacerts --filter=ca-anchors --purpose=server-auth &quot;$JAVA_HOME/lib/security/cacerts&quot;&#x27;</span>; &#125; &gt; /etc/ca-certificates/update.d/docker-openjdk; <span class="built_in">chmod</span> +x /etc/ca-certificates/update.d/docker-openjdk; /etc/ca-certificates/update.d/docker-openjdk; find <span class="string">&quot;<span class="variable">$JAVA_HOME</span>/lib&quot;</span> -name <span class="string">&#x27;*.so&#x27;</span> -<span class="built_in">exec</span> <span class="built_in">dirname</span> <span class="string">&#x27;&#123;&#125;&#x27;</span> <span class="string">&#x27;;&#x27;</span> | <span class="built_in">sort</span> -u &gt; /etc/ld.so.conf.d/docker-openjdk.conf; ldconfig; java -Xshare:dump; fileEncoding=<span class="string">&quot;<span class="subst">$(echo &#x27;System.out.println(System.getProperty(<span class="string">&quot;file.encoding&quot;</span>)</span>)&#x27; | jshell -s -)&quot;</span>; [ <span class="string">&quot;<span class="variable">$fileEncoding</span>&quot;</span> = <span class="string">&#x27;UTF-8&#x27;</span> ]; <span class="built_in">rm</span> -rf ~/.java; javac --version; java --version</span><br></pre></td></tr></table></figure><blockquote><p> <img src="https://img.fuhouyu.com/2023-04-25-142142.png" alt=""></p><p>在这个命令中，从系统的存储库提取证书后，生成了一个新的keystore文件，并放入到Java的<code>$JAVA_HOME/lib/security/cacerts</code>的路径中，以此来保证ssl/tls的正常使用。</p></blockquote><h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>根据上面查询到的命令，最终的dockerfile如下</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:<span class="number">11.6</span>-slim as jre</span><br><span class="line"><span class="keyword">ENV</span> AMD_DOWNLOAD_URL=https://github.com/AdoptOpenJDK/openjdk11-upstream-binaries/releases/download/jdk-<span class="number">11.0</span>.<span class="number">16</span>%<span class="number">2</span>B8/OpenJDK11U-jdk-shenandoah_x64_linux_11.<span class="number">0.16</span>_8.tar.gz</span><br><span class="line"><span class="keyword">ENV</span> ARM_DOWNLOAD_URL=https://github.com/AdoptOpenJDK/openjdk11-upstream-binaries/releases/download/jdk-<span class="number">11.0</span>.<span class="number">16</span>%<span class="number">2</span>B8/OpenJDK11U-jdk-shenandoah_aarch64_linux_11.<span class="number">0.16</span>_8.tar.gz</span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=/usr/local/jdk</span><br><span class="line"><span class="keyword">ENV</span> PATH=$&#123;JAVA_HOME&#125;/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> \</span></span><br><span class="line"><span class="language-bash">    <span class="comment"># 软件源配置</span></span></span><br><span class="line">    sed -i <span class="string">&#x27;s#deb.debian.org#mirrors.tuna.tsinghua.edu.cn#g&#x27;</span> /etc/apt/sources.list; \</span><br><span class="line">    apt update &amp;&amp; apt install  -y --no-install-recommends  binutils curl wget vim fontconfig libfreetype6 ca-certificates p11-kit; apt-get clean; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*;\</span><br><span class="line">    <span class="comment"># 下载jdk</span></span><br><span class="line">    /bin/sh -c set -eux; arch=<span class="string">&quot;$(dpkg --print-architecture)&quot;</span>; case <span class="string">&quot;$arch&quot;</span> in <span class="string">&#x27;amd64&#x27;</span>) downloadUrl=<span class="string">&quot;$&#123;AMD_DOWNLOAD_URL&#125;&quot;</span>; ;; <span class="string">&#x27;arm64&#x27;</span>) downloadUrl=<span class="string">&quot;$&#123;ARM_DOWNLOAD_URL&#125;&quot;</span>; ;; *) echo &gt;&amp;<span class="number">2</span> <span class="string">&quot;error: unsupported architecture: &#x27;$arch&#x27;&quot;</span>; exit <span class="number">1</span> ;; esac; wget --progress=dot:giga -O openjdk.tgz <span class="string">&quot;$downloadUrl&quot;</span>; mkdir -p <span class="string">&quot;$JAVA_HOME&quot;</span>; tar --extract --file openjdk.tgz --directory <span class="string">&quot;$JAVA_HOME&quot;</span> --strip-components <span class="number">1</span> --no-same-owner ; rm openjdk.tgz*; \</span><br><span class="line">    <span class="comment"># 构建jre</span></span><br><span class="line">    jlink --output /usr/local/jre --<span class="keyword">add</span><span class="language-bash">-modules ALL-MODULE-PATH --compress 2 --strip-debug --no-header-files --no-man-pages;</span></span><br><span class="line"><span class="keyword">FROM</span> debian:<span class="number">11.6</span>-slim</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /home/data</span></span><br><span class="line"><span class="comment"># 设置jre环境</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=jre /usr/local/jre /usr/local/jre</span></span><br><span class="line"><span class="comment"># 配置arthas</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=hengyunabc/arthas:latest /opt/arthas ./arthas</span></span><br><span class="line"><span class="comment"># 更新时区和java环境</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="keyword">ENV</span> LANG=C.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=/usr/local/jre</span><br><span class="line"><span class="keyword">ENV</span> PATH=$&#123;JAVA_HOME&#125;/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> \</span></span><br><span class="line"><span class="language-bash">    <span class="comment"># 时间设置</span></span></span><br><span class="line">    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone; \</span><br><span class="line">    <span class="comment"># 软件源配置</span></span><br><span class="line">    sed -i <span class="string">&#x27;s#deb.debian.org#mirrors.tuna.tsinghua.edu.cn#g&#x27;</span> /etc/apt/sources.list; \</span><br><span class="line">    apt update &amp;&amp; apt install  -y --no-install-recommends curl wget vim fontconfig libfreetype6 ca-certificates p11-kit; apt-get clean; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*;\</span><br><span class="line">    <span class="comment"># 设置ll</span></span><br><span class="line">    echo <span class="string">&quot;alias ll=&#x27;ls $LS_OPTIONS -l&#x27;&quot;</span> &gt;&gt; /root/.bashrc &amp;&amp;  . /root/.bashrc; \</span><br><span class="line">    <span class="comment"># 设置apm-agent</span></span><br><span class="line">    mkdir -p apm;curl -o <span class="string">&#x27;apm/apm-agent.jar&#x27;</span> -L <span class="string">&#x27;https://oss.sonatype.org/service/local/artifact/maven/redirect?r=releases&amp;g=co.elastic.apm&amp;a=elastic-apm-agent&amp;v=LATEST&#x27;</span>;\</span><br><span class="line">    <span class="comment"># 写入证书文件执行</span></span><br><span class="line">    &#123; echo <span class="string">&#x27;#!/usr/bin/env bash&#x27;</span>; echo <span class="string">&#x27;set -Eeuo pipefail&#x27;</span>; echo <span class="string">&#x27;trust extract --overwrite --format=java-cacerts --filter=ca-anchors --purpose=server-auth &quot;$JAVA_HOME/lib/security/cacerts&quot;&#x27;</span>; &#125; &gt; /etc/ca-certificates/update.d/docker-openjdk;chmod +x /etc/ca-certificates/update.d/docker-openjdk;/etc/ca-certificates/update.d/docker-openjdk;\</span><br><span class="line">    <span class="comment"># 生成共享类库</span></span><br><span class="line">    find <span class="string">&quot;$JAVA_HOME/lib&quot;</span> -name <span class="string">&#x27;*.so&#x27;</span> -exec dirname <span class="string">&#x27;&#123;&#125;&#x27;</span> <span class="string">&#x27;;&#x27;</span> | sort -u &gt; /etc/ld.so.conf.d/docker-openjdk.conf; ldconfig; java -Xshare:dump; fileEncoding=<span class="string">&quot;$(echo &#x27;System.out.println(System.getProperty(&quot;</span>file.encoding<span class="string">&quot;))&#x27; | jshell -s -)&quot;</span>; [ <span class="string">&quot;$fileEncoding&quot;</span> = <span class="string">&#x27;UTF-8&#x27;</span> ]; rm -rf ~/.java; javac --version; java --version;</span><br></pre></td></tr></table></figure><p>重新构建后，作为基础镜像，该问题解决。</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据加密、脱敏、数据权限处理</title>
      <link href="/2023/04/09/Java/%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86%E3%80%81%E8%84%B1%E6%95%8F%E3%80%81%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E5%A4%84%E7%90%86/"/>
      <url>/2023/04/09/Java/%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86%E3%80%81%E8%84%B1%E6%95%8F%E3%80%81%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E5%A4%84%E7%90%86/</url>
      
        <content type="html"><![CDATA[<ul><li>针对敏感数据，需要进行脱敏加密处理。于是做个记录。</li></ul><h4 id="数据加密"><a href="#数据加密" class="headerlink" title="数据加密"></a>数据加密</h4><ul><li>对数据库的敏感数据，如身份证/手机号，在dao层对数据进行加密处理</li></ul><ol><li>新增国密算法枚举类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD, ElementType.PARAMETER&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> FieldSm4Encrypt &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密密钥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">encKey</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>添加接口，处理字段加解密</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Parameter;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ISm4Service</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密接口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fields       字段集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramsObject object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;          实体对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalAccessException 反射异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;T&gt; <span class="keyword">void</span> <span class="title function_">encrypt</span><span class="params">(Field[] fields, T paramsObject)</span> <span class="keyword">throws</span> IllegalAccessException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密接口，对入参进行加密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameters   方法参数数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameterMap 参数k/v 映射</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">encrypt</span><span class="params">(Parameter[] parameters,</span></span><br><span class="line"><span class="params">                 Map&lt;Object, Object&gt; parameterMap)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据加密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameter 参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t         需要加密的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;       数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加密后的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;T&gt; T <span class="title function_">encrypt</span><span class="params">(Parameter parameter, T t)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> result resultType的实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalAccessException 反射异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;T&gt; <span class="keyword">void</span> <span class="title function_">decrypt</span><span class="params">(T result)</span> <span class="keyword">throws</span> IllegalAccessException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>实现类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.crypto.CryptoException;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.crypto.SmUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.crypto.symmetric.SM4;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.annotations.FieldSm4Encrypt;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.service.ISm4Service;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Parameter;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sm4ServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ISm4Service</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这里可以固定一个默认key，或者通过@Value注入，</span></span><br><span class="line">  <span class="comment">// 他只有在注解的encKey字段为空时，才会使用默认</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_KEY</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">encrypt</span><span class="params">(Field[] fields, T paramsObject)</span> <span class="keyword">throws</span> IllegalAccessException &#123;</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            <span class="comment">//取出所有被FieldSm4Encrypt注解的字段</span></span><br><span class="line">            <span class="type">FieldSm4Encrypt</span> <span class="variable">encryptTransaction</span> <span class="operator">=</span> field.getAnnotation(FieldSm4Encrypt.class);</span><br><span class="line">            <span class="keyword">if</span> (!Objects.isNull(encryptTransaction)) &#123;</span><br><span class="line">                field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> field.get(paramsObject);</span><br><span class="line">                <span class="comment">//暂时只实现String类型的加密</span></span><br><span class="line">                <span class="keyword">if</span> (object <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!StringUtils.hasText((String) object)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//加密</span></span><br><span class="line">                    field.set(paramsObject,</span><br><span class="line">                            <span class="built_in">this</span>.getSm4(encryptTransaction.encKey()).encryptHex((String) object));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">encrypt</span><span class="params">(Parameter[] parameters,</span></span><br><span class="line"><span class="params">                        Map&lt;Object, Object&gt; parameterMap)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Parameter parameter : parameters) &#123;</span><br><span class="line">            <span class="type">Param</span> <span class="variable">declaredAnnotation</span> <span class="operator">=</span> parameter.getDeclaredAnnotation(Param.class);</span><br><span class="line">            <span class="keyword">if</span> (Objects.isNull(declaredAnnotation)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> declaredAnnotation.value();</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> parameterMap.get(key);</span><br><span class="line">            <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Collection&lt;?&gt;) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Object s : ((Collection&lt;?&gt;) value)) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.encrypt(s.getClass().getDeclaredFields(), s);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">FieldSm4Encrypt</span> <span class="variable">fieldSm4Encrypt</span> <span class="operator">=</span> parameter.getDeclaredAnnotation(FieldSm4Encrypt.class);</span><br><span class="line">                <span class="keyword">if</span> (Objects.isNull(fieldSm4Encrypt)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">encValue</span> <span class="operator">=</span> getSm4(fieldSm4Encrypt.encKey()).encryptHex(String.valueOf(value));</span><br><span class="line">                parameterMap.put(key, encValue);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">encrypt</span><span class="params">(Parameter parameter, T t)</span> &#123;</span><br><span class="line">        <span class="type">FieldSm4Encrypt</span> <span class="variable">fieldSm4Encrypt</span> <span class="operator">=</span> parameter.getDeclaredAnnotation(FieldSm4Encrypt.class);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(fieldSm4Encrypt)) &#123;</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) getSm4(fieldSm4Encrypt.encKey())</span><br><span class="line">                .encryptHex(String.valueOf(t));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">decrypt</span><span class="params">(T result)</span> <span class="keyword">throws</span> IllegalAccessException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(result)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Class&lt;?&gt; resultClass = result.getClass();</span><br><span class="line">        Field[] declaredFields = resultClass.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : declaredFields) &#123;</span><br><span class="line">            <span class="type">FieldSm4Encrypt</span> <span class="variable">fieldSm4Encrypt</span> <span class="operator">=</span> field.getAnnotation(FieldSm4Encrypt.class);</span><br><span class="line">            <span class="keyword">if</span> (!Objects.isNull(fieldSm4Encrypt)) &#123;</span><br><span class="line">                field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> field.get(result);</span><br><span class="line">                <span class="keyword">if</span> (object <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!StringUtils.hasText((String) object)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        field.set(result, <span class="built_in">this</span>.getSm4(fieldSm4Encrypt.encKey()).decryptStr((String) object));</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (CryptoException ignored) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SM4 <span class="title function_">getSm4</span><span class="params">(String encPassword)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = StringUtils.hasText(encPassword) ? encPassword.getBytes(StandardCharsets.UTF_8)</span><br><span class="line">                : DEFAULT_KEY.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        <span class="keyword">return</span> SmUtil.sm4(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>配置拦截器</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.peace.common.mysql.service.ISm4Service;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.StringPool;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.cache.CacheKey;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.Executor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.BoundSql;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.MappedStatement;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Interceptor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Intercepts;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Invocation;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Signature;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.ResultHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.RowBounds;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Intercepts(&#123;</span></span><br><span class="line"><span class="meta">        @Signature(</span></span><br><span class="line"><span class="meta">                type = Executor.class,</span></span><br><span class="line"><span class="meta">                method = &quot;query&quot;,</span></span><br><span class="line"><span class="meta">                args = &#123;MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class, CacheKey.class, BoundSql.class&#125;),</span></span><br><span class="line"><span class="meta">        @Signature(type = Executor.class, method = &quot;update&quot;, args = &#123;MappedStatement.class, Object.class&#125;),</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sm4ParmeterInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ISm4Service sm4Service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">statement</span> <span class="operator">=</span> invocation.getArgs()[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> MappedStatement) &#123;</span><br><span class="line">            <span class="built_in">this</span>.parameterHandler(invocation, (MappedStatement) statement);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> invocation.proceed();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parameterHandler</span><span class="params">(Invocation invocation, MappedStatement statement)</span> <span class="keyword">throws</span> IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">parameter</span> <span class="operator">=</span> invocation.getArgs()[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(parameter)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="built_in">this</span>.getDaoTargetMethod(statement);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(method)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (parameter <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            invocation.getArgs()[<span class="number">1</span>] = sm4Service.encrypt(method.getParameters()[<span class="number">0</span>], parameter);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameter <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">            sm4Service.encrypt(method.getParameters(), (Map&lt;Object, Object&gt;) parameter);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sm4Service.encrypt(parameter.getClass().getDeclaredFields(), parameter);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取dao层方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mappedStatement statement</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Method <span class="title function_">getDaoTargetMethod</span><span class="params">(MappedStatement mappedStatement)</span> &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">namespace</span> <span class="operator">=</span> mappedStatement.getId();</span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> namespace.substring(<span class="number">0</span>, namespace.lastIndexOf(StringPool.DOT));</span><br><span class="line">            <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> namespace.substring(namespace.lastIndexOf(StringPool.DOT) + <span class="number">1</span>);</span><br><span class="line">            Method[] ms = Class.forName(className).getMethods();</span><br><span class="line">            <span class="keyword">for</span> (Method m : ms) &#123;</span><br><span class="line">                <span class="keyword">if</span> (m.getName().equals(methodName)) &#123;</span><br><span class="line">                    method = m;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException | ClassNotFoundException e) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;拦截器解析dao层方法失败:&#123;&#125; &quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>添加返回结果的拦截器</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.peace.common.mysql.service.ISm4Service;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.resultset.ResultSetHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Interceptor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Intercepts;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Invocation;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Signature;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Intercepts(&#123;</span></span><br><span class="line"><span class="meta">        @Signature(type = ResultSetHandler.class, method = &quot;handleResultSets&quot;, args = &#123;Statement.class&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sm4ResultInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ISm4Service sm4Service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 取出查询的结果</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">resultObject</span> <span class="operator">=</span> invocation.proceed();</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(resultObject)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 集合解密</span></span><br><span class="line">        <span class="keyword">if</span> (resultObject <span class="keyword">instanceof</span> List&lt;?&gt;) &#123;</span><br><span class="line">            List&lt;?&gt; resultList = (List&lt;?&gt;) resultObject;</span><br><span class="line">            <span class="keyword">if</span> (!CollectionUtils.isEmpty(resultList)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Object result : resultList) &#123;</span><br><span class="line">                    sm4Service.decrypt(result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 单条解密</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sm4Service.decrypt(resultObject);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resultObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>添加config配置类，bean交由spring管理</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.peace.common.mysql.handler.MybatisSqlInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.interceptor.Sm4ParmeterInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.interceptor.Sm4ResultInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.service.ISm4Service;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Sm4ParmeterInterceptor <span class="title function_">sm4ParmeterInterceptor</span><span class="params">(ISm4Service sm4Service)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Sm4ParmeterInterceptor</span>(sm4Service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Sm4ResultInterceptor <span class="title function_">sm4ResultInterceptor</span><span class="params">(ISm4Service sm4Service)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Sm4ResultInterceptor</span>(sm4Service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>后续可以将枚举注解抽离为对称与非对称两种注解，针对不同场景，增加扩展项</li></ul><h4 id="数据脱敏"><a href="#数据脱敏" class="headerlink" title="数据脱敏"></a>数据脱敏</h4><ul><li>敏感数据从数据库取出后，需要解密为真实数据，但是数据不能直接暴露给前端，需要进行脱敏，隐藏关键位数据。</li><li>即数据从controller层返回时，数据进行序列化时脱敏数据</li></ul><ol><li>新增数据脱敏策略类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SensitiveStrategy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取策略类型键值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 策略类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Map&lt;String, Function&lt;String, String&gt;&gt; <span class="title function_">getStrategyFunctionMap</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>默认策略类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.core.text.CharSequenceUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultSensitiveFactory</span> <span class="keyword">implements</span> <span class="title class_">SensitiveStrategy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_CARD_SENSITIVE</span> <span class="operator">=</span> <span class="string">&quot;idCard&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PHONE_NUM_SENSITIVE</span> <span class="operator">=</span> <span class="string">&quot;phoneNum&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SensitiveStrategy sensitiveStrategy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Function&lt;String, String&gt;&gt; functionMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">DefaultSensitiveFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        initDefaultStrategy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SensitiveStrategy <span class="title function_">getDefaultStrategy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(sensitiveStrategy)) &#123;</span><br><span class="line">            sensitiveStrategy = <span class="keyword">new</span> <span class="title class_">DefaultSensitiveFactory</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sensitiveStrategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initDefaultStrategy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.functionMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">      <span class="comment">// 添加默认实现，手机号/身份证脱敏策略</span></span><br><span class="line">        functionMap.put(ID_CARD_SENSITIVE, (s) -&gt; CharSequenceUtil.hide(s, <span class="number">1</span>, s.length() - <span class="number">1</span>));</span><br><span class="line">        functionMap.put(PHONE_NUM_SENSITIVE, (s) -&gt; CharSequenceUtil.hide(s, <span class="number">3</span>, s.length() - <span class="number">4</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Function&lt;String, String&gt;&gt; <span class="title function_">getStrategyFunctionMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> functionMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加策略</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> strategyName 策略名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> function oldStr, encStr转换</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加密策略</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SensitiveStrategy <span class="title function_">addStrategy</span><span class="params">(</span></span><br><span class="line"><span class="params">            String strategyName,</span></span><br><span class="line"><span class="params">            Function&lt;String, String&gt; function)</span> &#123;</span><br><span class="line">        <span class="type">SensitiveStrategy</span> <span class="variable">defaultStrategy</span> <span class="operator">=</span> getDefaultStrategy();</span><br><span class="line">        Map&lt;String, Function&lt;String, String&gt;&gt; strategyFunctionMap = defaultStrategy.getStrategyFunctionMap();</span><br><span class="line">        strategyFunctionMap.put(strategyName, function);</span><br><span class="line">        <span class="keyword">return</span> defaultStrategy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>脱敏注解类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JacksonAnnotationsInside;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.annotation.JsonSerialize;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.serialize.SensitiveSerialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@JacksonAnnotationsInside</span></span><br><span class="line"><span class="meta">@JsonSerialize(</span></span><br><span class="line"><span class="meta">        using = SensitiveSerialize.class</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> FieldSensitive &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 策略类型</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 策略类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol><li>序列化类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonGenerator;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.BeanProperty;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JsonMappingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JsonSerializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializerProvider;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ser.ContextualSerializer;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.annotations.FieldSensitive;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.strategy.DefaultSensitiveFactory;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.strategy.SensitiveStrategy;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SensitiveSerialize</span> <span class="keyword">extends</span> <span class="title class_">JsonSerializer</span>&lt;String&gt; <span class="keyword">implements</span> <span class="title class_">ContextualSerializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SensitiveStrategy sensitiveStrategy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SensitiveSerialize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sensitiveStrategy = DefaultSensitiveFactory.getDefaultStrategy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(String value, JsonGenerator gen, SerializerProvider serializers)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Function&lt;String, String&gt; function = sensitiveStrategy.getStrategyFunctionMap().get(type);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(function)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;策略类型为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        gen.writeString(function.apply(value));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> JsonSerializer&lt;?&gt; createContextual(SerializerProvider serializerProvider, BeanProperty property) <span class="keyword">throws</span> JsonMappingException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.equals(property.getType().getRawClass(), String.class)) &#123;</span><br><span class="line">            <span class="type">FieldSensitive</span> <span class="variable">fieldSensitive</span> <span class="operator">=</span> <span class="built_in">this</span>.getAnnotation(property);</span><br><span class="line">            <span class="keyword">if</span> (Objects.isNull(fieldSensitive)) &#123;</span><br><span class="line">                <span class="keyword">return</span> serializerProvider.findNullValueSerializer(<span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.setType(fieldSensitive.value());</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> serializerProvider.findKeySerializer(property.getType(), property);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> FieldSensitive <span class="title function_">getAnnotation</span><span class="params">(BeanProperty property)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.isNull(property.getAnnotation(FieldSensitive.class))</span><br><span class="line">                ? property.getContextAnnotation(FieldSensitive.class)</span><br><span class="line">                : property.getAnnotation(FieldSensitive.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>在返回的vo层，对需要脱敏的对象字段使用</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FieldSensitive(DefaultSensitiveFactory.PHONE_NUM_SENSITIVE)</span></span><br><span class="line"><span class="keyword">private</span> String phone;</span><br></pre></td></tr></table></figure><h4 id="数据权限拦截"><a href="#数据权限拦截" class="headerlink" title="数据权限拦截"></a>数据权限拦截</h4><ul><li><p>在系统中，需要针对每个角色制定不同的数据权限，如角色1，只能访问本部门的数据，角色2可以访问部门及其子部门的数据，所以需要在sql解析时拦截，对数据权限进行添加</p></li><li><p>这里选择实现Mybatis-plus的DataPermissionHandler，对数据权限进行处理</p><ol><li>数据权限枚举类</li></ol></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">DataScopeEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义数据权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ALL(<span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CUSTOM(<span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 本部门</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DEPT(<span class="number">3</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 部门及其子部门</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DEPT_AND_SUB(<span class="number">4</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SELF(<span class="number">5</span>),</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> scope;</span><br><span class="line"></span><br><span class="line">    DataScopeEnum(<span class="type">int</span> scope) &#123;</span><br><span class="line">        <span class="built_in">this</span>.scope = scope;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isAll</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ALL.scope == value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isCustom</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CUSTOM.scope == value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isDeptAndSub</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DEPT_AND_SUB.scope == value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isDept</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DEPT.scope == value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isSelf</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SELF.scope == value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getScope</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> scope;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol><li>数据权限注解</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.peace.common.mysql.enums.DataScopeEnum;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 数据权限注解</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fuhouyu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2023/3/31 21:28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DataPermission &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 部门表别名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 部门表别名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">deptAlias</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 部门列名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 部门列名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">deptColumn</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;dept_id&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户表别名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户表别名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">userAlias</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户列</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">userColumn</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;create_user&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询的前缀</span></span><br><span class="line"><span class="comment">     * 在注解为类级别时，将会验证当前前缀是否为查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 查询的前缀</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] queryPrefix() <span class="keyword">default</span> &#123;<span class="string">&quot;query&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;select&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否是左查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 是，默认为false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isLeftJoin</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当角色不存在时，默认的角色权限类型</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 当前自己创建的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DataScopeEnum <span class="title function_">defaultScopeEnum</span><span class="params">()</span> <span class="keyword">default</span> DataScopeEnum.SELF;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol><li>自定义权限拦截器</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.StringPool;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.handler.DataPermissionHandler;</span><br><span class="line"><span class="keyword">import</span> com.google.protobuf.Empty;</span><br><span class="line"><span class="keyword">import</span> com.peace.api.dept.SysDeptGrpc;</span><br><span class="line"><span class="keyword">import</span> com.peace.api.dept.SysDeptServiceGrpc;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.annotations.DataPermission;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.enums.DataScopeEnum;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.util.context.UserThreadLocal;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.util.pojo.SysDept;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.util.pojo.SysRole;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> net.sf.jsqlparser.expression.Expression;</span><br><span class="line"><span class="keyword">import</span> net.sf.jsqlparser.expression.operators.conditional.AndExpression;</span><br><span class="line"><span class="keyword">import</span> net.sf.jsqlparser.parser.CCJSqlParserUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomDataPermissionHandler</span> <span class="keyword">implements</span> <span class="title class_">DataPermissionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// gprc 远程调用的实现,用于获取部门集合</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GRpcService deptService;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实现部门及子部门的左连接sql查询</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEPT_AND_SUB_LEFT_SQL</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 自定义的部门权限查询</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CUSTOM_LEFT_SQL</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomDataPermissionHandler</span><span class="params">(GRpcService deptService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.deptService = deptService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> Expression <span class="title function_">getSqlSegment</span><span class="params">(Expression where, String mappedStatementId)</span> &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(mappedStatementId.substring(<span class="number">0</span>, mappedStatementId.lastIndexOf(StringPool.DOT)));</span><br><span class="line">        <span class="type">String</span> <span class="variable">currentMethodName</span> <span class="operator">=</span> mappedStatementId.substring(mappedStatementId.lastIndexOf(StringPool.DOT) + <span class="number">1</span>);</span><br><span class="line">        Method[] methods = clazz.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">            <span class="type">DataPermission</span> <span class="variable">dataPermission</span> <span class="operator">=</span> method.getAnnotation(DataPermission.class);</span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(dataPermission) &amp;&amp; Objects.equals(method.getName(), currentMethodName)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.dataScopeFilter(dataPermission, where);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">DataPermission</span> <span class="variable">dataPermission</span> <span class="operator">=</span> clazz.getAnnotation(DataPermission.class);</span><br><span class="line">        <span class="comment">// 判断类</span></span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(dataPermission)) &#123;</span><br><span class="line">            <span class="comment">// 类级别注解不为空，判断当前方法的值是否为该前缀</span></span><br><span class="line">            String[] queryPrefix = dataPermission.queryPrefix();</span><br><span class="line">            <span class="keyword">for</span> (String prefix : queryPrefix) &#123;</span><br><span class="line">                <span class="keyword">if</span> (currentMethodName.startsWith(prefix)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.dataScopeFilter(dataPermission, where);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> where;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据权限过滤</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataPermission 数据权限注解</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> where          添加where 表达式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 拼接后的sql表达式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">private</span> Expression <span class="title function_">dataScopeFilter</span><span class="params">(DataPermission dataPermission, Expression where)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">deptAlias</span> <span class="operator">=</span> dataPermission.deptAlias();</span><br><span class="line">        <span class="type">String</span> <span class="variable">userAlias</span> <span class="operator">=</span> dataPermission.userAlias();</span><br><span class="line">        <span class="type">String</span> <span class="variable">deptColumn</span> <span class="operator">=</span> dataPermission.deptColumn();</span><br><span class="line">        <span class="type">String</span> <span class="variable">userColumn</span> <span class="operator">=</span> dataPermission.userColumn();</span><br><span class="line">        <span class="type">String</span> <span class="variable">deptColumnName</span> <span class="operator">=</span> StrUtil.isNotBlank(deptAlias) ? (deptAlias + StringPool.DOT + deptColumn) : deptColumn;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userColumnName</span> <span class="operator">=</span> StrUtil.isNotBlank(userAlias) ? (userAlias + StringPool.DOT + userColumn) : userColumn;</span><br><span class="line"></span><br><span class="line">        <span class="type">SysRole</span> <span class="variable">role</span> <span class="operator">=</span> UserThreadLocal.getBasicUser().getSysRole();</span><br><span class="line">        <span class="type">SysDept</span> <span class="variable">sysDept</span> <span class="operator">=</span> UserThreadLocal.getBasicUser().getSysDept();</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">deptId</span> <span class="operator">=</span> Objects.nonNull(sysDept) ? sysDept.getId() : -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 如果用户不存在角色，为默认，则使他的值为当前自己</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">dataScope</span> <span class="operator">=</span> Objects.isNull(role) ? dataPermission.defaultScopeEnum().getScope() : role.getDataScope();</span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">leftJoin</span> <span class="operator">=</span> dataPermission.isLeftJoin();</span><br><span class="line">        <span class="keyword">if</span> (DataScopeEnum.isAll(dataScope)) &#123;</span><br><span class="line">            <span class="comment">// 返回所有的权限</span></span><br><span class="line">            <span class="keyword">return</span> where;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DataScopeEnum.isCustom(dataScope)) &#123;</span><br><span class="line">            <span class="comment">// 自定义数据权限</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> leftJoin ?</span><br><span class="line">                    String.format(CUSTOM_LEFT_SQL, role.getId()) : <span class="built_in">this</span>.concatRpcDeptDataScopeSql();</span><br><span class="line">            sb.append(deptColumnName)</span><br><span class="line">                    .append(sql);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DataScopeEnum.isDeptAndSub(dataScope)) &#123;</span><br><span class="line">            <span class="comment">// 当前部门及其子部门的数据权限</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> leftJoin ?</span><br><span class="line">                    String.format(DEPT_AND_SUB_LEFT_SQL, deptId) : <span class="built_in">this</span>.concatRpcDeptDataScopeSql();</span><br><span class="line">            sb.append(deptColumnName)</span><br><span class="line">                    .append(sql);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DataScopeEnum.isDept(dataScope)) &#123;</span><br><span class="line">            <span class="comment">// 仅当前部门的数据权限</span></span><br><span class="line">            sb.append(deptColumnName).append(<span class="string">&quot; = &quot;</span>).append(deptId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 当前用户的数据权限</span></span><br><span class="line">            sb.append(userColumnName).append(<span class="string">&quot; = &quot;</span>).append(<span class="string">&quot;&#x27;&quot;</span>).append(UserThreadLocal.getBasicUser().getUsername()).append(<span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> sb.toString();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isAllBlank(sql)) &#123;</span><br><span class="line">            <span class="keyword">return</span> where;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> CCJSqlParserUtil.parseExpression(sql);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(where)) &#123;</span><br><span class="line">            <span class="keyword">return</span> expression;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AndExpression</span>(where, expression);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拼接部门sql</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 部门sql</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">concatRpcDeptDataScopeSql</span><span class="params">()</span> &#123;</span><br><span class="line">        SysDeptGrpc.<span class="type">DataScopeResult</span> <span class="variable">userDataScope</span> <span class="operator">=</span> deptService.getDeptIdListByCurrentUserDataScope(Empty.newBuilder().build());</span><br><span class="line">        List&lt;Long&gt; deptIdList = userDataScope.getDeptIdListList();</span><br><span class="line">        <span class="keyword">if</span> (deptIdList.isEmpty()) &#123;</span><br><span class="line">            deptIdList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">            log.warn(<span class="string">&quot;用户的自定义角色数据权限为空&quot;</span>);</span><br><span class="line">            deptIdList.add(-<span class="number">1L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot; IN (&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Long deptId : deptIdList) &#123;</span><br><span class="line">            sb.append(deptId)</span><br><span class="line">                    .append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sb.deleteCharAt(sb.length() - <span class="number">1</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h5><ul><li>在使用pageHelper和dataPermissionHandler时，分页插件获取count的拦截，要优先处理于数据权限的处理器，所以要设置插件的顺序</li><li>在<a href="https://github.com/pagehelper/pagehelper-spring-boot">pageHelper</a>的文档中有如下文档</li></ul><p><img src="https://img.fuhouyu.com/2023-04-09-025307.png" alt=""></p><ul><li>关于插件顺序的讲解，具体可看<a href="https://github.com/pagehelper/Mybatis-PageHelper/blob/master/wikis/zh/Interceptor.md">Executor 拦截器高级教程</a></li></ul><p>所以在配置类中，添加如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.inner.BlockAttackInnerInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.inner.DataPermissionInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.autoconfigure.PageHelperAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> com.peace.api.dept.SysDeptServiceGrpc;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.handler.CustomDataPermissionHandler;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> net.devh.boot.grpc.client.inject.GrpcClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureAfter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackageClasses = MybatisPlusAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="comment">// 使当前配置，在分页插件之后执行</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(PageHelperAutoConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusAutoConfiguration</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SqlSessionFactory&gt; sqlSessionFactoryList;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 远程调用</span></span><br><span class="line">    <span class="keyword">private</span> GRpcService deptService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (SqlSessionFactory sqlSessionFactory : sqlSessionFactoryList) &#123;</span><br><span class="line">            org.apache.ibatis.session.<span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> sqlSessionFactory.getConfiguration();</span><br><span class="line">            configuration.addInterceptor(mybatisPlusInterceptor());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">BlockAttackInnerInterceptor</span>());</span><br><span class="line">        <span class="type">DataPermissionInterceptor</span> <span class="variable">dataPermissionInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataPermissionInterceptor</span>(<span class="keyword">new</span> <span class="title class_">CustomDataPermissionHandler</span>(deptService));</span><br><span class="line">        interceptor.addInnerInterceptor(dataPermissionInterceptor);</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jenkins 自动化流水线部署</title>
      <link href="/2023/04/08/Linux/Jenkins%20%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%81%E6%B0%B4%E7%BA%BF%E9%83%A8%E7%BD%B2/"/>
      <url>/2023/04/08/Linux/Jenkins%20%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%81%E6%B0%B4%E7%BA%BF%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h4 id="必备软件"><a href="#必备软件" class="headerlink" title="必备软件"></a>必备软件</h4><h5 id="安装docker-containerd"><a href="#安装docker-containerd" class="headerlink" title="安装docker/containerd"></a>安装docker/containerd</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install docker</span><br></pre></td></tr></table></figure><h5 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装git</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install git</span><br></pre></td></tr></table></figure><p>安装maven/mvnd</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载mvnd</span></span><br><span class="line">wget https://github.com/apache/maven-mvnd/releases/download/1.0-m6/maven-mvnd-1.0-m6-m39-linux-amd64.zip</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压mvnd</span></span><br><span class="line">unzip maven-mvnd-1.0-m6-m39-linux-amd64.zip -d ./mvnd</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="安装jenkins"><a href="#安装jenkins" class="headerlink" title="安装jenkins"></a>安装jenkins</h5><p><a href="https://www.jenkins.io/zh/download/">Jenkins 的安装和设置</a></p><h6 id="安装必备插件"><a href="#安装必备插件" class="headerlink" title="安装必备插件"></a>安装必备插件</h6><ol><li><p>打开jenkins页面后，根据提示更新</p></li><li><p>更新<a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json">jenkins镜像源</a></p></li><li><p>下载必备Docker Pipeline</p><p><img src="https://img.fuhouyu.com/2023-04-08-130735.png" alt=""></p></li><li><p>在全局工具中，定义maven</p></li><li><p>定义jenkins的git凭据，复制git凭据id</p></li></ol><h6 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h6><p>新版本的jenkins配置文件在：<code>/usr/lib/systemd/system/jenkins.service</code>目录下</p><p>jenkins新版本至少需要jdk11才可以，如果在之前已经安装过jdk，且小于11，可能会出现无法启动的情况，需要更新环境变量</p><h5 id="打包部署java项目"><a href="#打包部署java项目" class="headerlink" title="打包部署java项目"></a>打包部署java项目</h5><ol><li>新建项目，选择流水线</li></ol><p><img src="https://img.fuhouyu.com/2023-04-08-130916.png" alt=""></p><ol><li><p>勾选选项参数</p><ol><li>添加git选项url</li><li>添加文本参数branch</li><li>添加选项参数 harborUrl，harbor镜像地址</li><li>添加选项参数 k8s_master, master主节点地址</li><li>添加文本参数 service，java模块地址</li><li>添加文件参数 depth，jar目录深度</li></ol><p>如下图所示</p><p><img src="https://img.fuhouyu.com/2023-04-08-142129.png" alt=""></p></li><li><p>使用流水线，定义脚本</p><p><img src="https://img.fuhouyu.com/2023-04-08-131136.png" alt=""></p><p>脚本如下：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">node &#123;</span><br><span class="line">  <span class="keyword">def</span> mvn = tool <span class="string">&#x27;maven&#x27;</span>;</span><br><span class="line">  <span class="keyword">def</span> version = <span class="string">&quot;v&quot;</span> + sh(<span class="attr">script:</span> <span class="string">&quot;date &#x27;+%s&#x27;&quot;</span>, <span class="attr">returnStdout:</span> <span class="literal">true</span>).trim()</span><br><span class="line">  <span class="keyword">def</span> imageTags = []</span><br><span class="line">  <span class="keyword">def</span> k8sTemplates = []</span><br><span class="line">  <span class="keyword">def</span> baseHarborUrl = <span class="string">&quot;$&#123;harborUrl&#125;&quot;</span>.tokenize(<span class="string">&#x27;/&#x27;</span>).last()</span><br><span class="line">  <span class="keyword">def</span> startup = <span class="string">&#x27;&#x27;&#x27;#!/bin/bash</span></span><br><span class="line"><span class="string">JAVA_OPT=&quot;java&quot;</span></span><br><span class="line"><span class="string">BASE_DIR=&quot;/home/data&quot;</span></span><br><span class="line"><span class="string">SERVICE_NAME=$1</span></span><br><span class="line"><span class="string">ACTIVE=$2</span></span><br><span class="line"><span class="string">PARAM=$3</span></span><br><span class="line"><span class="string">#===========================================================================================</span></span><br><span class="line"><span class="string"># JVM Configuration</span></span><br><span class="line"><span class="string">#===========================================================================================</span></span><br><span class="line"><span class="string">if  [ -n &quot;$JVM_XMS&quot; ] ;then</span></span><br><span class="line"><span class="string">  JVM_OPT=&quot;$JVM_OPT -Xms$&#123;JVM_XMS&#125;&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [ -n &quot;$JVM_XMX&quot; ]; then</span></span><br><span class="line"><span class="string">  JVM_OPT=&quot;$JVM_OPT -Xmx$&#123;JVM_XMX&#125;&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [ &quot;$&#123;DEBUG_ENABLED&#125;&quot; == &quot;y&quot; ]; then</span></span><br><span class="line"><span class="string">  JVM_OPT=&quot;$JVM_OPT -Xrunjdwp:transport=dt_socket,address=*:10000,server=y,suspend=n&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [ -n &quot;$JVM_OTHER_PARAMS&quot;]; then</span></span><br><span class="line"><span class="string">  JVM_OPT=&quot;$JVM_OPT $&#123;JVM_OTHER_PARAMS&#125;&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [ -n &quot;$DUMP_LOG&quot; ]; then</span></span><br><span class="line"><span class="string">  DUMP_LOG=&quot;/var/log/java_heapdump.hprof&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [ -n &quot;$JAVA_LOG&quot; ]; then</span></span><br><span class="line"><span class="string">  JAVA_LOG=&quot;-Xlog:gc*=debug:file=/var/log/gc.log:utctime,level,tags:filecount=30,filesize=100M&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">JVM_OPT=&quot;$JVM_OPT -XX:-OmitStackTraceInFastThrow -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$DUMP_LOG&quot;</span></span><br><span class="line"><span class="string">JVM_OPT=&quot;$JVM_OPT $JAVA_LOG&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#===========================================================================================</span></span><br><span class="line"><span class="string"># Setting system properties</span></span><br><span class="line"><span class="string">#===========================================================================================</span></span><br><span class="line"><span class="string">JAVA_OPT=&quot;$JAVA_OPT -jar -DSpring.profiles.active=$ACTIVE $PARAM $START_PARAM $JVM_OPT $&#123;BASE_DIR&#125;/$SERVICE_NAME*.jar&quot;</span></span><br><span class="line"><span class="string">$JAVA_OPT</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  stage(<span class="string">&#x27;拉取代码&#x27;</span>)&#123;</span><br><span class="line">  echo <span class="string">&quot;git pull code&quot;</span></span><br><span class="line">  git(<span class="attr">url:</span> <span class="string">&quot;$&#123;git&#125;&quot;</span>, <span class="attr">branch:</span> <span class="string">&quot;$&#123;branch&#125;&quot;</span>, <span class="attr">credentialsId:</span> <span class="string">&quot;128ee387-1deb-4241-87ae-dfeaeaec448d&quot;</span>)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">stage(<span class="string">&#x27;编译代码&#x27;</span>)&#123;</span><br><span class="line">echo <span class="string">&quot;编译代码&quot;</span></span><br><span class="line">sh <span class="string">&quot;$&#123;mvn&#125;/bin/mvnd clean install -Dmaven.test.skip=true&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  stage(<span class="string">&#x27;构建docker镜像&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">def</span> serviceArray = <span class="string">&quot;$&#123;service&#125;&quot;</span>.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span>(serviceName <span class="keyword">in</span> serviceArray)&#123;</span><br><span class="line">        <span class="keyword">def</span> imageName = <span class="string">&quot;$&#123;baseHarborUrl&#125;/$&#123;branch&#125;/$&#123;serviceName&#125;&quot;</span></span><br><span class="line">        echo <span class="string">&quot;镜像名：$&#123;imageName&#125;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> jarPath = <span class="string">&quot;$&#123;env.WORKSPACE&#125;/$&#123;&#x27;**/&#x27; * depth.toInteger()&#125;/$&#123;serviceName&#125;/target/$&#123;serviceName&#125;*.jar&quot;</span></span><br><span class="line">        echo <span class="string">&quot;jar路径:$&#123;jarPath&#125;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> tag = <span class="string">&quot;$&#123;imageName&#125;:$&#123;version&#125;&quot;</span></span><br><span class="line">        echo <span class="string">&quot;tag is $&#123;tag&#125;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> dockerfileContent = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">FROM 101.91.198.224:30080/base-image/debian-jre-11:v1.4.0</span></span><br><span class="line"><span class="string">COPY ./$&#123;serviceName&#125;.jar /home/data/$&#123;serviceName&#125;.jar</span></span><br><span class="line"><span class="string">COPY ./startup.sh /home/data/startup.sh</span></span><br><span class="line"><span class="string">RUN chmod +x /home/data/startup.sh</span></span><br><span class="line"><span class="string">WORKDIR /home/data</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">         <span class="keyword">def</span> k8sTemplate =</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">  namespace: $&#123;branch&#125;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      imagePullSecrets:</span></span><br><span class="line"><span class="string">        - name: harbor-secret</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">        - name: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">          image: $&#123;tag&#125;</span></span><br><span class="line"><span class="string">          imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">          env:</span></span><br><span class="line"><span class="string">            - name: JAVA_LOG</span></span><br><span class="line"><span class="string">              valueFrom:</span></span><br><span class="line"><span class="string">                configMapKeyRef:</span></span><br><span class="line"><span class="string">                  name: spring-cm</span></span><br><span class="line"><span class="string">                  key: java.log</span></span><br><span class="line"><span class="string">            - name: DUMP_LOG</span></span><br><span class="line"><span class="string">              valueFrom:</span></span><br><span class="line"><span class="string">                configMapKeyRef:</span></span><br><span class="line"><span class="string">                  name: spring-cm</span></span><br><span class="line"><span class="string">                  key: dump.log</span></span><br><span class="line"><span class="string">            - name: START_PARAM</span></span><br><span class="line"><span class="string">              valueFrom:</span></span><br><span class="line"><span class="string">                configMapKeyRef:</span></span><br><span class="line"><span class="string">                  name: spring-cm</span></span><br><span class="line"><span class="string">                  key: start.param</span></span><br><span class="line"><span class="string">            - name: DEBUG_ENABLED</span></span><br><span class="line"><span class="string">              valueFrom:</span></span><br><span class="line"><span class="string">                configMapKeyRef:</span></span><br><span class="line"><span class="string">                  name: spring-cm</span></span><br><span class="line"><span class="string">                  key: debug.enabled</span></span><br><span class="line"><span class="string">          command: [&quot;/home/data/startup.sh&quot;]</span></span><br><span class="line"><span class="string">          args: [&quot;$&#123;serviceName&#125;&quot;, &quot;test&quot;]</span></span><br><span class="line"><span class="string">          resources:</span></span><br><span class="line"><span class="string">           limits:</span></span><br><span class="line"><span class="string">            cpu: 500m</span></span><br><span class="line"><span class="string">            memory: 1024Mi</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">  namespace: $&#123;branch&#125;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">  type: ClusterIP</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - name: http</span></span><br><span class="line"><span class="string">      port: 8080</span></span><br><span class="line"><span class="string">      targetPort: 8080</span></span><br><span class="line"><span class="string">    - name: debug</span></span><br><span class="line"><span class="string">      port: 10000</span></span><br><span class="line"><span class="string">      targetPort: 10000</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: networking.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: Ingress</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">  namespace: $&#123;branch&#125;</span></span><br><span class="line"><span class="string">  annotations:</span></span><br><span class="line"><span class="string">    nginx.ingress.kubernetes.io/use-regex: &quot;true&quot;</span></span><br><span class="line"><span class="string">    nginx.ingress.kubernetes.io/rewrite-target: /\$2</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  rules:</span></span><br><span class="line"><span class="string">    - host:</span></span><br><span class="line"><span class="string">      http:</span></span><br><span class="line"><span class="string">        paths:</span></span><br><span class="line"><span class="string">          - path: /$&#123;branch&#125;-$&#123;serviceName&#125;(/|\$)(.*)</span></span><br><span class="line"><span class="string">            pathType: Prefix</span></span><br><span class="line"><span class="string">            backend:</span></span><br><span class="line"><span class="string">              service:</span></span><br><span class="line"><span class="string">                name: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">                port:</span></span><br><span class="line"><span class="string">                  number: 8080</span></span><br><span class="line"><span class="string">  ingressClassName: nginx</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">        writeFile <span class="attr">file:</span> <span class="string">&quot;/tmp/$&#123;serviceName&#125;/Dockerfile&quot;</span>, <span class="attr">text:</span> dockerfileContent</span><br><span class="line">        writeFile <span class="attr">file:</span> <span class="string">&quot;/tmp/$&#123;serviceName&#125;/startup.sh&quot;</span>, <span class="attr">text:</span> startup</span><br><span class="line">        sh <span class="string">&quot;cp $&#123;jarPath&#125; /tmp/$&#123;serviceName&#125;/$&#123;serviceName&#125;.jar&quot;</span></span><br><span class="line">        <span class="keyword">def</span> app = docker.build(tag, <span class="string">&quot;-f /tmp/$&#123;serviceName&#125;/Dockerfile /tmp/$&#123;serviceName&#125;&quot;</span>)</span><br><span class="line">        imageTags += tag</span><br><span class="line">        <span class="keyword">def</span> k8sYaml = <span class="string">&quot;/tmp/$&#123;serviceName&#125;/$&#123;serviceName&#125;.yaml&quot;</span></span><br><span class="line">        writeFile <span class="attr">file:</span> k8sYaml, <span class="attr">text:</span> k8sTemplate</span><br><span class="line">        k8sTemplates += k8sYaml</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stage(<span class="string">&#x27;推送docker镜像&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(tag <span class="keyword">in</span> imageTags)&#123;</span><br><span class="line">          <span class="keyword">def</span> dockerImage = docker.image(<span class="string">&quot;$&#123;tag&#125;&quot;</span>)</span><br><span class="line">          <span class="keyword">def</span> harborCertificate = env[<span class="string">&quot;$&#123;harborUrl&#125;&quot;</span>]</span><br><span class="line">          docker.withRegistry(<span class="string">&quot;$&#123;harborUrl&#125;&quot;</span>, <span class="string">&quot;$&#123;harborCertificate&#125;&quot;</span>) &#123;</span><br><span class="line">            dockerImage.push()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   stage(<span class="string">&#x27;发布到K8s镜像&#x27;</span>)&#123;</span><br><span class="line">   <span class="keyword">def</span> k8sMasterHost = env[<span class="string">&quot;$&#123;branch&#125;_K8s_HOST&quot;</span>.toUpperCase()]</span><br><span class="line">   <span class="keyword">if</span> ((<span class="string">&quot;$&#123;branch&#125;&quot;</span>.contains(<span class="string">&quot;master&quot;</span>)))&#123;</span><br><span class="line">        <span class="keyword">for</span>(tag <span class="keyword">in</span> imageTags)&#123;</span><br><span class="line">            echo <span class="string">&quot;当前镜像版本号: $&#123;tag&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(template <span class="keyword">in</span> k8sTemplates)&#123;</span><br><span class="line">           <span class="keyword">def</span> name = template.tokenize(<span class="string">&#x27;/&#x27;</span>).last()</span><br><span class="line">           echo <span class="string">&quot;写入文件&quot;</span></span><br><span class="line">            sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                cat &quot;$&#123;template&#125;&quot; | ssh root@$&#123;k8sMasterHost&#125; &quot;cat &gt; /ddhome/k8s/$&#123;name&#125;;kubectl delete -f /ddhome/k8s/$&#123;name&#125;; kubectl apply -f /ddhome/k8s/$&#123;name&#125;&quot;</span></span><br><span class="line"><span class="string">               &quot;&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>spring-cm configMap示例</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">spring-cm</span></span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">$&#123;bransh&#125;</span></span><br><span class="line"><span class="attr">data</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">java.log</span>: <span class="string">&quot;-Xlog:gc*=debug:file=/var/log/gc.log:utctime,level,tags:filecount=30,filesize=100M&quot;</span></span><br><span class="line"> <span class="attr">dump.log</span>: <span class="string">&quot;-Xlog:gc*=debug:file=/var/log/gc.log:utctime,level,tags:filecount=30,filesize=100M&quot;</span></span><br><span class="line"> <span class="attr">debug.enabled</span>: <span class="string">&quot;y&quot;</span></span><br><span class="line"><span class="comment"> # 重写为8080的端口，单容器内部可以设置为相同，不冲突</span></span><br><span class="line"> <span class="attr">start.param</span>: <span class="string">&quot;-Dserver.port=8080&quot;</span></span><br></pre></td></tr></table></figure><p>构建结果如下</p><p><img src="https://img.fuhouyu.com/2023-04-08-143033.png" alt=""></p></li></ol><h5 id="打包部署前端js-容器化"><a href="#打包部署前端js-容器化" class="headerlink" title="打包部署前端js(容器化)"></a>打包部署前端js(容器化)</h5><ol><li><p>新建流水线项目</p></li><li><p>勾选选项参数</p><ol><li>添加选项参数git，添加代码仓地址</li><li>添加分支branch参数</li><li>添加选项参数 harborUrl，harbor镜像地址</li><li>添加选项参数 k8s_master, master主节点地址</li><li>添加文本visitPath参数，通过ingress-nginx访问的后缀url</li><li>添加选项参数buildPath</li></ol><p><img src="https://img.fuhouyu.com/2023-04-08-150731.png" alt=""></p></li></ol><p>脚本如下：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">node &#123;</span><br><span class="line">    <span class="comment">// 时间戳的版本号</span></span><br><span class="line">    <span class="keyword">def</span> version = <span class="string">&quot;v&quot;</span> + sh(<span class="attr">script:</span> <span class="string">&quot;date &#x27;+%s&#x27;&quot;</span>, <span class="attr">returnStdout:</span> <span class="literal">true</span>).trim()</span><br><span class="line">  <span class="comment">// 标签号</span></span><br><span class="line">    <span class="keyword">def</span> tag = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment">// k8s存储的yaml</span></span><br><span class="line">    <span class="keyword">def</span> k8sTemplatePath = <span class="string">&quot;/tmp/$&#123;env.JOB_NAME&#125;/$&#123;env.JOB_NAME&#125;.yaml&quot;</span></span><br><span class="line">  <span class="comment">// 可访问的url地址</span></span><br><span class="line">    <span class="keyword">def</span> path = <span class="string">&quot;$&#123;visitPath&#125;&quot;</span> ? <span class="string">&quot;$&#123;visitPath&#125;&quot;</span> : <span class="string">&quot;$&#123;env.JOB_NAME&#125;&quot;</span></span><br><span class="line">  <span class="comment">// 基本的url</span></span><br><span class="line">    <span class="keyword">def</span> baseHarborUrl = <span class="string">&quot;$&#123;harborUrl&#125;&quot;</span>.tokenize(<span class="string">&#x27;/&#x27;</span>).last()</span><br><span class="line">stage(<span class="string">&#x27;拉取代码&#x27;</span>)&#123;</span><br><span class="line">echo <span class="string">&quot;git pull code&quot;</span></span><br><span class="line">git(<span class="attr">url:</span> <span class="string">&quot;$&#123;git&#125;&quot;</span>, <span class="attr">branch:</span> <span class="string">&quot;$&#123;branch&#125;&quot;</span>, <span class="attr">credentialsId:</span> <span class="string">&quot;128ee387-1deb-4241-87ae-dfeaeaec448d&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 编译代码</span></span><br><span class="line">stage(<span class="string">&#x27;编译代码&#x27;</span>)&#123;</span><br><span class="line">echo <span class="string">&quot;编译代码&quot;</span></span><br><span class="line"><span class="keyword">if</span>(<span class="string">&quot;$&#123;branch&#125;&quot;</span> == <span class="string">&#x27;master&#x27;</span>)&#123;</span><br><span class="line">    sh <span class="string">&quot;rm -rf node_modules package-lock.json &amp;&amp; source /etc/profile &amp;&amp; npm install  --legacy-peer-deps &amp;&amp; npm run build:prod&quot;</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    sh <span class="string">&quot;rm -rf node_modules package-lock.json &amp;&amp; source /etc/profile &amp;&amp; npm install  --legacy-peer-deps &amp;&amp; npm run build:$&#123;branch&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stage(<span class="string">&#x27;构建docker镜像&#x27;</span>)&#123;</span><br><span class="line">    echo <span class="string">&quot;容器静态文件存放目录为: $path&quot;</span></span><br><span class="line">        <span class="keyword">def</span> dockerfileContent = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            FROM nginx:stable-alpine3.17</span></span><br><span class="line"><span class="string">            RUN apk add tzdata &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone \</span></span><br><span class="line"><span class="string">                    &amp;&amp; apk del tzdata</span></span><br><span class="line"><span class="string">            COPY &quot;./dist&quot; /usr/share/nginx/html/$&#123;path&#125;</span></span><br><span class="line"><span class="string">          &quot;&quot;&quot;</span></span><br><span class="line">        tag = <span class="string">&quot;$&#123;baseHarborUrl&#125;/$&#123;branch&#125;/$&#123;env.JOB_NAME&#125;:$&#123;version&#125;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> k8sTemplate = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">  namespace: $&#123;BRANCH&#125;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      imagePullSecrets:</span></span><br><span class="line"><span class="string">        - name: harbor-secret</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">        - name: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">          image: $&#123;tag&#125;</span></span><br><span class="line"><span class="string">          imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">          volumeMounts:</span></span><br><span class="line"><span class="string">            - name: resource</span></span><br><span class="line"><span class="string">              mountPath: /ddhome/resource</span></span><br><span class="line"><span class="string">            - name: log</span></span><br><span class="line"><span class="string">              mountPath: /var/log/nginx</span></span><br><span class="line"><span class="string">              subPath: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">      volumes:</span></span><br><span class="line"><span class="string">        - name: resource</span></span><br><span class="line"><span class="string">          hostPath:</span></span><br><span class="line"><span class="string">            path: /ddhome/resource</span></span><br><span class="line"><span class="string">        - name: log</span></span><br><span class="line"><span class="string">          hostPath:</span></span><br><span class="line"><span class="string">            path: /ddhome/log/nginx</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">  namespace: $&#123;BRANCH&#125;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - name: http</span></span><br><span class="line"><span class="string">      port: 80</span></span><br><span class="line"><span class="string">      targetPort: 80</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: networking.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: Ingress</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">  namespace: $&#123;branch&#125;</span></span><br><span class="line"><span class="string">  annotations:</span></span><br><span class="line"><span class="string">    nginx.ingress.kubernetes.io/use-regex: &quot;true&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  rules:</span></span><br><span class="line"><span class="string">    - host:</span></span><br><span class="line"><span class="string">      http:</span></span><br><span class="line"><span class="string">        paths:</span></span><br><span class="line"><span class="string">          - path: /$&#123;path&#125;</span></span><br><span class="line"><span class="string">            pathType: Prefix</span></span><br><span class="line"><span class="string">            backend:</span></span><br><span class="line"><span class="string">              service:</span></span><br><span class="line"><span class="string">                name: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">                port:</span></span><br><span class="line"><span class="string">                  number: 80</span></span><br><span class="line"><span class="string">  ingressClassName: nginx</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        writeFile <span class="attr">file:</span> <span class="string">&quot;/tmp/$&#123;env.JOB_NAME&#125;/Dockerfile&quot;</span>, <span class="attr">text:</span> dockerfileContent</span><br><span class="line">        sh <span class="string">&quot;cp -rf ./$&#123;buildPath&#125; /tmp/$&#123;env.JOB_NAME&#125;/dist&quot;</span></span><br><span class="line">        <span class="keyword">def</span> app = docker.build(tag, <span class="string">&quot;-f /tmp/$&#123;env.JOB_NAME&#125;/Dockerfile /tmp/$&#123;env.JOB_NAME&#125;&quot;</span>)</span><br><span class="line">        sh <span class="string">&quot;rm -rf /tmp/$&#123;env.JOB_NAME&#125;/dist&quot;</span></span><br><span class="line">        writeFile <span class="attr">file:</span> k8sTemplatePath, <span class="attr">text:</span> k8sTemplate</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stage(<span class="string">&#x27;推送镜像&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">def</span> dockerImage = docker.image(<span class="string">&quot;$&#123;tag&#125;&quot;</span>)</span><br><span class="line">        docker.withRegistry(<span class="string">&quot;$&#123;harborUrl&#125;&quot;</span>, <span class="string">&quot;1ecaf8ab-14ad-4890-befd-b58c178e1b61&quot;</span>) &#123;</span><br><span class="line">        dockerImage.push()</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stage(<span class="string">&#x27;发布k8s集群&#x27;</span>)&#123;</span><br><span class="line">           <span class="keyword">if</span> ((<span class="string">&quot;$&#123;branch&#125;&quot;</span>.contains(<span class="string">&quot;master&quot;</span>)))&#123;</span><br><span class="line">            echo <span class="string">&quot;当前镜像版本号: $&#123;tag&#125;&quot;</span></span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="keyword">def</span> name = k8sTemplatePath.tokenize(<span class="string">&#x27;/&#x27;</span>).last()</span><br><span class="line">                  sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                       cat &quot;$&#123;k8sTemplatePath&#125;&quot; | ssh root@$&#123;k8s_master&#125; &quot;cat &gt; /ddhome/k8s/$&#123;name&#125;;kubectl delete -f /ddhome/k8s/$&#123;name&#125;; kubectl apply -f /ddhome/k8s/$&#123;name&#125;&quot;</span></span><br><span class="line"><span class="string">                      &quot;&quot;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">           &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>安装如下：</p><p><img src="https://img.fuhouyu.com/2023-04-08-150551.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Jenkins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes 使用nfs作为存储卷</title>
      <link href="/2023/04/08/Linux/Kubernetes%20%E9%83%A8%E7%BD%B2%E5%AD%98%E5%82%A8%E5%8D%B7/"/>
      <url>/2023/04/08/Linux/Kubernetes%20%E9%83%A8%E7%BD%B2%E5%AD%98%E5%82%A8%E5%8D%B7/</url>
      
        <content type="html"><![CDATA[<ul><li><p>Kubernetes 不包含内部 NFS 配置器。需要使用外部配置程序来创建 NFS 存储类</p><p><a href="[GitHub - kubernetes-sigs/nfs-subdir-external-provisioner：远程 NFS 服务器上的动态 sub-dir volume provisioner。](https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">NFS外部配置程序</a>)</p></li></ul><h5 id="安装nfs-server"><a href="#安装nfs-server" class="headerlink" title="安装nfs-server"></a>安装nfs-server</h5><h6 id="安装-启动nfs-server"><a href="#安装-启动nfs-server" class="headerlink" title="安装/启动nfs-server"></a>安装/启动nfs-server</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装nfs-utils</span></span><br><span class="line">yum install nfs-utils</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动nfs服务器</span></span><br><span class="line">systemctl restart nfs-server</span><br></pre></td></tr></table></figure><h6 id="设置共享目录"><a href="#设置共享目录" class="headerlink" title="设置共享目录"></a>设置共享目录</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/exports</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如下</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/ddhome *(rw,<span class="built_in">sync</span>,no_subtree_check)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数说明</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/ddhome 文件系统路径，</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">* 表示所有ip都可以访问该nfs</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rw 读写权限</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">sync</span> 同步方式，也可以使用async</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no_subtree_check 禁止检查子目录的权限</span></span><br></pre></td></tr></table></figure><ul><li>完毕后，重启nfs-server。<code>systemctl restart nfs-server</code></li></ul><h5 id="部署rbac"><a href="#部署rbac" class="headerlink" title="部署rbac"></a>部署rbac</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><h5 id="部署nfs-client"><a href="#部署nfs-client" class="headerlink" title="部署nfs-client"></a>部署nfs-client</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.k8s.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">k8s-sigs.io/nfs-subdir-external-provisioner</span> <span class="comment"># 这里的名称需要与storageclass中的provisioner名称一致</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&lt;nfs服务器地址&gt;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&lt;nfs存储的地址&gt;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="string">&lt;nfs服务器地址&gt;</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">&lt;nfs存储的地址&gt;</span></span><br></pre></td></tr></table></figure><h5 id="部署storageClass"><a href="#部署storageClass" class="headerlink" title="部署storageClass"></a>部署storageClass</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">config-nfs</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">k8s-sigs.io/nfs-subdir-external-provisioner</span> <span class="comment"># 这里的名称需要与nfs-client中的provisioner名称一致</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span> <span class="comment"># 保留卷</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="comment"># 这里可以指定nfs中的路径</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/ddhome/nfs/resource</span></span><br><span class="line">  <span class="comment"># 是否归档，如果为true，则在pvc删除之前，会将内容存档到一个tar文件中</span></span><br><span class="line">  <span class="attr">archiveOnDelete:</span> <span class="string">&quot;false&quot;</span></span><br></pre></td></tr></table></figure><h5 id="部署pvc"><a href="#部署pvc" class="headerlink" title="部署pvc"></a>部署pvc</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">config-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">config-nfs</span> <span class="comment"># storageClass中的名称</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span> <span class="comment"># 卷可以被一个节点以读写方式挂载。 ReadWriteOnce 访问模式也允许运行在同一节点上的多个 Pod 访问卷。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadOnlyMany</span> <span class="comment"># 卷可以被多个节点以只读方式挂载。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span> <span class="comment"># 卷可以被多个节点以读写方式挂载。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOncePod</span> <span class="comment"># 卷可以被单个 Pod 以读写方式挂载。 如果你想确保整个集群中只有一个 Pod 可以读取或写入该 PVC， 请使用 ReadWriteOncePod 访问模式。这只支持 CSI 卷以及需要 Kubernetes 1.22 以上版本</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">2Gi</span> <span class="comment"># 分配2Gi大小</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>powerdns 安装</title>
      <link href="/2023/02/09/Linux/powerdns/"/>
      <url>/2023/02/09/Linux/powerdns/</url>
      
        <content type="html"><![CDATA[<h4 id="更新软件源，安装软件"><a href="#更新软件源，安装软件" class="headerlink" title="更新软件源，安装软件"></a>更新软件源，安装软件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装epel源</span></span><br><span class="line">yum install -y epel-release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装pdns</span></span><br><span class="line">yum install -y pdns pdns-backend-mysql pdns-recursor mariadb-server mysql</span><br></pre></td></tr></table></figure><h4 id="启动数据库，导入表结构"><a href="#启动数据库，导入表结构" class="headerlink" title="启动数据库，导入表结构"></a>启动数据库，导入表结构</h4><h5 id="启动数据库"><a href="#启动数据库" class="headerlink" title="启动数据库"></a>启动数据库</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动mariadb</span></span><br><span class="line">systemctl start mariadb</span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb</span><br></pre></td></tr></table></figure><h5 id="导入数据表结构"><a href="#导入数据表结构" class="headerlink" title="导入数据表结构"></a>导入数据表结构</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入数据表结构</span></span><br><span class="line">CREATE DATABASE powerdns;</span><br><span class="line"></span><br><span class="line">GRANT ALL ON powerdns.* TO &#x27;powerdns&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;powerdns&#x27;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line">use powerdns;</span><br><span class="line"></span><br><span class="line">CREATE TABLE domains (</span><br><span class="line">  id                    INT AUTO_INCREMENT,</span><br><span class="line">  name                  VARCHAR(255) NOT NULL,</span><br><span class="line">  master                VARCHAR(128) DEFAULT NULL,</span><br><span class="line">  last_check            INT DEFAULT NULL,</span><br><span class="line">  type                  VARCHAR(6) NOT NULL,</span><br><span class="line">  notified_serial       INT DEFAULT NULL,</span><br><span class="line">  account               VARCHAR(40) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE UNIQUE INDEX name_index ON domains(name);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE records (</span><br><span class="line">  id                    BIGINT AUTO_INCREMENT,</span><br><span class="line">  domain_id             INT DEFAULT NULL,</span><br><span class="line">  name                  VARCHAR(255) DEFAULT NULL,</span><br><span class="line">  type                  VARCHAR(10) DEFAULT NULL,</span><br><span class="line">  content               VARCHAR(64000) DEFAULT NULL,</span><br><span class="line">  ttl                   INT DEFAULT NULL,</span><br><span class="line">  prio                  INT DEFAULT NULL,</span><br><span class="line">  change_date           INT DEFAULT NULL,</span><br><span class="line">  disabled              TINYINT(1) DEFAULT 0,</span><br><span class="line">  ordername             VARCHAR(255) BINARY DEFAULT NULL,</span><br><span class="line">  auth                  TINYINT(1) DEFAULT 1,</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE INDEX nametype_index ON records(name,type);</span><br><span class="line">CREATE INDEX domain_id ON records(domain_id);</span><br><span class="line">CREATE INDEX recordorder ON records (domain_id, ordername);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE supermasters (</span><br><span class="line">  ip                    VARCHAR(64) NOT NULL,</span><br><span class="line">  nameserver            VARCHAR(255) NOT NULL,</span><br><span class="line">  account               VARCHAR(40) NOT NULL,</span><br><span class="line">  PRIMARY KEY (ip, nameserver)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE comments (</span><br><span class="line">  id                    INT AUTO_INCREMENT,</span><br><span class="line">  domain_id             INT NOT NULL,</span><br><span class="line">  name                  VARCHAR(255) NOT NULL,</span><br><span class="line">  type                  VARCHAR(10) NOT NULL,</span><br><span class="line">  modified_at           INT NOT NULL,</span><br><span class="line">  account               VARCHAR(40) NOT NULL,</span><br><span class="line">  comment               VARCHAR(64000) NOT NULL,</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE INDEX comments_domain_id_idx ON comments (domain_id);</span><br><span class="line">CREATE INDEX comments_name_type_idx ON comments (name, type);</span><br><span class="line">CREATE INDEX comments_order_idx ON comments (domain_id, modified_at);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE domainmetadata (</span><br><span class="line">  id                    INT AUTO_INCREMENT,</span><br><span class="line">  domain_id             INT NOT NULL,</span><br><span class="line">  kind                  VARCHAR(32),</span><br><span class="line">  content               TEXT,</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE INDEX domainmetadata_idx ON domainmetadata (domain_id, kind);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE cryptokeys (</span><br><span class="line">  id                    INT AUTO_INCREMENT,</span><br><span class="line">  domain_id             INT NOT NULL,</span><br><span class="line">  flags                 INT NOT NULL,</span><br><span class="line">  active                BOOL,</span><br><span class="line">  content               TEXT,</span><br><span class="line">  PRIMARY KEY(id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE INDEX domainidindex ON cryptokeys(domain_id);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE tsigkeys (</span><br><span class="line">  id                    INT AUTO_INCREMENT,</span><br><span class="line">  name                  VARCHAR(255),</span><br><span class="line">  algorithm             VARCHAR(50),</span><br><span class="line">  secret                VARCHAR(255),</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE UNIQUE INDEX namealgoindex ON tsigkeys(name, algorithm);</span><br></pre></td></tr></table></figure><h4 id="配置pdns"><a href="#配置pdns" class="headerlink" title="配置pdns"></a>配置pdns</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置pdns</span></span><br><span class="line">vim /etc/pdns/pdns.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新如下内容</span></span><br><span class="line">launch=gmysql</span><br><span class="line">gmysql-host=127.0.0.1</span><br><span class="line">gmysql-user=powerdns</span><br><span class="line">gmysql-password=powerdns</span><br><span class="line">gmysql-dbname=powerdns</span><br><span class="line">local-port=5300</span><br><span class="line">max-tcp-connections=200</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动pdns</span></span><br><span class="line">systemctl start pdns</span><br><span class="line">systemctl <span class="built_in">enable</span> pdns</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置pdns-recursor</span></span><br><span class="line">vim /etc/pdns-recursor/recursor.conf</span><br><span class="line">...</span><br><span class="line">allow-from=0.0.0.0/0</span><br><span class="line">daemon=<span class="built_in">yes</span></span><br><span class="line"><span class="comment">## 指定指定域名解析地址</span></span><br><span class="line">forward-zones-file=/etc/pdns-recursor/zone</span><br><span class="line"><span class="comment">## 向上递归dns地址，根域</span></span><br><span class="line">forward-zones-recurse=.=114.114.114.114  </span><br><span class="line">local-address=0.0.0.0</span><br><span class="line">local-port=53</span><br><span class="line"></span><br><span class="line">vim /etc/pdns-recursor/zone</span><br><span class="line"><span class="comment">## 拦截两个域名的解析</span></span><br><span class="line">sysadmin.com=127.0.0.1:5300</span><br><span class="line">ops.com=127.0.0.1:5300</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动pdns-recursor</span></span><br><span class="line">systemctl start pdns-recursor</span><br><span class="line">systemctl <span class="built_in">enable</span> pdns-recursor</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装poweradmin</span></span><br><span class="line">yum install -y httpd php php-mcrypt php-pdo php-mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将php文件解压到/var/www/html下</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动httpd</span></span><br><span class="line">systemctl start httpd</span><br><span class="line">systemctl <span class="built_in">enable</span> httpd</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>访问 <a href="http://ip:port/install">http://ip:port/install</a> 进行相关配置</li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Centos </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
