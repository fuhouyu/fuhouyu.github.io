<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>数据加密、脱敏、数据权限处理</title>
      <link href="/2023/04/09/Java/%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86%E3%80%81%E8%84%B1%E6%95%8F%E3%80%81%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E5%A4%84%E7%90%86/"/>
      <url>/2023/04/09/Java/%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86%E3%80%81%E8%84%B1%E6%95%8F%E3%80%81%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E5%A4%84%E7%90%86/</url>
      
        <content type="html"><![CDATA[<ul><li>针对敏感数据，需要进行脱敏加密处理。于是做个记录。</li></ul><h4 id="数据加密"><a href="#数据加密" class="headerlink" title="数据加密"></a>数据加密</h4><ul><li>对数据库的敏感数据，如身份证/手机号，在dao层对数据进行加密处理</li></ul><ol><li>新增国密算法枚举类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD, ElementType.PARAMETER&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> FieldSm4Encrypt &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密密钥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">encKey</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>添加接口，处理字段加解密</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Parameter;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ISm4Service</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密接口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fields       字段集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramsObject object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;          实体对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalAccessException 反射异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;T&gt; <span class="keyword">void</span> <span class="title function_">encrypt</span><span class="params">(Field[] fields, T paramsObject)</span> <span class="keyword">throws</span> IllegalAccessException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密接口，对入参进行加密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameters   方法参数数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameterMap 参数k/v 映射</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">encrypt</span><span class="params">(Parameter[] parameters,</span></span><br><span class="line"><span class="params">                 Map&lt;Object, Object&gt; parameterMap)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据加密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameter 参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t         需要加密的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;       数据类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加密后的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;T&gt; T <span class="title function_">encrypt</span><span class="params">(Parameter parameter, T t)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> result resultType的实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalAccessException 反射异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;T&gt; <span class="keyword">void</span> <span class="title function_">decrypt</span><span class="params">(T result)</span> <span class="keyword">throws</span> IllegalAccessException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>实现类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.crypto.CryptoException;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.crypto.SmUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.crypto.symmetric.SM4;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.annotations.FieldSm4Encrypt;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.service.ISm4Service;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Parameter;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sm4ServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ISm4Service</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这里可以固定一个默认key，或者通过@Value注入，</span></span><br><span class="line">  <span class="comment">// 他只有在注解的encKey字段为空时，才会使用默认</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_KEY</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">encrypt</span><span class="params">(Field[] fields, T paramsObject)</span> <span class="keyword">throws</span> IllegalAccessException &#123;</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            <span class="comment">//取出所有被FieldSm4Encrypt注解的字段</span></span><br><span class="line">            <span class="type">FieldSm4Encrypt</span> <span class="variable">encryptTransaction</span> <span class="operator">=</span> field.getAnnotation(FieldSm4Encrypt.class);</span><br><span class="line">            <span class="keyword">if</span> (!Objects.isNull(encryptTransaction)) &#123;</span><br><span class="line">                field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> field.get(paramsObject);</span><br><span class="line">                <span class="comment">//暂时只实现String类型的加密</span></span><br><span class="line">                <span class="keyword">if</span> (object <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!StringUtils.hasText((String) object)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//加密</span></span><br><span class="line">                    field.set(paramsObject,</span><br><span class="line">                            <span class="built_in">this</span>.getSm4(encryptTransaction.encKey()).encryptHex((String) object));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">encrypt</span><span class="params">(Parameter[] parameters,</span></span><br><span class="line"><span class="params">                        Map&lt;Object, Object&gt; parameterMap)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Parameter parameter : parameters) &#123;</span><br><span class="line">            <span class="type">FieldSm4Encrypt</span> <span class="variable">fieldSm4Encrypt</span> <span class="operator">=</span> parameter.getDeclaredAnnotation(FieldSm4Encrypt.class);</span><br><span class="line">            <span class="keyword">if</span> (Objects.isNull(fieldSm4Encrypt)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> parameter.getDeclaredAnnotation(Param.class).value();</span><br><span class="line">            <span class="type">String</span> <span class="variable">encValue</span> <span class="operator">=</span> getSm4(fieldSm4Encrypt.encKey()).encryptHex(String.valueOf(parameterMap.get(key)));</span><br><span class="line">            parameterMap.put(key, encValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">encrypt</span><span class="params">(Parameter parameter, T t)</span> &#123;</span><br><span class="line">        <span class="type">FieldSm4Encrypt</span> <span class="variable">fieldSm4Encrypt</span> <span class="operator">=</span> parameter.getDeclaredAnnotation(FieldSm4Encrypt.class);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(fieldSm4Encrypt)) &#123;</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) getSm4(fieldSm4Encrypt.encKey())</span><br><span class="line">                .encryptHex(String.valueOf(t));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">decrypt</span><span class="params">(T result)</span> <span class="keyword">throws</span> IllegalAccessException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(result)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Class&lt;?&gt; resultClass = result.getClass();</span><br><span class="line">        Field[] declaredFields = resultClass.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : declaredFields) &#123;</span><br><span class="line">            <span class="type">FieldSm4Encrypt</span> <span class="variable">fieldSm4Encrypt</span> <span class="operator">=</span> field.getAnnotation(FieldSm4Encrypt.class);</span><br><span class="line">            <span class="keyword">if</span> (!Objects.isNull(fieldSm4Encrypt)) &#123;</span><br><span class="line">                field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> field.get(result);</span><br><span class="line">                <span class="keyword">if</span> (object <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!StringUtils.hasText((String) object)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        field.set(result, <span class="built_in">this</span>.getSm4(fieldSm4Encrypt.encKey()).decryptStr((String) object));</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (CryptoException ignored) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SM4 <span class="title function_">getSm4</span><span class="params">(String encPassword)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = StringUtils.hasText(encPassword) ? encPassword.getBytes(StandardCharsets.UTF_8)</span><br><span class="line">                : DEFAULT_KEY.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        <span class="keyword">return</span> SmUtil.sm4(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>配置拦截器</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.peace.common.mysql.service.ISm4Service;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.StringPool;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.cache.CacheKey;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.Executor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.BoundSql;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.MappedStatement;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Interceptor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Intercepts;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Invocation;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Signature;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.ResultHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.RowBounds;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Intercepts(&#123;</span></span><br><span class="line"><span class="meta">        @Signature(</span></span><br><span class="line"><span class="meta">                type = Executor.class,</span></span><br><span class="line"><span class="meta">                method = &quot;query&quot;,</span></span><br><span class="line"><span class="meta">                args = &#123;MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class, CacheKey.class, BoundSql.class&#125;),</span></span><br><span class="line"><span class="meta">        @Signature(type = Executor.class, method = &quot;update&quot;, args = &#123;MappedStatement.class, Object.class&#125;),</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sm4ParmeterInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ISm4Service sm4Service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">statement</span> <span class="operator">=</span> invocation.getArgs()[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> MappedStatement) &#123;</span><br><span class="line">            <span class="built_in">this</span>.parameterHandler(invocation, (MappedStatement) statement);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> invocation.proceed();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parameterHandler</span><span class="params">(Invocation invocation, MappedStatement statement)</span> <span class="keyword">throws</span> IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">parameter</span> <span class="operator">=</span> invocation.getArgs()[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(parameter)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="built_in">this</span>.getDaoTargetMethod(statement);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(method)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (parameter <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            invocation.getArgs()[<span class="number">1</span>] = sm4Service.encrypt(method.getParameters()[<span class="number">0</span>], parameter);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameter <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">            sm4Service.encrypt(method.getParameters(), (Map&lt;Object, Object&gt;) parameter);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sm4Service.encrypt(parameter.getClass().getDeclaredFields(), parameter);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取dao层方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mappedStatement statement</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Method <span class="title function_">getDaoTargetMethod</span><span class="params">(MappedStatement mappedStatement)</span> &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">namespace</span> <span class="operator">=</span> mappedStatement.getId();</span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> namespace.substring(<span class="number">0</span>, namespace.lastIndexOf(StringPool.DOT));</span><br><span class="line">            <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> namespace.substring(namespace.lastIndexOf(StringPool.DOT) + <span class="number">1</span>);</span><br><span class="line">            Method[] ms = Class.forName(className).getMethods();</span><br><span class="line">            <span class="keyword">for</span> (Method m : ms) &#123;</span><br><span class="line">                <span class="keyword">if</span> (m.getName().equals(methodName)) &#123;</span><br><span class="line">                    method = m;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException | ClassNotFoundException e) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;拦截器解析dao层方法失败:&#123;&#125; &quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>添加返回结果的拦截器</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.peace.common.mysql.service.ISm4Service;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.resultset.ResultSetHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Interceptor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Intercepts;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Invocation;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Signature;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Intercepts(&#123;</span></span><br><span class="line"><span class="meta">        @Signature(type = ResultSetHandler.class, method = &quot;handleResultSets&quot;, args = &#123;Statement.class&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sm4ResultInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ISm4Service sm4Service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 取出查询的结果</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">resultObject</span> <span class="operator">=</span> invocation.proceed();</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(resultObject)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 集合解密</span></span><br><span class="line">        <span class="keyword">if</span> (resultObject <span class="keyword">instanceof</span> List&lt;?&gt;) &#123;</span><br><span class="line">            List&lt;?&gt; resultList = (List&lt;?&gt;) resultObject;</span><br><span class="line">            <span class="keyword">if</span> (!CollectionUtils.isEmpty(resultList)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Object result : resultList) &#123;</span><br><span class="line">                    sm4Service.decrypt(result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 单条解密</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sm4Service.decrypt(resultObject);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resultObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>添加config配置类，bean交由spring管理</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.peace.common.mysql.handler.MybatisSqlInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.interceptor.Sm4ParmeterInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.interceptor.Sm4ResultInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.service.ISm4Service;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Sm4ParmeterInterceptor <span class="title function_">sm4ParmeterInterceptor</span><span class="params">(ISm4Service sm4Service)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Sm4ParmeterInterceptor</span>(sm4Service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Sm4ResultInterceptor <span class="title function_">sm4ResultInterceptor</span><span class="params">(ISm4Service sm4Service)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Sm4ResultInterceptor</span>(sm4Service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>后续可以将枚举注解抽离为对称与非对称两种注解，针对不同场景，增加扩展项</li></ul><h4 id="数据脱敏"><a href="#数据脱敏" class="headerlink" title="数据脱敏"></a>数据脱敏</h4><ul><li>敏感数据从数据库取出后，需要解密为真实数据，但是数据不能直接暴露给前端，需要进行脱敏，隐藏关键位数据。</li><li>即数据从controller层返回时，数据进行序列化时脱敏数据</li></ul><ol><li>新增数据脱敏策略类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SensitiveStrategy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取策略类型键值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 策略类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Map&lt;String, Function&lt;String, String&gt;&gt; <span class="title function_">getStrategyFunctionMap</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>默认策略类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.core.text.CharSequenceUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultSensitiveFactory</span> <span class="keyword">implements</span> <span class="title class_">SensitiveStrategy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_CARD_SENSITIVE</span> <span class="operator">=</span> <span class="string">&quot;idCard&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PHONE_NUM_SENSITIVE</span> <span class="operator">=</span> <span class="string">&quot;phoneNum&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SensitiveStrategy sensitiveStrategy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Function&lt;String, String&gt;&gt; functionMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">DefaultSensitiveFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        initDefaultStrategy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SensitiveStrategy <span class="title function_">getDefaultStrategy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(sensitiveStrategy)) &#123;</span><br><span class="line">            sensitiveStrategy = <span class="keyword">new</span> <span class="title class_">DefaultSensitiveFactory</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sensitiveStrategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initDefaultStrategy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.functionMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">      <span class="comment">// 添加默认实现，手机号/身份证脱敏策略</span></span><br><span class="line">        functionMap.put(ID_CARD_SENSITIVE, (s) -&gt; CharSequenceUtil.hide(s, <span class="number">1</span>, s.length() - <span class="number">1</span>));</span><br><span class="line">        functionMap.put(PHONE_NUM_SENSITIVE, (s) -&gt; CharSequenceUtil.hide(s, <span class="number">3</span>, s.length() - <span class="number">4</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Function&lt;String, String&gt;&gt; <span class="title function_">getStrategyFunctionMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> functionMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加策略</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> strategyName 策略名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> function oldStr, encStr转换</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加密策略</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SensitiveStrategy <span class="title function_">addStrategy</span><span class="params">(</span></span><br><span class="line"><span class="params">            String strategyName,</span></span><br><span class="line"><span class="params">            Function&lt;String, String&gt; function)</span> &#123;</span><br><span class="line">        <span class="type">SensitiveStrategy</span> <span class="variable">defaultStrategy</span> <span class="operator">=</span> getDefaultStrategy();</span><br><span class="line">        Map&lt;String, Function&lt;String, String&gt;&gt; strategyFunctionMap = defaultStrategy.getStrategyFunctionMap();</span><br><span class="line">        strategyFunctionMap.put(strategyName, function);</span><br><span class="line">        <span class="keyword">return</span> defaultStrategy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>脱敏注解类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JacksonAnnotationsInside;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.annotation.JsonSerialize;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.serialize.SensitiveSerialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@JacksonAnnotationsInside</span></span><br><span class="line"><span class="meta">@JsonSerialize(</span></span><br><span class="line"><span class="meta">        using = SensitiveSerialize.class</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> FieldSensitive &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 策略类型</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 策略类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol><li>序列化类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonGenerator;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.BeanProperty;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JsonMappingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JsonSerializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializerProvider;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ser.ContextualSerializer;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.annotations.FieldSensitive;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.strategy.DefaultSensitiveFactory;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.strategy.SensitiveStrategy;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SensitiveSerialize</span> <span class="keyword">extends</span> <span class="title class_">JsonSerializer</span>&lt;String&gt; <span class="keyword">implements</span> <span class="title class_">ContextualSerializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SensitiveStrategy sensitiveStrategy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SensitiveSerialize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sensitiveStrategy = DefaultSensitiveFactory.getDefaultStrategy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(String value, JsonGenerator gen, SerializerProvider serializers)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Function&lt;String, String&gt; function = sensitiveStrategy.getStrategyFunctionMap().get(type);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(function)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;策略类型为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        gen.writeString(function.apply(value));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> JsonSerializer&lt;?&gt; createContextual(SerializerProvider serializerProvider, BeanProperty property) <span class="keyword">throws</span> JsonMappingException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.equals(property.getType().getRawClass(), String.class)) &#123;</span><br><span class="line">            <span class="type">FieldSensitive</span> <span class="variable">fieldSensitive</span> <span class="operator">=</span> <span class="built_in">this</span>.getAnnotation(property);</span><br><span class="line">            <span class="keyword">if</span> (Objects.isNull(fieldSensitive)) &#123;</span><br><span class="line">                <span class="keyword">return</span> serializerProvider.findNullValueSerializer(<span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.setType(fieldSensitive.value());</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> serializerProvider.findKeySerializer(property.getType(), property);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> FieldSensitive <span class="title function_">getAnnotation</span><span class="params">(BeanProperty property)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.isNull(property.getAnnotation(FieldSensitive.class))</span><br><span class="line">                ? property.getContextAnnotation(FieldSensitive.class)</span><br><span class="line">                : property.getAnnotation(FieldSensitive.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>在返回的vo层，对需要脱敏的对象字段使用</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FieldSensitive(DefaultSensitiveFactory.PHONE_NUM_SENSITIVE)</span></span><br><span class="line"><span class="keyword">private</span> String phone;</span><br></pre></td></tr></table></figure><h4 id="数据权限拦截"><a href="#数据权限拦截" class="headerlink" title="数据权限拦截"></a>数据权限拦截</h4><ul><li><p>在系统中，需要针对每个角色制定不同的数据权限，如角色1，只能访问本部门的数据，角色2可以访问部门及其子部门的数据，所以需要在sql解析时拦截，对数据权限进行添加</p></li><li><p>这里选择实现Mybatis-plus的DataPermissionHandler，对数据权限进行处理</p><ol><li>数据权限枚举类</li></ol></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">DataScopeEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义数据权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ALL(<span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CUSTOM(<span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 本部门</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DEPT(<span class="number">3</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 部门及其子部门</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DEPT_AND_SUB(<span class="number">4</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SELF(<span class="number">5</span>),</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> scope;</span><br><span class="line"></span><br><span class="line">    DataScopeEnum(<span class="type">int</span> scope) &#123;</span><br><span class="line">        <span class="built_in">this</span>.scope = scope;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isAll</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ALL.scope == value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isCustom</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CUSTOM.scope == value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isDeptAndSub</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DEPT_AND_SUB.scope == value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isDept</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DEPT.scope == value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isSelf</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SELF.scope == value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getScope</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> scope;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol><li>数据权限注解</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.peace.common.mysql.enums.DataScopeEnum;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 数据权限注解</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fuhouyu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2023/3/31 21:28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DataPermission &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 部门表别名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 部门表别名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">deptAlias</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 部门列名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 部门列名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">deptColumn</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;dept_id&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户表别名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户表别名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">userAlias</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户列</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">userColumn</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;create_user&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询的前缀</span></span><br><span class="line"><span class="comment">     * 在注解为类级别时，将会验证当前前缀是否为查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 查询的前缀</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] queryPrefix() <span class="keyword">default</span> &#123;<span class="string">&quot;query&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;select&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否是左查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 是，默认为false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isLeftJoin</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当角色不存在时，默认的角色权限类型</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 当前自己创建的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DataScopeEnum <span class="title function_">defaultScopeEnum</span><span class="params">()</span> <span class="keyword">default</span> DataScopeEnum.SELF;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol><li>自定义权限拦截器</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.StringPool;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.handler.DataPermissionHandler;</span><br><span class="line"><span class="keyword">import</span> com.google.protobuf.Empty;</span><br><span class="line"><span class="keyword">import</span> com.peace.api.dept.SysDeptGrpc;</span><br><span class="line"><span class="keyword">import</span> com.peace.api.dept.SysDeptServiceGrpc;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.annotations.DataPermission;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.enums.DataScopeEnum;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.util.context.UserThreadLocal;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.util.pojo.SysDept;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.util.pojo.SysRole;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> net.sf.jsqlparser.expression.Expression;</span><br><span class="line"><span class="keyword">import</span> net.sf.jsqlparser.expression.operators.conditional.AndExpression;</span><br><span class="line"><span class="keyword">import</span> net.sf.jsqlparser.parser.CCJSqlParserUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomDataPermissionHandler</span> <span class="keyword">implements</span> <span class="title class_">DataPermissionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// gprc 远程调用的实现,用于获取部门集合</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GRpcService deptService;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实现部门及子部门的左连接sql查询</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEPT_AND_SUB_LEFT_SQL</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 自定义的部门权限查询</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CUSTOM_LEFT_SQL</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomDataPermissionHandler</span><span class="params">(GRpcService deptService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.deptService = deptService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> Expression <span class="title function_">getSqlSegment</span><span class="params">(Expression where, String mappedStatementId)</span> &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(mappedStatementId.substring(<span class="number">0</span>, mappedStatementId.lastIndexOf(StringPool.DOT)));</span><br><span class="line">        <span class="type">String</span> <span class="variable">currentMethodName</span> <span class="operator">=</span> mappedStatementId.substring(mappedStatementId.lastIndexOf(StringPool.DOT) + <span class="number">1</span>);</span><br><span class="line">        Method[] methods = clazz.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">            <span class="type">DataPermission</span> <span class="variable">dataPermission</span> <span class="operator">=</span> method.getAnnotation(DataPermission.class);</span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(dataPermission) &amp;&amp; Objects.equals(method.getName(), currentMethodName)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.dataScopeFilter(dataPermission, where);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">DataPermission</span> <span class="variable">dataPermission</span> <span class="operator">=</span> clazz.getAnnotation(DataPermission.class);</span><br><span class="line">        <span class="comment">// 判断类</span></span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(dataPermission)) &#123;</span><br><span class="line">            <span class="comment">// 类级别注解不为空，判断当前方法的值是否为该前缀</span></span><br><span class="line">            String[] queryPrefix = dataPermission.queryPrefix();</span><br><span class="line">            <span class="keyword">for</span> (String prefix : queryPrefix) &#123;</span><br><span class="line">                <span class="keyword">if</span> (currentMethodName.startsWith(prefix)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.dataScopeFilter(dataPermission, where);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> where;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据权限过滤</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataPermission 数据权限注解</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> where          添加where 表达式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 拼接后的sql表达式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">private</span> Expression <span class="title function_">dataScopeFilter</span><span class="params">(DataPermission dataPermission, Expression where)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">deptAlias</span> <span class="operator">=</span> dataPermission.deptAlias();</span><br><span class="line">        <span class="type">String</span> <span class="variable">userAlias</span> <span class="operator">=</span> dataPermission.userAlias();</span><br><span class="line">        <span class="type">String</span> <span class="variable">deptColumn</span> <span class="operator">=</span> dataPermission.deptColumn();</span><br><span class="line">        <span class="type">String</span> <span class="variable">userColumn</span> <span class="operator">=</span> dataPermission.userColumn();</span><br><span class="line">        <span class="type">String</span> <span class="variable">deptColumnName</span> <span class="operator">=</span> StrUtil.isNotBlank(deptAlias) ? (deptAlias + StringPool.DOT + deptColumn) : deptColumn;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userColumnName</span> <span class="operator">=</span> StrUtil.isNotBlank(userAlias) ? (userAlias + StringPool.DOT + userColumn) : userColumn;</span><br><span class="line"></span><br><span class="line">        <span class="type">SysRole</span> <span class="variable">role</span> <span class="operator">=</span> UserThreadLocal.getBasicUser().getSysRole();</span><br><span class="line">        <span class="type">SysDept</span> <span class="variable">sysDept</span> <span class="operator">=</span> UserThreadLocal.getBasicUser().getSysDept();</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">deptId</span> <span class="operator">=</span> Objects.nonNull(sysDept) ? sysDept.getId() : -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 如果用户不存在角色，为默认，则使他的值为当前自己</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">dataScope</span> <span class="operator">=</span> Objects.isNull(role) ? dataPermission.defaultScopeEnum().getScope() : role.getDataScope();</span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">leftJoin</span> <span class="operator">=</span> dataPermission.isLeftJoin();</span><br><span class="line">        <span class="keyword">if</span> (DataScopeEnum.isAll(dataScope)) &#123;</span><br><span class="line">            <span class="comment">// 返回所有的权限</span></span><br><span class="line">            <span class="keyword">return</span> where;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DataScopeEnum.isCustom(dataScope)) &#123;</span><br><span class="line">            <span class="comment">// 自定义数据权限</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> leftJoin ?</span><br><span class="line">                    String.format(CUSTOM_LEFT_SQL, role.getId()) : <span class="built_in">this</span>.concatRpcDeptDataScopeSql();</span><br><span class="line">            sb.append(deptColumnName)</span><br><span class="line">                    .append(sql);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DataScopeEnum.isDeptAndSub(dataScope)) &#123;</span><br><span class="line">            <span class="comment">// 当前部门及其子部门的数据权限</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> leftJoin ?</span><br><span class="line">                    String.format(DEPT_AND_SUB_LEFT_SQL, deptId) : <span class="built_in">this</span>.concatRpcDeptDataScopeSql();</span><br><span class="line">            sb.append(deptColumnName)</span><br><span class="line">                    .append(sql);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DataScopeEnum.isDept(dataScope)) &#123;</span><br><span class="line">            <span class="comment">// 仅当前部门的数据权限</span></span><br><span class="line">            sb.append(deptColumnName).append(<span class="string">&quot; = &quot;</span>).append(deptId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 当前用户的数据权限</span></span><br><span class="line">            sb.append(userColumnName).append(<span class="string">&quot; = &quot;</span>).append(<span class="string">&quot;&#x27;&quot;</span>).append(UserThreadLocal.getBasicUser().getUsername()).append(<span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> sb.toString();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isAllBlank(sql)) &#123;</span><br><span class="line">            <span class="keyword">return</span> where;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> CCJSqlParserUtil.parseExpression(sql);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(where)) &#123;</span><br><span class="line">            <span class="keyword">return</span> expression;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AndExpression</span>(where, expression);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拼接部门sql</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 部门sql</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">concatRpcDeptDataScopeSql</span><span class="params">()</span> &#123;</span><br><span class="line">        SysDeptGrpc.<span class="type">DataScopeResult</span> <span class="variable">userDataScope</span> <span class="operator">=</span> deptService.getDeptIdListByCurrentUserDataScope(Empty.newBuilder().build());</span><br><span class="line">        List&lt;Long&gt; deptIdList = userDataScope.getDeptIdListList();</span><br><span class="line">        <span class="keyword">if</span> (deptIdList.isEmpty()) &#123;</span><br><span class="line">            deptIdList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">            log.warn(<span class="string">&quot;用户的自定义角色数据权限为空&quot;</span>);</span><br><span class="line">            deptIdList.add(-<span class="number">1L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot; IN (&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Long deptId : deptIdList) &#123;</span><br><span class="line">            sb.append(deptId)</span><br><span class="line">                    .append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sb.deleteCharAt(sb.length() - <span class="number">1</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h5><ul><li>在使用pageHelper和dataPermissionHandler时，分页插件获取count的拦截，要优先处理于数据权限的处理器，所以要设置插件的顺序</li><li>在<a href="https://github.com/pagehelper/pagehelper-spring-boot">pageHelper</a>的文档中有如下文档</li></ul><p><img src="https://img.fuhouyu.com/2023-04-09-025307.png" alt=""></p><ul><li>关于插件顺序的讲解，具体可看<a href="https://github.com/pagehelper/Mybatis-PageHelper/blob/master/wikis/zh/Interceptor.md">Executor 拦截器高级教程</a></li></ul><p>所以在配置类中，添加如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.inner.BlockAttackInnerInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.inner.DataPermissionInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.autoconfigure.PageHelperAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> com.peace.api.dept.SysDeptServiceGrpc;</span><br><span class="line"><span class="keyword">import</span> com.peace.common.mysql.handler.CustomDataPermissionHandler;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> net.devh.boot.grpc.client.inject.GrpcClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureAfter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackageClasses = MybatisPlusAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="comment">// 使当前配置，在分页插件之后执行</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(PageHelperAutoConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusAutoConfiguration</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SqlSessionFactory&gt; sqlSessionFactoryList;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 远程调用</span></span><br><span class="line">    <span class="keyword">private</span> GRpcService deptService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (SqlSessionFactory sqlSessionFactory : sqlSessionFactoryList) &#123;</span><br><span class="line">            org.apache.ibatis.session.<span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> sqlSessionFactory.getConfiguration();</span><br><span class="line">            configuration.addInterceptor(mybatisPlusInterceptor());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">BlockAttackInnerInterceptor</span>());</span><br><span class="line">        <span class="type">DataPermissionInterceptor</span> <span class="variable">dataPermissionInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataPermissionInterceptor</span>(<span class="keyword">new</span> <span class="title class_">CustomDataPermissionHandler</span>(deptService));</span><br><span class="line">        interceptor.addInnerInterceptor(dataPermissionInterceptor);</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes 使用nfs作为存储卷</title>
      <link href="/2023/04/08/Linux/Kubernetes%20%E9%83%A8%E7%BD%B2%E5%AD%98%E5%82%A8%E5%8D%B7/"/>
      <url>/2023/04/08/Linux/Kubernetes%20%E9%83%A8%E7%BD%B2%E5%AD%98%E5%82%A8%E5%8D%B7/</url>
      
        <content type="html"><![CDATA[<ul><li><p>Kubernetes 不包含内部 NFS 配置器。需要使用外部配置程序来创建 NFS 存储类</p><p><a href="[GitHub - kubernetes-sigs/nfs-subdir-external-provisioner：远程 NFS 服务器上的动态 sub-dir volume provisioner。](https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">NFS外部配置程序</a>)</p></li></ul><h5 id="安装nfs-server"><a href="#安装nfs-server" class="headerlink" title="安装nfs-server"></a>安装nfs-server</h5><h6 id="安装-启动nfs-server"><a href="#安装-启动nfs-server" class="headerlink" title="安装/启动nfs-server"></a>安装/启动nfs-server</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装nfs-utils</span></span><br><span class="line">yum install nfs-utils</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动nfs服务器</span></span><br><span class="line">systemctl restart nfs-server</span><br></pre></td></tr></table></figure><h6 id="设置共享目录"><a href="#设置共享目录" class="headerlink" title="设置共享目录"></a>设置共享目录</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/exports</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如下</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/ddhome *(rw,<span class="built_in">sync</span>,no_subtree_check)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数说明</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/ddhome 文件系统路径，</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">* 表示所有ip都可以访问该nfs</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rw 读写权限</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">sync</span> 同步方式，也可以使用async</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no_subtree_check 禁止检查子目录的权限</span></span><br></pre></td></tr></table></figure><ul><li>完毕后，重启nfs-server。<code>systemctl restart nfs-server</code></li></ul><h5 id="部署rbac"><a href="#部署rbac" class="headerlink" title="部署rbac"></a>部署rbac</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><h5 id="部署nfs-client"><a href="#部署nfs-client" class="headerlink" title="部署nfs-client"></a>部署nfs-client</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.k8s.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">k8s-sigs.io/nfs-subdir-external-provisioner</span> <span class="comment"># 这里的名称需要与storageclass中的provisioner名称一致</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&lt;nfs服务器地址&gt;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&lt;nfs存储的地址&gt;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="string">&lt;nfs服务器地址&gt;</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">&lt;nfs存储的地址&gt;</span></span><br></pre></td></tr></table></figure><h5 id="部署storageClass"><a href="#部署storageClass" class="headerlink" title="部署storageClass"></a>部署storageClass</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">config-nfs</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">k8s-sigs.io/nfs-subdir-external-provisioner</span> <span class="comment"># 这里的名称需要与nfs-client中的provisioner名称一致</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span> <span class="comment"># 保留卷</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="comment"># 这里可以指定nfs中的路径</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/ddhome/nfs/resource</span></span><br><span class="line">  <span class="comment"># 是否归档，如果为true，则在pvc删除之前，会将内容存档到一个tar文件中</span></span><br><span class="line">  <span class="attr">archiveOnDelete:</span> <span class="string">&quot;false&quot;</span></span><br></pre></td></tr></table></figure><h5 id="部署pvc"><a href="#部署pvc" class="headerlink" title="部署pvc"></a>部署pvc</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">config-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">config-nfs</span> <span class="comment"># storageClass中的名称</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span> <span class="comment"># 卷可以被一个节点以读写方式挂载。 ReadWriteOnce 访问模式也允许运行在同一节点上的多个 Pod 访问卷。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadOnlyMany</span> <span class="comment"># 卷可以被多个节点以只读方式挂载。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span> <span class="comment"># 卷可以被多个节点以读写方式挂载。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOncePod</span> <span class="comment"># 卷可以被单个 Pod 以读写方式挂载。 如果你想确保整个集群中只有一个 Pod 可以读取或写入该 PVC， 请使用 ReadWriteOncePod 访问模式。这只支持 CSI 卷以及需要 Kubernetes 1.22 以上版本</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">2Gi</span> <span class="comment"># 分配2Gi大小</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jenkins 自动化流水线部署</title>
      <link href="/2023/04/08/Linux/Jenkins%20%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%81%E6%B0%B4%E7%BA%BF%E9%83%A8%E7%BD%B2/"/>
      <url>/2023/04/08/Linux/Jenkins%20%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%81%E6%B0%B4%E7%BA%BF%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h4 id="必备软件"><a href="#必备软件" class="headerlink" title="必备软件"></a>必备软件</h4><h5 id="安装docker-containerd"><a href="#安装docker-containerd" class="headerlink" title="安装docker/containerd"></a>安装docker/containerd</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install docker</span><br></pre></td></tr></table></figure><h5 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装git</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install git</span><br></pre></td></tr></table></figure><p>安装maven/mvnd</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载mvnd</span></span><br><span class="line">wget https://github.com/apache/maven-mvnd/releases/download/1.0-m6/maven-mvnd-1.0-m6-m39-linux-amd64.zip</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压mvnd</span></span><br><span class="line">unzip maven-mvnd-1.0-m6-m39-linux-amd64.zip -d ./mvnd</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="安装jenkins"><a href="#安装jenkins" class="headerlink" title="安装jenkins"></a>安装jenkins</h5><p><a href="https://www.jenkins.io/zh/download/">Jenkins 的安装和设置</a></p><h6 id="安装必备插件"><a href="#安装必备插件" class="headerlink" title="安装必备插件"></a>安装必备插件</h6><ol><li><p>打开jenkins页面后，根据提示更新</p></li><li><p>更新<a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json">jenkins镜像源</a></p></li><li><p>下载必备Docker Pipeline</p><p><img src="https://img.fuhouyu.com/2023-04-08-130735.png" alt=""></p></li><li><p>在全局工具中，定义maven</p></li><li><p>定义jenkins的git凭据，复制git凭据id</p></li></ol><h6 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h6><p>新版本的jenkins配置文件在：<code>/usr/lib/systemd/system/jenkins.service</code>目录下</p><p>jenkins新版本至少需要jdk11才可以，如果在之前已经安装过jdk，且小于11，可能会出现无法启动的情况，需要更新环境变量</p><h5 id="打包部署java项目"><a href="#打包部署java项目" class="headerlink" title="打包部署java项目"></a>打包部署java项目</h5><ol><li>新建项目，选择流水线</li></ol><p><img src="https://img.fuhouyu.com/2023-04-08-130916.png" alt=""></p><ol><li><p>勾选选项参数</p><ol><li>添加git选项url</li><li>添加文本参数branch</li><li>添加选项参数 harborUrl，harbor镜像地址</li><li>添加选项参数 k8s_master, master主节点地址</li><li>添加文本参数 service，java模块地址</li><li>添加文件参数 depth，jar目录深度</li></ol><p>如下图所示</p><p><img src="https://img.fuhouyu.com/2023-04-08-142129.png" alt=""></p></li><li><p>使用流水线，定义脚本</p><p><img src="https://img.fuhouyu.com/2023-04-08-131136.png" alt=""></p><p>脚本如下：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line">node &#123;</span><br><span class="line">  <span class="comment">// maven 工具</span></span><br><span class="line">  <span class="keyword">def</span> mvn = tool <span class="string">&#x27;maven&#x27;</span>;</span><br><span class="line">  <span class="comment">// 版本号，以当前时间戳</span></span><br><span class="line">  <span class="keyword">def</span> version = <span class="string">&quot;v&quot;</span> + sh(<span class="attr">script:</span> <span class="string">&quot;date &#x27;+%s&#x27;&quot;</span>, <span class="attr">returnStdout:</span> <span class="literal">true</span>).trim()</span><br><span class="line">  <span class="comment">// 读取的properties 示例如下</span></span><br><span class="line">  <span class="keyword">def</span> properties = readProperties <span class="attr">file:</span> <span class="string">&#x27;/ddhome/data/jenkins/service.properties&#x27;</span></span><br><span class="line">  <span class="comment">// 镜像标签</span></span><br><span class="line">  <span class="keyword">def</span> imageTags = []</span><br><span class="line">  <span class="comment">// k8s 模板</span></span><br><span class="line">  <span class="keyword">def</span> k8sTemplates = []</span><br><span class="line">  <span class="keyword">def</span> baseHarborUrl = <span class="string">&quot;$&#123;harborUrl&#125;&quot;</span>.tokenize(<span class="string">&#x27;/&#x27;</span>).last()</span><br><span class="line">  <span class="comment">// java启动脚本</span></span><br><span class="line">  <span class="keyword">def</span> startup = <span class="string">&#x27;&#x27;&#x27;#!/bin/bash</span></span><br><span class="line"><span class="string">JAVA_OPT=&quot;java&quot;</span></span><br><span class="line"><span class="string">BASE_DIR=&quot;/home/data&quot;</span></span><br><span class="line"><span class="string">SERVICE_NAME=$1</span></span><br><span class="line"><span class="string">ACTIVE=$2</span></span><br><span class="line"><span class="string">PARAM=$3</span></span><br><span class="line"><span class="string">#===========================================================================================</span></span><br><span class="line"><span class="string"># JVM Configuration</span></span><br><span class="line"><span class="string">#===========================================================================================</span></span><br><span class="line"><span class="string">if  [[ &quot;$JVM_XMS&quot; != &quot;&quot; ]] ;then</span></span><br><span class="line"><span class="string">  JVM_OPT=&quot;$JVM_OPT -Xms$&#123;JVM_XMS&#125;&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [[ &quot;$JVM_XMX&quot; != &quot;&quot; ]]; then</span></span><br><span class="line"><span class="string">  JVM_OPT=&quot;$JVM_OPT -Xmx$&#123;JVM_XMX&#125;&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [[ &quot;$&#123;DEBUG_ENABLED&#125;&quot; == &quot;y&quot; ]]; then</span></span><br><span class="line"><span class="string">  JVM_OPT=&quot;$JVM_OPT -Xrunjdwp:transport=dt_socket,address=*:10000,server=y,suspend=n&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [[ &quot;$JVM_OTHER_PARAMS&quot; != &quot;&quot; ]]; then</span></span><br><span class="line"><span class="string">  JVM_OPT=&quot;$JVM_OPT $&#123;JVM_OTHER_PARAMS&#125;&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [[ &quot;$DUMP_LOG&quot; == &quot;&quot; ]]; then</span></span><br><span class="line"><span class="string">  DUMP_LOG=&quot;/var/log/java_heapdump.hprof&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [[ &quot;$JAVA_LOG&quot; == &quot;&quot; ]]; then</span></span><br><span class="line"><span class="string">  JAVA_LOG=&quot;-Xlog:gc*=debug:file=/var/log/gc.log:utctime,level,tags:filecount=30,filesize=100M&quot;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">JVM_OPT=&quot;$JVM_OPT -XX:-OmitStackTraceInFastThrow -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=$DUMP_LOG&quot;</span></span><br><span class="line"><span class="string">JVM_OPT=&quot;$JVM_OPT $JAVA_LOG&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#===========================================================================================</span></span><br><span class="line"><span class="string"># Setting system properties</span></span><br><span class="line"><span class="string">#===========================================================================================</span></span><br><span class="line"><span class="string">JAVA_OPT=&quot;$JAVA_OPT -jar -DSpring.profiles.active=$ACTIVE $PARAM $START_PARAM $JVM_OPT $&#123;BASE_DIR&#125;/$SERVICE_NAME*.jar&quot;</span></span><br><span class="line"><span class="string">$JAVA_OPT</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  stage(<span class="string">&#x27;拉取代码&#x27;</span>)&#123;</span><br><span class="line">  echo <span class="string">&quot;git pull code&quot;</span></span><br><span class="line">    <span class="comment">// 拉取代码，这里的credentialsId 需要在jenkins的凭据中定义</span></span><br><span class="line">  git(<span class="attr">url:</span> <span class="string">&quot;$&#123;git&#125;&quot;</span>, <span class="attr">branch:</span> <span class="string">&quot;$&#123;branch&#125;&quot;</span>, <span class="attr">credentialsId:</span> <span class="string">&quot;128ee387-1deb-4241-87ae-dfeaeaec448d&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mvnd编译代码</span></span><br><span class="line">  stage(<span class="string">&#x27;编译代码&#x27;</span>)&#123;</span><br><span class="line">echo <span class="string">&quot;编译代码&quot;</span></span><br><span class="line">sh <span class="string">&quot;$&#123;mvn&#125;/bin/mvnd clean install -Dmaven.test.skip=true&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  stage(<span class="string">&#x27;构建docker镜像&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">def</span> serviceArray = <span class="string">&quot;$&#123;service&#125;&quot;</span>.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span>(serviceName <span class="keyword">in</span> serviceArray)&#123;</span><br><span class="line">      <span class="comment">// 基本镜像地址</span></span><br><span class="line">      <span class="keyword">def</span> imageName = <span class="string">&quot;$&#123;baseHarborUrl&#125;/$&#123;branch&#125;/$&#123;serviceName&#125;&quot;</span></span><br><span class="line">      <span class="keyword">def</span> jarPath = <span class="string">&quot;$&#123;env.WORKSPACE&#125;/$&#123;&#x27;**/&#x27; * depth.toInteger()&#125;/$&#123;serviceName&#125;/target/$&#123;serviceName&#125;*.jar&quot;</span></span><br><span class="line">        echo <span class="string">&quot;jar路径:$&#123;jarPath&#125;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> tag = <span class="string">&quot;$&#123;imageName&#125;:$&#123;version&#125;&quot;</span></span><br><span class="line">        echo <span class="string">&quot;tag is $&#123;tag&#125;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> dockerfileContent = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                FROM openjdk:11.0.14.1-jre</span></span><br><span class="line"><span class="string">                COPY ./$&#123;serviceName&#125;.jar /home/data/$&#123;serviceName&#125;.jar</span></span><br><span class="line"><span class="string">                COPY ./startup.sh /home/data/startup.sh</span></span><br><span class="line"><span class="string">                RUN cp -r -f /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="string">                    &amp;&amp; echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone \</span></span><br><span class="line"><span class="string">                    &amp;&amp; chmod +x /root/data/startup.sh \</span></span><br><span class="line"><span class="string">                    &amp;&amp; echo &gt; /etc/apt/sources.list \</span></span><br><span class="line"><span class="string">                    &amp;&amp; echo  &quot;deb http://mirrors.aliyun.com/debian/ stretch main non-free contrib \ndeb-src http://mirrors.aliyun.com/debian/ stretch main non-free contrib \ndeb http://mirrors.aliyun.com/debian-security stretch/updates main \ndeb-src http://mirrors.aliyun.com/debian-security stretch/updates main \ndeb http://mirrors.aliyun.com/debian/ stretch-updates main non-free contrib \ndeb-src http://mirrors.aliyun.com/debian/ stretch-updates main non-free contrib \ndeb http://mirrors.aliyun.com/debian/ stretch-backports main non-free contrib \ndeb-src http://mirrors.aliyun.com/debian/ stretch-backports main non-free contrib&quot; &gt; /etc/apt/sources.list </span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">      <span class="comment">// cpu限制</span></span><br><span class="line">         <span class="keyword">def</span> cpuLimit = properties[<span class="string">&quot;$&#123;serviceName&#125;.cpu.limit&quot;</span>]</span><br><span class="line">      <span class="comment">// 内存限制</span></span><br><span class="line">         <span class="keyword">def</span> memoryLimit = properties[<span class="string">&quot;$&#123;serviceName&#125;.memory.limit&quot;</span>]</span><br><span class="line">      <span class="comment">// http端口</span></span><br><span class="line">         <span class="keyword">def</span> httpPort = properties[<span class="string">&quot;$&#123;serviceName&#125;.port&quot;</span>]</span><br><span class="line">      <span class="comment">// debug端口</span></span><br><span class="line">         <span class="keyword">def</span> debugPort = properties[<span class="string">&quot;$&#123;serviceName&#125;.debug.port&quot;</span>]</span><br><span class="line">      <span class="comment">// k8s模板</span></span><br><span class="line">         <span class="keyword">def</span> k8sTemplate =</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">  namespace: iot-test</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      imagePullSecrets:</span></span><br><span class="line"><span class="string">        - name: harbor-secret</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">        - name: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">          image: $&#123;tag&#125;</span></span><br><span class="line"><span class="string">          imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">          command: [&quot;/home/data/startup.sh&quot;]</span></span><br><span class="line"><span class="string">          args: [&quot;$&#123;serviceName&#125;&quot;, &quot;test&quot;]</span></span><br><span class="line"><span class="string">          resources:</span></span><br><span class="line"><span class="string">           limits:</span></span><br><span class="line"><span class="string">            cpu: $&#123;cpuLimit&#125;</span></span><br><span class="line"><span class="string">            memory: $&#123;memoryLimit&#125;</span></span><br><span class="line"><span class="string">          volumeMounts:</span></span><br><span class="line"><span class="string">            - name: resource</span></span><br><span class="line"><span class="string">              mountPath: /ddhome/resource</span></span><br><span class="line"><span class="string">            - name: log</span></span><br><span class="line"><span class="string">              mountPath: /var/log</span></span><br><span class="line"><span class="string">              subPath: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">      volumes:</span></span><br><span class="line"><span class="string">        - name: resource</span></span><br><span class="line"><span class="string">          hostPath:</span></span><br><span class="line"><span class="string">            path: /ddhome/resource</span></span><br><span class="line"><span class="string">        - name: log</span></span><br><span class="line"><span class="string">          hostPath:</span></span><br><span class="line"><span class="string">            path: /ddhome/log/service</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">  namespace: iot-test</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: $&#123;serviceName&#125;</span></span><br><span class="line"><span class="string">  type: NodePort</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - name: http</span></span><br><span class="line"><span class="string">      port: $&#123;httpPort&#125;</span></span><br><span class="line"><span class="string">      targetPort: $&#123;httpPort&#125;</span></span><br><span class="line"><span class="string">      nodePort: $&#123;httpPort&#125;</span></span><br><span class="line"><span class="string">    - name: debug</span></span><br><span class="line"><span class="string">      port: $&#123;debugPort&#125;</span></span><br><span class="line"><span class="string">      targetPort: $&#123;debugPort&#125;</span></span><br><span class="line"><span class="string">      nodePort: $&#123;debugPort&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">      <span class="comment">// 写入dockerfile文件</span></span><br><span class="line">        writeFile <span class="attr">file:</span> <span class="string">&quot;/tmp/$&#123;serviceName&#125;/Dockerfile&quot;</span>, <span class="attr">text:</span> dockerfileContent</span><br><span class="line">      <span class="comment">// 写入启动脚本</span></span><br><span class="line">        writeFile <span class="attr">file:</span> <span class="string">&quot;/tmp/$&#123;serviceName&#125;/startup.sh&quot;</span>, <span class="attr">text:</span> startup</span><br><span class="line">      <span class="comment">// 拷贝jar路径</span></span><br><span class="line">        sh <span class="string">&quot;cp $&#123;jarPath&#125; /tmp/$&#123;serviceName&#125;/$&#123;serviceName&#125;.jar&quot;</span></span><br><span class="line">      <span class="comment">// docker build </span></span><br><span class="line">        <span class="keyword">def</span> app = docker.build(tag, <span class="string">&quot;-f /tmp/$&#123;serviceName&#125;/Dockerfile /tmp/$&#123;serviceName&#125;&quot;</span>)</span><br><span class="line">      <span class="comment">// 添加标签到数组</span></span><br><span class="line">        imageTags += tag</span><br><span class="line">      <span class="comment">// 写入k8s模板文件，添加进数组</span></span><br><span class="line">        <span class="keyword">def</span> k8sYaml = <span class="string">&quot;/tmp/$&#123;serviceName&#125;/$&#123;serviceName&#125;.yaml&quot;</span></span><br><span class="line">        writeFile <span class="attr">file:</span> k8sYaml, <span class="attr">text:</span> k8sTemplate</span><br><span class="line">        k8sTemplates += k8sYaml</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stage(<span class="string">&#x27;推送docker镜像&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(tag <span class="keyword">in</span> imageTags)&#123;</span><br><span class="line">          <span class="keyword">def</span> dockerImage = docker.image(<span class="string">&quot;$&#123;tag&#125;&quot;</span>)</span><br><span class="line">      docker.withRegistry(<span class="string">&quot;$&#123;harborUrl&#125;&quot;</span>, <span class="string">&#x27;1ecaf8ab-14ad-4890-befd-b58c178e1b61&#x27;</span>) &#123;</span><br><span class="line">            dockerImage.push()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   stage(<span class="string">&#x27;发布到K8s镜像&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(template <span class="keyword">in</span> k8sTemplates)&#123;</span><br><span class="line">        <span class="keyword">def</span> name = template.tokenize(<span class="string">&#x27;/&#x27;</span>).last()</span><br><span class="line">        echo <span class="string">&quot;写入文件&quot;</span></span><br><span class="line">         sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">             cat &quot;$&#123;template&#125;&quot; | ssh root@&quot;$&#123;k8s_master&#125;&quot; &quot;cat &gt; /ddhome/k8s/$&#123;name&#125;;kubectl delete -f /ddhome/k8s/$&#123;name&#125;; kubectl apply -f /ddhome/k8s/$&#123;name&#125;&quot;</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>service.properties示例</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 网关配置</span></span><br><span class="line"> <span class="attr">service-gateway.port</span>=<span class="string">28082</span></span><br><span class="line"> <span class="attr">service-gateway.debug.port</span>=<span class="string">38082</span></span><br><span class="line"> <span class="attr">service-gateway.cpu.limit</span>=<span class="string">&quot;500m&quot;</span></span><br><span class="line"> <span class="attr">service-gateway.memory.limit</span>=<span class="string">&quot;1024Mi&quot;</span></span><br></pre></td></tr></table></figure><p>构建结果如下</p><p><img src="https://img.fuhouyu.com/2023-04-08-143033.png" alt=""></p></li></ol><h5 id="打包部署前端js-容器化"><a href="#打包部署前端js-容器化" class="headerlink" title="打包部署前端js(容器化)"></a>打包部署前端js(容器化)</h5><ol><li><p>新建流水线项目</p></li><li><p>勾选选项参数</p><ol><li>添加选项参数git，添加代码仓地址</li><li>添加分支branch参数</li><li>添加选项参数 harborUrl，harbor镜像地址</li><li>添加选项参数 k8s_master, master主节点地址</li><li>添加文本visitPath参数，通过ingress-nginx访问的后缀url</li><li>添加选项参数buildPath</li></ol><p><img src="https://img.fuhouyu.com/2023-04-08-150731.png" alt=""></p></li></ol><p>脚本如下：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">node &#123;</span><br><span class="line">    <span class="comment">// 时间戳的版本号</span></span><br><span class="line">    <span class="keyword">def</span> version = <span class="string">&quot;v&quot;</span> + sh(<span class="attr">script:</span> <span class="string">&quot;date &#x27;+%s&#x27;&quot;</span>, <span class="attr">returnStdout:</span> <span class="literal">true</span>).trim()</span><br><span class="line">  <span class="comment">// 标签号</span></span><br><span class="line">    <span class="keyword">def</span> tag = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="comment">// k8s存储的yaml</span></span><br><span class="line">    <span class="keyword">def</span> k8sTemplatePath = <span class="string">&quot;/tmp/$&#123;env.JOB_NAME&#125;/$&#123;env.JOB_NAME&#125;.yaml&quot;</span></span><br><span class="line">  <span class="comment">// 可访问的url地址</span></span><br><span class="line">    <span class="keyword">def</span> path = <span class="string">&quot;$&#123;visitPath&#125;&quot;</span> ? <span class="string">&quot;$&#123;visitPath&#125;&quot;</span> : <span class="string">&quot;$&#123;env.JOB_NAME&#125;&quot;</span></span><br><span class="line">  <span class="comment">// 基本的url</span></span><br><span class="line">    <span class="keyword">def</span> baseHarborUrl = <span class="string">&quot;$&#123;harborUrl&#125;&quot;</span>.tokenize(<span class="string">&#x27;/&#x27;</span>).last()</span><br><span class="line">stage(<span class="string">&#x27;拉取代码&#x27;</span>)&#123;</span><br><span class="line">echo <span class="string">&quot;git pull code&quot;</span></span><br><span class="line">git(<span class="attr">url:</span> <span class="string">&quot;$&#123;git&#125;&quot;</span>, <span class="attr">branch:</span> <span class="string">&quot;$&#123;branch&#125;&quot;</span>, <span class="attr">credentialsId:</span> <span class="string">&quot;128ee387-1deb-4241-87ae-dfeaeaec448d&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 编译代码</span></span><br><span class="line">stage(<span class="string">&#x27;编译代码&#x27;</span>)&#123;</span><br><span class="line">echo <span class="string">&quot;编译代码&quot;</span></span><br><span class="line"><span class="keyword">if</span>(<span class="string">&quot;$&#123;branch&#125;&quot;</span> == <span class="string">&#x27;master&#x27;</span>)&#123;</span><br><span class="line">    sh <span class="string">&quot;rm -rf node_modules package-lock.json &amp;&amp; source /etc/profile &amp;&amp; npm install  --legacy-peer-deps &amp;&amp; npm run build:prod&quot;</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    sh <span class="string">&quot;rm -rf node_modules package-lock.json &amp;&amp; source /etc/profile &amp;&amp; npm install  --legacy-peer-deps &amp;&amp; npm run build:$&#123;branch&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stage(<span class="string">&#x27;构建docker镜像&#x27;</span>)&#123;</span><br><span class="line">    echo <span class="string">&quot;容器静态文件存放目录为: $path&quot;</span></span><br><span class="line">        <span class="keyword">def</span> dockerfileContent = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            FROM nginx:stable-alpine3.17</span></span><br><span class="line"><span class="string">            RUN apk add tzdata &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone \</span></span><br><span class="line"><span class="string">                    &amp;&amp; apk del tzdata</span></span><br><span class="line"><span class="string">            COPY &quot;./dist&quot; /usr/share/nginx/html/$&#123;path&#125;</span></span><br><span class="line"><span class="string">          &quot;&quot;&quot;</span></span><br><span class="line">        tag = <span class="string">&quot;$&#123;baseHarborUrl&#125;/$&#123;branch&#125;/$&#123;env.JOB_NAME&#125;:$&#123;version&#125;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> k8sTemplate = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">  namespace: $&#123;BRANCH&#125;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      imagePullSecrets:</span></span><br><span class="line"><span class="string">        - name: harbor-secret</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">        - name: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">          image: $&#123;tag&#125;</span></span><br><span class="line"><span class="string">          imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">          volumeMounts:</span></span><br><span class="line"><span class="string">            - name: resource</span></span><br><span class="line"><span class="string">              mountPath: /ddhome/resource</span></span><br><span class="line"><span class="string">            - name: log</span></span><br><span class="line"><span class="string">              mountPath: /var/log/nginx</span></span><br><span class="line"><span class="string">              subPath: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">      volumes:</span></span><br><span class="line"><span class="string">        - name: resource</span></span><br><span class="line"><span class="string">          hostPath:</span></span><br><span class="line"><span class="string">            path: /ddhome/resource</span></span><br><span class="line"><span class="string">        - name: log</span></span><br><span class="line"><span class="string">          hostPath:</span></span><br><span class="line"><span class="string">            path: /ddhome/log/nginx</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">  namespace: $&#123;BRANCH&#125;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - name: http</span></span><br><span class="line"><span class="string">      port: 80</span></span><br><span class="line"><span class="string">      targetPort: 80</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: networking.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: Ingress</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">  namespace: $&#123;branch&#125;</span></span><br><span class="line"><span class="string">  annotations:</span></span><br><span class="line"><span class="string">    nginx.ingress.kubernetes.io/use-regex: &quot;true&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  rules:</span></span><br><span class="line"><span class="string">    - host:</span></span><br><span class="line"><span class="string">      http:</span></span><br><span class="line"><span class="string">        paths:</span></span><br><span class="line"><span class="string">          - path: /$&#123;path&#125;</span></span><br><span class="line"><span class="string">            pathType: Prefix</span></span><br><span class="line"><span class="string">            backend:</span></span><br><span class="line"><span class="string">              service:</span></span><br><span class="line"><span class="string">                name: $&#123;env.JOB_NAME&#125;</span></span><br><span class="line"><span class="string">                port:</span></span><br><span class="line"><span class="string">                  number: 80</span></span><br><span class="line"><span class="string">  ingressClassName: nginx</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        writeFile <span class="attr">file:</span> <span class="string">&quot;/tmp/$&#123;env.JOB_NAME&#125;/Dockerfile&quot;</span>, <span class="attr">text:</span> dockerfileContent</span><br><span class="line">        sh <span class="string">&quot;cp -rf ./$&#123;buildPath&#125; /tmp/$&#123;env.JOB_NAME&#125;/dist&quot;</span></span><br><span class="line">        <span class="keyword">def</span> app = docker.build(tag, <span class="string">&quot;-f /tmp/$&#123;env.JOB_NAME&#125;/Dockerfile /tmp/$&#123;env.JOB_NAME&#125;&quot;</span>)</span><br><span class="line">        sh <span class="string">&quot;rm -rf /tmp/$&#123;env.JOB_NAME&#125;/dist&quot;</span></span><br><span class="line">        writeFile <span class="attr">file:</span> k8sTemplatePath, <span class="attr">text:</span> k8sTemplate</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stage(<span class="string">&#x27;推送镜像&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">def</span> dockerImage = docker.image(<span class="string">&quot;$&#123;tag&#125;&quot;</span>)</span><br><span class="line">        docker.withRegistry(<span class="string">&quot;$&#123;harborUrl&#125;&quot;</span>, <span class="string">&quot;1ecaf8ab-14ad-4890-befd-b58c178e1b61&quot;</span>) &#123;</span><br><span class="line">        dockerImage.push()</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stage(<span class="string">&#x27;发布k8s集群&#x27;</span>)&#123;</span><br><span class="line">           <span class="keyword">if</span> ((<span class="string">&quot;$&#123;branch&#125;&quot;</span>.contains(<span class="string">&quot;master&quot;</span>)))&#123;</span><br><span class="line">            echo <span class="string">&quot;当前镜像版本号: $&#123;tag&#125;&quot;</span></span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="keyword">def</span> name = k8sTemplatePath.tokenize(<span class="string">&#x27;/&#x27;</span>).last()</span><br><span class="line">                  sh <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                       cat &quot;$&#123;k8sTemplatePath&#125;&quot; | ssh root@$&#123;k8s_master&#125; &quot;cat &gt; /ddhome/k8s/$&#123;name&#125;;kubectl delete -f /ddhome/k8s/$&#123;name&#125;; kubectl apply -f /ddhome/k8s/$&#123;name&#125;&quot;</span></span><br><span class="line"><span class="string">                      &quot;&quot;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">           &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>安装如下：</p><p><img src="https://img.fuhouyu.com/2023-04-08-150551.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Jenkins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>powerdns 安装</title>
      <link href="/2023/02/09/Linux/powerdns/"/>
      <url>/2023/02/09/Linux/powerdns/</url>
      
        <content type="html"><![CDATA[<h4 id="更新软件源，安装软件"><a href="#更新软件源，安装软件" class="headerlink" title="更新软件源，安装软件"></a>更新软件源，安装软件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装epel源</span></span><br><span class="line">yum install -y epel-release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装pdns</span></span><br><span class="line">yum install -y pdns pdns-backend-mysql pdns-recursor mariadb-server mysql</span><br></pre></td></tr></table></figure><h4 id="启动数据库，导入表结构"><a href="#启动数据库，导入表结构" class="headerlink" title="启动数据库，导入表结构"></a>启动数据库，导入表结构</h4><h5 id="启动数据库"><a href="#启动数据库" class="headerlink" title="启动数据库"></a>启动数据库</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动mariadb</span></span><br><span class="line">systemctl start mariadb</span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb</span><br></pre></td></tr></table></figure><h5 id="导入数据表结构"><a href="#导入数据表结构" class="headerlink" title="导入数据表结构"></a>导入数据表结构</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入数据表结构</span></span><br><span class="line">CREATE DATABASE powerdns;</span><br><span class="line"></span><br><span class="line">GRANT ALL ON powerdns.* TO &#x27;powerdns&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;powerdns&#x27;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line">use powerdns;</span><br><span class="line"></span><br><span class="line">CREATE TABLE domains (</span><br><span class="line">  id                    INT AUTO_INCREMENT,</span><br><span class="line">  name                  VARCHAR(255) NOT NULL,</span><br><span class="line">  master                VARCHAR(128) DEFAULT NULL,</span><br><span class="line">  last_check            INT DEFAULT NULL,</span><br><span class="line">  type                  VARCHAR(6) NOT NULL,</span><br><span class="line">  notified_serial       INT DEFAULT NULL,</span><br><span class="line">  account               VARCHAR(40) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE UNIQUE INDEX name_index ON domains(name);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE records (</span><br><span class="line">  id                    BIGINT AUTO_INCREMENT,</span><br><span class="line">  domain_id             INT DEFAULT NULL,</span><br><span class="line">  name                  VARCHAR(255) DEFAULT NULL,</span><br><span class="line">  type                  VARCHAR(10) DEFAULT NULL,</span><br><span class="line">  content               VARCHAR(64000) DEFAULT NULL,</span><br><span class="line">  ttl                   INT DEFAULT NULL,</span><br><span class="line">  prio                  INT DEFAULT NULL,</span><br><span class="line">  change_date           INT DEFAULT NULL,</span><br><span class="line">  disabled              TINYINT(1) DEFAULT 0,</span><br><span class="line">  ordername             VARCHAR(255) BINARY DEFAULT NULL,</span><br><span class="line">  auth                  TINYINT(1) DEFAULT 1,</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE INDEX nametype_index ON records(name,type);</span><br><span class="line">CREATE INDEX domain_id ON records(domain_id);</span><br><span class="line">CREATE INDEX recordorder ON records (domain_id, ordername);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE supermasters (</span><br><span class="line">  ip                    VARCHAR(64) NOT NULL,</span><br><span class="line">  nameserver            VARCHAR(255) NOT NULL,</span><br><span class="line">  account               VARCHAR(40) NOT NULL,</span><br><span class="line">  PRIMARY KEY (ip, nameserver)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE comments (</span><br><span class="line">  id                    INT AUTO_INCREMENT,</span><br><span class="line">  domain_id             INT NOT NULL,</span><br><span class="line">  name                  VARCHAR(255) NOT NULL,</span><br><span class="line">  type                  VARCHAR(10) NOT NULL,</span><br><span class="line">  modified_at           INT NOT NULL,</span><br><span class="line">  account               VARCHAR(40) NOT NULL,</span><br><span class="line">  comment               VARCHAR(64000) NOT NULL,</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE INDEX comments_domain_id_idx ON comments (domain_id);</span><br><span class="line">CREATE INDEX comments_name_type_idx ON comments (name, type);</span><br><span class="line">CREATE INDEX comments_order_idx ON comments (domain_id, modified_at);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE domainmetadata (</span><br><span class="line">  id                    INT AUTO_INCREMENT,</span><br><span class="line">  domain_id             INT NOT NULL,</span><br><span class="line">  kind                  VARCHAR(32),</span><br><span class="line">  content               TEXT,</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE INDEX domainmetadata_idx ON domainmetadata (domain_id, kind);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE cryptokeys (</span><br><span class="line">  id                    INT AUTO_INCREMENT,</span><br><span class="line">  domain_id             INT NOT NULL,</span><br><span class="line">  flags                 INT NOT NULL,</span><br><span class="line">  active                BOOL,</span><br><span class="line">  content               TEXT,</span><br><span class="line">  PRIMARY KEY(id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE INDEX domainidindex ON cryptokeys(domain_id);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE tsigkeys (</span><br><span class="line">  id                    INT AUTO_INCREMENT,</span><br><span class="line">  name                  VARCHAR(255),</span><br><span class="line">  algorithm             VARCHAR(50),</span><br><span class="line">  secret                VARCHAR(255),</span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE UNIQUE INDEX namealgoindex ON tsigkeys(name, algorithm);</span><br></pre></td></tr></table></figure><h4 id="配置pdns"><a href="#配置pdns" class="headerlink" title="配置pdns"></a>配置pdns</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置pdns</span></span><br><span class="line">vim /etc/pdns/pdns.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新如下内容</span></span><br><span class="line">launch=gmysql</span><br><span class="line">gmysql-host=127.0.0.1</span><br><span class="line">gmysql-user=powerdns</span><br><span class="line">gmysql-password=powerdns</span><br><span class="line">gmysql-dbname=powerdns</span><br><span class="line">local-port=5300</span><br><span class="line">max-tcp-connections=200</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动pdns</span></span><br><span class="line">systemctl start pdns</span><br><span class="line">systemctl <span class="built_in">enable</span> pdns</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置pdns-recursor</span></span><br><span class="line">vim /etc/pdns-recursor/recursor.conf</span><br><span class="line">...</span><br><span class="line">allow-from=0.0.0.0/0</span><br><span class="line">daemon=<span class="built_in">yes</span></span><br><span class="line"><span class="comment">## 指定指定域名解析地址</span></span><br><span class="line">forward-zones-file=/etc/pdns-recursor/zone</span><br><span class="line"><span class="comment">## 向上递归dns地址，根域</span></span><br><span class="line">forward-zones-recurse=.=114.114.114.114  </span><br><span class="line">local-address=0.0.0.0</span><br><span class="line">local-port=53</span><br><span class="line"></span><br><span class="line">vim /etc/pdns-recursor/zone</span><br><span class="line"><span class="comment">## 拦截两个域名的解析</span></span><br><span class="line">sysadmin.com=127.0.0.1:5300</span><br><span class="line">ops.com=127.0.0.1:5300</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动pdns-recursor</span></span><br><span class="line">systemctl start pdns-recursor</span><br><span class="line">systemctl <span class="built_in">enable</span> pdns-recursor</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装poweradmin</span></span><br><span class="line">yum install -y httpd php php-mcrypt php-pdo php-mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将php文件解压到/var/www/html下</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动httpd</span></span><br><span class="line">systemctl start httpd</span><br><span class="line">systemctl <span class="built_in">enable</span> httpd</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>访问 <a href="http://ip:port/install">http://ip:port/install</a> 进行相关配置</li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Centos </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
